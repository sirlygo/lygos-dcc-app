<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCC Virtual Tabletop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .dice-result {
            animation: rollIn 0.3s ease-out;
        }
        @keyframes rollIn {
            from {
                transform: scale(0.5) rotate(180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        .tab-active {
            border-bottom: 3px solid #5D5CDE;
            color: #5D5CDE;
        }
        .stat-modifier {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen transition-colors">
    <div class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-2">DCC Virtual Tabletop</h1>
            <p class="text-center text-gray-600 dark:text-gray-400">Dungeon Crawl Classics RPG</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="border-b border-gray-300 dark:border-gray-700 mb-6">
            <ul class="flex flex-wrap -mb-px text-sm md:text-base">
                <li class="mr-2">
                    <button onclick="switchTab('characters')" id="tab-characters" class="tab-active inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Characters</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('dice')" id="tab-dice" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Dice Roller</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('combat')" id="tab-combat" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Combat Tracker</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('tables')" id="tab-tables" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Reference Tables</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('campaigns')" id="tab-campaigns" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Campaigns</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('ai')" id="tab-ai" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">AI Tools</button>
                </li>
            </ul>
        </nav>

        <!-- Tab Content -->
        <div id="content-characters" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Characters</h2>
                <button onclick="showCreateCharacter()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ New Character</button>
            </div>
            <div id="character-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Characters will be added here -->
            </div>
        </div>

        <div id="content-dice" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Dice Roller</h2>
            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 mb-6">
                <div class="grid grid-cols-4 md:grid-cols-7 gap-2 mb-4">
                    <button onclick="rollDice(3)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d3</button>
                    <button onclick="rollDice(4)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d4</button>
                    <button onclick="rollDice(5)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d5</button>
                    <button onclick="rollDice(6)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d6</button>
                    <button onclick="rollDice(7)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d7</button>
                    <button onclick="rollDice(8)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d8</button>
                    <button onclick="rollDice(10)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d10</button>
                    <button onclick="rollDice(12)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d12</button>
                    <button onclick="rollDice(14)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d14</button>
                    <button onclick="rollDice(16)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d16</button>
                    <button onclick="rollDice(20)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d20</button>
                    <button onclick="rollDice(24)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d24</button>
                    <button onclick="rollDice(30)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d30</button>
                    <button onclick="rollDice(100)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d%</button>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Modifier</label>
                    <input type="number" id="dice-modifier" value="0" class="w-full md:w-48 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Number of Dice</label>
                    <input type="number" id="dice-count" value="1" min="1" max="20" class="w-full md:w-48 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Roll Description (optional)</label>
                    <input type="text" id="roll-description" placeholder="e.g., Attack roll, Saving throw" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Roll Results</h3>
                <div id="dice-results" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 dark:text-gray-400 text-center py-8">Roll some dice to see results</p>
                </div>
            </div>
        </div>

        <div id="content-combat" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Combat Tracker</h2>
                <div class="flex gap-2">
                    <button onclick="addCombatant()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ Add Combatant</button>
                    <button onclick="sortInitiative()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-base">Sort Initiative</button>
                    <button onclick="clearCombat()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-base">Clear All</button>
                </div>
            </div>

            <div class="mb-4 bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                <div class="flex items-center gap-4">
                    <div>
                        <label class="font-semibold">Round:</label>
                        <span id="combat-round" class="ml-2 text-xl font-bold text-primary">1</span>
                    </div>
                    <button onclick="nextRound()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Next Round</button>
                </div>
            </div>

            <div id="combat-list" class="space-y-2">
                <!-- Combat entries will be added here -->
            </div>
        </div>

        <div id="content-tables" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Reference Tables</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Critical Hit Table -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Critical Hits (d20)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-16">1-6:</span><span>Normal damage</span></div>
                        <div class="flex"><span class="font-bold w-16">7-11:</span><span>+1d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">12-13:</span><span>+2d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">14-15:</span><span>+3d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">16-17:</span><span>+1d10 damage + bleed 1d6</span></div>
                        <div class="flex"><span class="font-bold w-16">18:</span><span>+2d10 damage + bleed 1d6</span></div>
                        <div class="flex"><span class="font-bold w-16">19:</span><span>+3d10 damage + bleed 2d6</span></div>
                        <div class="flex"><span class="font-bold w-16">20:</span><span>+4d10 damage + limb/organ damage</span></div>
                    </div>
                </div>

                <!-- Fumble Table -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Fumbles (d8)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">1:</span><span>Drop weapon</span></div>
                        <div class="flex"><span class="font-bold w-12">2:</span><span>Slip, lose next action</span></div>
                        <div class="flex"><span class="font-bold w-12">3:</span><span>Twist ankle, -5 ft movement</span></div>
                        <div class="flex"><span class="font-bold w-12">4:</span><span>Stumble, foe gets free attack</span></div>
                        <div class="flex"><span class="font-bold w-12">5:</span><span>Hit ally for normal damage</span></div>
                        <div class="flex"><span class="font-bold w-12">6:</span><span>Weapon stuck, DC 10 STR to free</span></div>
                        <div class="flex"><span class="font-bold w-12">7:</span><span>Armor strap breaks, -1 AC</span></div>
                        <div class="flex"><span class="font-bold w-12">8:</span><span>Weapon damaged, -1 to hit</span></div>
                    </div>
                </div>

                <!-- Ability Score Modifiers -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Ability Score Modifiers</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">3:</span><span>-3</span></div>
                        <div class="flex"><span class="font-bold w-12">4-5:</span><span>-2</span></div>
                        <div class="flex"><span class="font-bold w-12">6-8:</span><span>-1</span></div>
                        <div class="flex"><span class="font-bold w-12">9-12:</span><span>0</span></div>
                        <div class="flex"><span class="font-bold w-12">13-15:</span><span>+1</span></div>
                        <div class="flex"><span class="font-bold w-12">16-17:</span><span>+2</span></div>
                        <div class="flex"><span class="font-bold w-12">18:</span><span>+3</span></div>
                    </div>
                </div>

                <!-- Luck Uses -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Luck Uses</h3>
                    <div class="space-y-2 text-sm">
                        <div>• Add/subtract from any roll (before or after)</div>
                        <div>• Improve critical hit/fumble results</div>
                        <div>• Modify initiative</div>
                        <div>• Find lucky items or gold</div>
                        <div>• Avoid death (at Judge's discretion)</div>
                        <div class="pt-2 italic">Luck spent is permanent unless restored</div>
                    </div>
                </div>

                <!-- Action Dice -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Action Dice by Level</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-20">Level 1-4:</span><span>1d20</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 5:</span><span>1d20 + 1d14</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 6-7:</span><span>1d20 + 1d16</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 8-9:</span><span>1d20 + 1d20</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 10:</span><span>1d20 + 1d20 + 1d14</span></div>
                        <div class="pt-2 italic text-xs">Warriors gain bonus action dice at higher levels</div>
                    </div>
                </div>

                <!-- Spell Corruption -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Spell Corruption (d10)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">1:</span><span>Eyes glow when casting</span></div>
                        <div class="flex"><span class="font-bold w-12">2:</span><span>Hair turns white/silver</span></div>
                        <div class="flex"><span class="font-bold w-12">3:</span><span>Skin becomes pale/ashen</span></div>
                        <div class="flex"><span class="font-bold w-12">4:</span><span>Fingernails turn black</span></div>
                        <div class="flex"><span class="font-bold w-12">5:</span><span>Voice becomes raspy</span></div>
                        <div class="flex"><span class="font-bold w-12">6:</span><span>Minor temperature change around caster</span></div>
                        <div class="flex"><span class="font-bold w-12">7:</span><span>Smell of brimstone/ozone</span></div>
                        <div class="flex"><span class="font-bold w-12">8:</span><span>Small horns sprout</span></div>
                        <div class="flex"><span class="font-bold w-12">9:</span><span>Shadow moves independently</span></div>
                        <div class="flex"><span class="font-bold w-12">10:</span><span>Magical runes appear on skin</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-campaigns" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Campaigns</h2>
                <button onclick="showCreateCampaign()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ New Campaign</button>
            </div>
            <div id="campaign-list" class="grid grid-cols-1 gap-4">
                <!-- Campaigns will be added here -->
            </div>
        </div>

        <div id="content-ai" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold">AI Tools</h2>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Jump-start your next session with built-in creative generators for adventures, NPCs, and wondrous rewards.</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5 shadow-sm border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold">Adventure Hook Generator</h3>
                        <span class="text-xs uppercase tracking-wider text-primary font-semibold">AI Assisted</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Add an optional theme to nudge the generator, then conjure a ready-to-run hook complete with twists and rewards.</p>
                    <div class="flex flex-col md:flex-row gap-3 mb-4">
                        <input id="ai-theme-input" type="text" placeholder="Optional theme or keyword" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                        <button onclick="handleAdventureHookGenerate()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Generate Hook</button>
                    </div>
                    <div id="ai-adventure-output" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-4 text-sm space-y-2 min-h-[140px]">
                        <p class="text-gray-500 dark:text-gray-400">Provide a theme or click generate to craft an adventure hook.</p>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5 shadow-sm border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold">NPC Forge</h3>
                        <span class="text-xs uppercase tracking-wider text-primary font-semibold">AI Inspired</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Instantly spin up colorful allies, rivals, or mysterious patrons with personality hooks and hidden agendas.</p>
                    <button onclick="generateNPCIdea()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base mb-4">Generate NPC</button>
                    <div id="ai-npc-output" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-4 text-sm space-y-2 min-h-[140px]">
                        <p class="text-gray-500 dark:text-gray-400">Tap the button to meet your next unforgettable NPC.</p>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5 shadow-sm border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold">Treasure Crafter</h3>
                        <span class="text-xs uppercase tracking-wider text-primary font-semibold">AI Inspired</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Design remarkable magical items to reward daring heroes or tempt reckless gamblers.</p>
                    <button onclick="generateMagicItemIdea()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base mb-4">Generate Relic</button>
                    <div id="ai-item-output" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-4 text-sm space-y-2 min-h-[140px]">
                        <p class="text-gray-500 dark:text-gray-400">Forge a relic that feels right at home in the dying earth of DCC.</p>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5 shadow-sm border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold">Rumor Mill</h3>
                        <span class="text-xs uppercase tracking-wider text-primary font-semibold">AI Inspired</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Seed your world with tantalizing rumors, dire omens, or half-truths to spark player investigation.</p>
                    <button onclick="generateRumor()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base mb-4">Whisper a Rumor</button>
                    <div id="ai-rumor-output" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-4 text-sm space-y-2 min-h-[140px]">
                        <p class="text-gray-500 dark:text-gray-400">Let the rumor mill spin to find the next breadcrumb for your players.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div id="create-campaign-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Create Campaign</h3>
                <form id="campaign-form" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Campaign Name</label>
                        <input type="text" id="campaign-name" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Campaign Description</label>
                        <textarea id="campaign-description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="hideCreateCampaign()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-base">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-base">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Campaign Detail Modal -->
    <div id="campaign-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-campaign-name"></h3>
                    <button onclick="hideCampaignDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="campaign-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Adventure Detail Modal -->
    <div id="adventure-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-adventure-name"></h3>
                    <button onclick="hideAdventureDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="adventure-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div id="create-character-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Create Character</h3>
                <form id="character-form" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Name</label>
                        <input type="text" id="char-name" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">Level</label>
                            <input type="number" id="char-level" value="0" min="0" max="10" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Class</label>
                            <select id="char-class" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                                <option value="Peasant">0-Level (Peasant)</option>
                                <option value="Warrior">Warrior</option>
                                <option value="Wizard">Wizard</option>
                                <option value="Cleric">Cleric</option>
                                <option value="Thief">Thief</option>
                                <option value="Dwarf">Dwarf</option>
                                <option value="Elf">Elf</option>
                                <option value="Halfling">Halfling</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">STR</label>
                            <input type="number" id="char-str" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">AGI</label>
                            <input type="number" id="char-agi" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">STA</label>
                            <input type="number" id="char-sta" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">PER</label>
                            <input type="number" id="char-per" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">INT</label>
                            <input type="number" id="char-int" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">LUC</label>
                            <input type="number" id="char-luc" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">HP (Max)</label>
                            <input type="number" id="char-hp-max" value="4" min="1" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Current HP</label>
                            <input type="number" id="char-hp-current" value="4" min="0" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">AC</label>
                            <input type="number" id="char-ac" value="10" min="1" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Speed</label>
                            <input type="number" id="char-speed" value="30" min="0" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block mb-2 font-semibold">Equipment/Notes</label>
                        <textarea id="char-equipment" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base"></textarea>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="hideCreateCharacter()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-base">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-base">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Character Detail Modal -->
    <div id="character-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-char-name"></h3>
                    <button onclick="hideCharacterDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="character-detail-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data storage (persisted to localStorage when available)
        const STORAGE_KEY = 'dcc_vtt_state_v2';
        let characters = [];
        let combatants = [];
        let combatRound = 1;
        let rollHistory = [];
        let campaigns = [];

        function persistState() {
            if (typeof localStorage === 'undefined') return;
            try {
                const payload = {
                    characters,
                    combatants,
                    combatRound,
                    rollHistory,
                    campaigns
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
            } catch (err) {
                console.warn('Unable to persist state', err);
            }
        }

        function loadState() {
            if (typeof localStorage === 'undefined') return;
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const saved = JSON.parse(raw);
                characters = Array.isArray(saved.characters) ? saved.characters.slice().sort((a, b) => a.name.localeCompare(b.name, undefined, {sensitivity: 'base'})) : characters;
                combatants = Array.isArray(saved.combatants) ? saved.combatants : combatants;
                combatRound = Number.isFinite(saved.combatRound) ? saved.combatRound : combatRound;
                rollHistory = Array.isArray(saved.rollHistory) ? saved.rollHistory : rollHistory;
                campaigns = Array.isArray(saved.campaigns) ? saved.campaigns.map(c => ({
                    ...c,
                    adventures: Array.isArray(c.adventures) ? c.adventures : []
                })).sort((a, b) => a.name.localeCompare(b.name, undefined, {sensitivity: 'base'})) : campaigns;
            } catch (err) {
                console.warn('Unable to load saved state', err);
            }
        }

        loadState();

        // Tab switching
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('tab-active'));

            // Show selected tab
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('tab-active');
        }

        const aiTables = {
            tones: ['sword-and-sorcery grit', 'occult horror', 'gonzo science fantasy', 'grim folklore', 'mythic western', 'eldritch seafaring'],
            locations: ['sunken cathedral beneath the slums', 'crystalline swamp that sings at dusk', 'abandoned wizard observatory orbiting a shard of chaos', 'fungal necropolis hidden in the roots of a world-tree', 'mirror-walled labyrinth deep below the city well', 'storm-lashed monastery clinging to a cliff of black glass'],
            antagonists: ['cult of the moon-burned prophet', 'sorcerous war machine seeking sentience', 'ancient godling wearing a mortal host', 'order of oathbreakers who hunt the luckless', 'witch-market run by time lost nobles', 'coalition of desperate peasants possessed by a single demon'],
            motivations: ['awaken a sleeping titan', 'erase the last name of a saint from history', 'steal the future of an entire village', 'splice mortal souls into an arcane engine', 'seal away every source of hope', 'ignite a planar beacon to draw hungry outsiders'],
            complications: ['The location drifts between planes each midnight.', 'A rival faction is already meddling here.', 'Every success taxes the heroes with creeping corruption.', 'An innocent companion harbors the key to the mystery.', 'A storm of wild magic rewrites reality in pulses.', 'The antagonist and heroes share a linked fate.'],
            rewards: ['a relic weapon that levels up with the bearer’s deeds', 'forbidden rites capable of reversing a single death', 'the allegiance of a grateful demi-god', 'maps to a vault of prehuman treasures', 'a luckstone infused with chaotic boons', 'the final verse of a world-ending prophecy'],
            adventureAdjectives: ['Shattered', 'Lurid', 'Bleeding', 'Haunted', 'Star-Forsaken', 'Eldritch'],
            adventureSubjects: ['Spire', 'Reckoning', 'Pilgrimage', 'Labyrinth', 'Conclave', 'Reliquary'],
            questGivers: ['panicked village elder', 'luckless gongfarmer who survived the impossible', 'mysterious patron veiled in patchwork silk', 'wounded ranger bearing a cursed map', 'wandering judge sworn to Law', 'drunken seer who dreams in reverse'],
            npcRoles: ['battle-scarred mercenary captain', 'itinerant judge of dubious morality', 'arcane antiquarian obsessed with relics', 'runaway noble scion seeking anonymity', 'half-trained wizard apprentice with volatile talent', 'zealous cultist pretending to reform'],
            npcTraits: ['smells faintly of ozone', 'speaks in prophetic riddles', 'collects broken blades and knows their stories', 'laughs in the face of danger', 'keeps an invisible friend they consult constantly', 'wears armor etched with constellations that shift nightly'],
            npcGoals: ['pay a debt owed to something beneath the earth', 'prove that luck is a tangible resource', 'recover a sibling lost beyond time', 'expose the corruption of a rival order', 'witness the rise of a foretold champion', 'master an outlawed spell before the next eclipse'],
            npcSecrets: ['is haunted by a ghost that occasionally takes control', 'secretly served the current villain for years', 'carries a cursed sigil that attracts monsters', 'is royalty in disguise and fears being discovered', 'has prophetic dreams about one of the heroes', 'their shadow is missing and bargaining for freedom'],
            itemForms: ['blade', 'idol', 'mask', 'instrument', 'cloak', 'orb'],
            itemMaterials: ['meteoric bronze', 'screaming glass', 'wyrm-bone', 'star-iron', 'etched obsidian', 'living wood'],
            itemPowers: ['drinks spells cast nearby to fuel its bearer', 'splits the wielder into mirrored duplicates for a heartbeat', 'binds a chosen foe with chains of forgotten names', 'reveals invisible paths between worlds', 'stores sunlight to unleash as searing radiance', 'allows the bearer to bargain with ghosts as equals'],
            itemQuirks: ['whispers insults at dawn', 'demands to taste blood before drawing power', 'grows heavier in the presence of lies', 'radiates an aura of nostalgic music', 'records every oath spoken nearby', 'attracts fickle patrons from the outer dark'],
            rumorSources: ['a terrified shepherd', 'an ambitious street urchin', 'a delirious cult survivor', 'a bard who swears they never lie', 'a pair of arguing familiars', 'a traveling bone reader'],
            rumorTopics: ['a door that appears only during eclipses', 'a beast made of luckless gamblers', 'treasure buried beneath the old gallows', 'a comet that grants spells to those who drink its light', 'a singing sword demanding a new champion', 'a plague of dreams devouring the town'],
            rumorTwists: ['is only half true but still dangerous', 'is bait laid by desperate villains', 'points to something far stranger than advertised', 'conceals a tragic misunderstanding', 'is a fragment of a prophecy coming to fruition', 'was planted by an ally testing the heroes'],
            rumorUrgency: ['before the next moonrise', 'once the bells toll thirteen', 'while the mists still cling to the fields', 'ahead of the king’s procession tomorrow', 'before the sacred river runs black', 'when the third crow caws at midnight']
        };

        function getRandomItem(list) {
            return list[Math.floor(Math.random() * list.length)];
        }

        function buildAdventureHook(theme = '') {
            const tone = theme || getRandomItem(aiTables.tones);
            const location = getRandomItem(aiTables.locations);
            const antagonist = getRandomItem(aiTables.antagonists);
            const motivation = getRandomItem(aiTables.motivations);
            const complication = getRandomItem(aiTables.complications);
            const reward = getRandomItem(aiTables.rewards);
            const title = `The ${getRandomItem(aiTables.adventureAdjectives)} ${getRandomItem(aiTables.adventureSubjects)}`;
            const questGiver = getRandomItem(aiTables.questGivers);

            return {
                title,
                tone,
                location,
                antagonist,
                motivation,
                complication,
                reward,
                questGiver,
                summary: `Within the ${location}, the ${antagonist} seeks to ${motivation}.`
            };
        }

        function handleAdventureHookGenerate() {
            const themeInput = document.getElementById('ai-theme-input');
            const theme = themeInput ? themeInput.value.trim() : '';
            const hook = buildAdventureHook(theme);
            const container = document.getElementById('ai-adventure-output');
            if (!container) return;

            const safeTone = escapeHTML(hook.tone);
            const safeTheme = theme ? escapeHTML(theme) : '';

            container.innerHTML = `
                <div>
                    <div class="font-semibold text-lg mb-1">${escapeHTML(hook.title)}</div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Tone: ${safeTone}${safeTheme ? ' (guided by "' + safeTheme + '")' : ''}</p>
                    <p class="text-sm mb-2">${escapeHTML(hook.summary)}</p>
                    <ul class="list-disc pl-5 space-y-1 text-sm">
                        <li><span class="font-semibold">Quest Giver:</span> ${escapeHTML(hook.questGiver)}</li>
                        <li><span class="font-semibold">Primary Threat:</span> ${escapeHTML(hook.antagonist)}</li>
                        <li><span class="font-semibold">Complication:</span> ${escapeHTML(hook.complication)}</li>
                        <li><span class="font-semibold">Promised Reward:</span> ${escapeHTML(hook.reward)}</li>
                    </ul>
                </div>
            `;
        }

        function generateNPCIdea() {
            const container = document.getElementById('ai-npc-output');
            if (!container) return;

            const role = getRandomItem(aiTables.npcRoles);
            const trait = getRandomItem(aiTables.npcTraits);
            const goal = getRandomItem(aiTables.npcGoals);
            const secret = getRandomItem(aiTables.npcSecrets);

            container.innerHTML = `
                <div class="space-y-2">
                    <div class="font-semibold text-lg">${escapeHTML(role)}</div>
                    <p class="text-sm">${escapeHTML(trait.charAt(0).toUpperCase() + trait.slice(1))}.</p>
                    <p class="text-sm"><span class="font-semibold">Motivation:</span> ${escapeHTML(goal)}.</p>
                    <p class="text-sm"><span class="font-semibold">Secret:</span> ${escapeHTML(secret)}.</p>
                </div>
            `;
        }

        function generateMagicItemIdea() {
            const container = document.getElementById('ai-item-output');
            if (!container) return;

            const form = getRandomItem(aiTables.itemForms);
            const material = getRandomItem(aiTables.itemMaterials);
            const power = getRandomItem(aiTables.itemPowers);
            const quirk = getRandomItem(aiTables.itemQuirks);
            const name = `The ${getRandomItem(aiTables.adventureAdjectives)} ${form.charAt(0).toUpperCase() + form.slice(1)}`;

            container.innerHTML = `
                <div class="space-y-2">
                    <div class="font-semibold text-lg">${escapeHTML(name)}</div>
                    <p class="text-sm"><span class="font-semibold">Forged From:</span> ${escapeHTML(material)}.</p>
                    <p class="text-sm"><span class="font-semibold">Power:</span> ${escapeHTML(power)}.</p>
                    <p class="text-sm"><span class="font-semibold">Quirk:</span> ${escapeHTML(quirk)}.</p>
                </div>
            `;
        }

        function generateRumor() {
            const container = document.getElementById('ai-rumor-output');
            if (!container) return;

            const source = getRandomItem(aiTables.rumorSources);
            const topic = getRandomItem(aiTables.rumorTopics);
            const twist = getRandomItem(aiTables.rumorTwists);
            const urgency = getRandomItem(aiTables.rumorUrgency);

            container.innerHTML = `
                <div class="space-y-2">
                    <p class="text-sm"><span class="font-semibold">Source:</span> ${escapeHTML(source)}.</p>
                    <p class="text-sm"><span class="font-semibold">Whispers:</span> ${escapeHTML(topic)}.</p>
                    <p class="text-sm"><span class="font-semibold">Twist:</span> The rumor ${escapeHTML(twist)}.</p>
                    <p class="text-sm"><span class="font-semibold">Act:</span> Investigate ${escapeHTML(urgency)}.</p>
                </div>
            `;
        }

        function updateCombatRoundDisplay() {
            const el = document.getElementById('combat-round');
            if (el) {
                el.textContent = combatRound;
            }
        }

        function escapeHTML(value) {
            const div = document.createElement('div');
            div.textContent = value ?? '';
            return div.innerHTML;
        }

        function renderRichText(value) {
            return escapeHTML(value).replace(/\n/g, '<br>');
        }

        // Calculate ability modifier
        function getModifier(score) {
            if (score <= 3) return -3;
            if (score <= 5) return -2;
            if (score <= 8) return -1;
            if (score <= 12) return 0;
            if (score <= 15) return 1;
            if (score <= 17) return 2;
            return 3;
        }

        // Character Management
        function showCreateCharacter() {
            document.getElementById('create-character-modal').classList.remove('hidden');
            document.getElementById('create-character-modal').classList.add('flex');
        }

        function hideCreateCharacter() {
            document.getElementById('create-character-modal').classList.add('hidden');
            document.getElementById('create-character-modal').classList.remove('flex');
            document.getElementById('character-form').reset();
        }

        document.getElementById('character-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const character = {
                id: Date.now(),
                name: document.getElementById('char-name').value,
                level: parseInt(document.getElementById('char-level').value),
                class: document.getElementById('char-class').value,
                str: parseInt(document.getElementById('char-str').value),
                agi: parseInt(document.getElementById('char-agi').value),
                sta: parseInt(document.getElementById('char-sta').value),
                per: parseInt(document.getElementById('char-per').value),
                int: parseInt(document.getElementById('char-int').value),
                luc: parseInt(document.getElementById('char-luc').value),
                hpMax: parseInt(document.getElementById('char-hp-max').value),
                hpCurrent: parseInt(document.getElementById('char-hp-current').value),
                ac: parseInt(document.getElementById('char-ac').value),
                speed: parseInt(document.getElementById('char-speed').value),
                equipment: document.getElementById('char-equipment').value
            };

            characters.push(character);
            characters.sort((a, b) => a.name.localeCompare(b.name, undefined, {sensitivity: 'base'}));
            persistState();
            renderCharacters();
            hideCreateCharacter();
        });

        function renderCharacters() {
            const container = document.getElementById('character-list');

            if (characters.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-full">No characters yet. Create one to get started!</p>';
                return;
            }

            container.innerHTML = characters.map(char => `
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 hover:shadow-lg transition cursor-pointer" onclick="showCharacterDetail(${char.id})">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-xl font-bold">${escapeHTML(char.name)}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Level ${char.level} ${escapeHTML(char.class)}</p>
                        </div>
                        <button onclick="event.stopPropagation(); deleteCharacter(${char.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-sm mb-2">
                        <div>
                            <span class="font-semibold">HP:</span> ${char.hpCurrent}/${char.hpMax}
                        </div>
                        <div>
                            <span class="font-semibold">AC:</span> ${char.ac}
                        </div>
                        <div>
                            <span class="font-semibold">Speed:</span> ${char.speed}ft
                        </div>
                    </div>
                    <div class="grid grid-cols-6 gap-1 text-xs">
                        <div class="text-center">
                            <div class="font-semibold">STR</div>
                            <div>${char.str} <span class="stat-modifier">(${getModifier(char.str) >= 0 ? '+' : ''}${getModifier(char.str)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">AGI</div>
                            <div>${char.agi} <span class="stat-modifier">(${getModifier(char.agi) >= 0 ? '+' : ''}${getModifier(char.agi)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">STA</div>
                            <div>${char.sta} <span class="stat-modifier">(${getModifier(char.sta) >= 0 ? '+' : ''}${getModifier(char.sta)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">PER</div>
                            <div>${char.per} <span class="stat-modifier">(${getModifier(char.per) >= 0 ? '+' : ''}${getModifier(char.per)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">INT</div>
                            <div>${char.int} <span class="stat-modifier">(${getModifier(char.int) >= 0 ? '+' : ''}${getModifier(char.int)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">LUC</div>
                            <div>${char.luc} <span class="stat-modifier">(${getModifier(char.luc) >= 0 ? '+' : ''}${getModifier(char.luc)})</span></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCharacterDetail(id) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            document.getElementById('detail-char-name').textContent = char.name;

            const content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-semibold">Level:</span> ${char.level}</div>
                        <div><span class="font-semibold">Class:</span> ${escapeHTML(char.class)}</div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">HP</div>
                            <div class="text-2xl font-bold">${char.hpCurrent}/${char.hpMax}</div>
                            <div class="mt-2 flex gap-2">
                                <button onclick="adjustHP(${char.id}, -1)" class="flex-1 bg-red-500 text-white px-2 py-1 rounded text-sm">-</button>
                                <button onclick="adjustHP(${char.id}, 1)" class="flex-1 bg-green-500 text-white px-2 py-1 rounded text-sm">+</button>
                            </div>
                        </div>
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">AC</div>
                            <div class="text-2xl font-bold">${char.ac}</div>
                        </div>
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">Speed</div>
                            <div class="text-2xl font-bold">${char.speed}ft</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold mb-2">Ability Scores</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">STR</div>
                                <div class="text-xl">${char.str}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.str) >= 0 ? '+' : ''}${getModifier(char.str)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">AGI</div>
                                <div class="text-xl">${char.agi}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.agi) >= 0 ? '+' : ''}${getModifier(char.agi)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">STA</div>
                                <div class="text-xl">${char.sta}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.sta) >= 0 ? '+' : ''}${getModifier(char.sta)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">PER</div>
                                <div class="text-xl">${char.per}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.per) >= 0 ? '+' : ''}${getModifier(char.per)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">INT</div>
                                <div class="text-xl">${char.int}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.int) >= 0 ? '+' : ''}${getModifier(char.int)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">LUC</div>
                                <div class="text-xl">${char.luc}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.luc) >= 0 ? '+' : ''}${getModifier(char.luc)}</div>
                            </div>
                        </div>
                    </div>

                    ${char.equipment ? `
                    <div>
                        <h4 class="font-bold mb-2">Equipment & Notes</h4>
                        <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded whitespace-pre-wrap">${renderRichText(char.equipment)}</div>
                    </div>
                    ` : ''}

                    <div class="flex gap-2">
                        <button onclick="addCharacterToCombat(${char.id})" class="flex-1 bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Add to Combat</button>
                        <button onclick="deleteCharacter(${char.id})" class="flex-1 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-base">Delete</button>
                    </div>
                </div>
            `;

            document.getElementById('character-detail-content').innerHTML = content;
            document.getElementById('character-detail-modal').classList.remove('hidden');
            document.getElementById('character-detail-modal').classList.add('flex');
        }

        function hideCharacterDetail() {
            document.getElementById('character-detail-modal').classList.add('hidden');
            document.getElementById('character-detail-modal').classList.remove('flex');
        }

        function adjustHP(id, amount) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            char.hpCurrent = Math.max(0, Math.min(char.hpMax, char.hpCurrent + amount));
            persistState();
            renderCharacters();
            showCharacterDetail(id);
        }

        function deleteCharacter(id) {
            showCustomConfirm('Are you sure you want to delete this character?', () => {
                characters = characters.filter(c => c.id !== id);
                persistState();
                renderCharacters();
                hideCharacterDetail();
            });
        }

        // Dice Roller
        function rollDice(sides) {
            const count = parseInt(document.getElementById('dice-count').value) || 1;
            const modifier = parseInt(document.getElementById('dice-modifier').value) || 0;
            const description = document.getElementById('roll-description').value;

            const rolls = [];
            let total = modifier;

            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }

            const result = {
                sides,
                count,
                rolls,
                modifier,
                total,
                description,
                timestamp: new Date().toLocaleTimeString()
            };

            rollHistory.unshift(result);
            if (rollHistory.length > 20) rollHistory.pop();

            persistState();
            displayRollResults();
        }

        function displayRollResults() {
            const container = document.getElementById('dice-results');

            if (rollHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Roll some dice to see results</p>';
                return;
            }

            container.innerHTML = rollHistory.map(r => `
                <div class="dice-result bg-white dark:bg-gray-800 p-4 rounded-lg border-l-4 border-primary">
                    ${r.description ? `<div class="font-semibold mb-1">${escapeHTML(r.description)}</div>` : ''}
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            ${r.count}d${r.sides}${r.modifier !== 0 ? (r.modifier > 0 ? '+' : '') + r.modifier : ''}
                            <span class="ml-2">[${r.rolls.join(', ')}]</span>
                        </div>
                        <div class="text-2xl font-bold text-primary">${r.total}</div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">${r.timestamp}</div>
                </div>
            `).join('');
        }

        // Combat Tracker
        async function addCombatant() {
            const name = await showCustomPrompt('Enter combatant name:');
            if (!name) return;

            const initiativeInput = await showCustomPrompt('Enter initiative (or leave blank to roll):');
            const init = initiativeInput ? parseInt(initiativeInput, 10) : Math.floor(Math.random() * 20) + 1;

            const hpInput = await showCustomPrompt('Enter HP:', '10');
            if (hpInput === null) return;
            const acInput = await showCustomPrompt('Enter AC:', '10');
            if (acInput === null) return;

            const hp = parseInt(hpInput, 10);
            const ac = parseInt(acInput, 10);

            combatants.push({
                id: Date.now(),
                name,
                initiative: Number.isFinite(init) ? init : Math.floor(Math.random() * 20) + 1,
                hp: Number.isFinite(hp) ? hp : 10,
                hpMax: Number.isFinite(hp) ? hp : 10,
                ac: Number.isFinite(ac) ? ac : 10,
                isActive: false
            });

            persistState();
            renderCombat();
        }

        function addCharacterToCombat(charId) {
            const char = characters.find(c => c.id === charId);
            if (!char) return;

            const initiative = Math.floor(Math.random() * 20) + 1 + getModifier(char.agi);

            combatants.push({
                id: Date.now(),
                name: char.name,
                initiative,
                hp: char.hpCurrent,
                hpMax: char.hpMax,
                ac: char.ac,
                isActive: false,
                characterId: charId
            });

            persistState();
            renderCombat();
            hideCharacterDetail();
        }

        function sortInitiative() {
            combatants.sort((a, b) => b.initiative - a.initiative);
            if (combatants.length > 0) {
                combatants.forEach(c => c.isActive = false);
                combatants[0].isActive = true;
            }
            persistState();
            renderCombat();
        }

        function renderCombat() {
            updateCombatRoundDisplay();
            const container = document.getElementById('combat-list');

            if (combatants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No combatants. Add characters or NPCs to begin combat.</p>';
                return;
            }

            container.innerHTML = combatants.map((c, index) => `
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg ${c.isActive ? 'ring-2 ring-primary' : ''}">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                ${c.isActive ? '<span class="text-primary text-2xl">▶</span>' : '<span class="text-2xl opacity-0">▶</span>'}
                                <div class="flex-1">
                                    <div class="font-bold text-lg">${c.name}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Initiative: ${c.initiative} | AC: ${c.ac}</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-600 dark:text-gray-400">HP</div>
                                <div class="font-bold ${c.hp <= 0 ? 'text-red-500' : ''}">${c.hp}/${c.hpMax}</div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="adjustCombatantHP(${c.id}, -1)" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-base">-</button>
                                <button onclick="adjustCombatantHP(${c.id}, 1)" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-base">+</button>
                            </div>
                            <button onclick="removeCombatant(${c.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function adjustCombatantHP(id, amount) {
            const combatant = combatants.find(c => c.id === id);
            if (!combatant) return;

            combatant.hp = Math.max(0, Math.min(combatant.hpMax, combatant.hp + amount));

            // Update character if linked
            if (combatant.characterId) {
                const char = characters.find(c => c.id === combatant.characterId);
                if (char) {
                    char.hpCurrent = combatant.hp;
                    renderCharacters();
                }
            }

            persistState();
            renderCombat();
        }

        function removeCombatant(id) {
            combatants = combatants.filter(c => c.id !== id);
            persistState();
            renderCombat();
        }

        function clearCombat() {
            showCustomConfirm('Clear all combatants?', () => {
                combatants = [];
                combatRound = 1;
                persistState();
                updateCombatRoundDisplay();
                renderCombat();
            });
        }

        function nextRound() {
            combatRound++;
            persistState();
            updateCombatRoundDisplay();

            if (combatants.length > 0) {
                const currentIndex = combatants.findIndex(c => c.isActive);
                combatants.forEach(c => c.isActive = false);

                if (currentIndex < combatants.length - 1) {
                    combatants[currentIndex + 1].isActive = true;
                } else {
                    combatants[0].isActive = true;
                }

                persistState();
                renderCombat();
            }
        }

        // Campaign Manager
        function showCreateCampaign() {
            const modal = document.getElementById('create-campaign-modal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideCreateCampaign() {
            const modal = document.getElementById('create-campaign-modal');
            if (!modal) return;
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            const form = document.getElementById('campaign-form');
            if (form) form.reset();
        }

        function hideCampaignDetail() {
            const modal = document.getElementById('campaign-detail-modal');
            if (!modal) return;
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            hideAdventureDetail();
        }

        function hideAdventureDetail() {
            const modal = document.getElementById('adventure-detail-modal');
            if (!modal) return;
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function renderCampaigns() {
            const container = document.getElementById('campaign-list');
            if (!container) return;

            if (campaigns.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No campaigns yet. Create one to track your adventures.</p>';
                return;
            }

            container.innerHTML = campaigns.map(campaign => {
                const adventureCount = Array.isArray(campaign.adventures) ? campaign.adventures.length : 0;
                const adventureLabel = adventureCount === 1 ? 'Adventure' : 'Adventures';
                const normalizedDescription = (campaign.description || '').replace(/\s+/g, ' ').trim();
                const descriptionSnippet = normalizedDescription ? normalizedDescription.slice(0, 160) : '';
                const truncated = descriptionSnippet ? `${escapeHTML(descriptionSnippet)}${normalizedDescription.length > 160 ? '…' : ''}` : '';
                return `
                    <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 shadow-sm border border-gray-200 dark:border-gray-800">
                        <div class="flex flex-col gap-3">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <h3 class="text-xl font-bold">${escapeHTML(campaign.name)}</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${adventureCount} ${adventureLabel}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="showCampaignDetail(${campaign.id})" class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 text-sm">View</button>
                                    <button onclick="deleteCampaign(${campaign.id})" class="px-3 py-1 text-red-500 hover:text-red-600 text-sm">Delete</button>
                                </div>
                            </div>
                            ${truncated ? `<p class=\"text-sm text-gray-600 dark:text-gray-400\">${truncated}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCampaignDetail(id) {
            const campaign = campaigns.find(c => c.id === id);
            if (!campaign) return;

            const modal = document.getElementById('campaign-detail-modal');
            const title = document.getElementById('detail-campaign-name');
            const content = document.getElementById('campaign-detail-content');
            if (!modal || !title || !content) return;

            title.textContent = campaign.name;

            const adventureList = (campaign.adventures || []).length > 0
                ? campaign.adventures.map(adventure => `
                    <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <div class="font-semibold text-lg">${escapeHTML(adventure.name)}</div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${adventure.summary ? escapeHTML(adventure.summary.replace(/\s+/g, ' ').trim().slice(0, 140)) + (adventure.summary.replace(/\s+/g, ' ').trim().length > 140 ? '…' : '') : 'No summary yet.'}</p>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="showAdventureDetail(${campaign.id}, ${adventure.id})" class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 text-sm">Details</button>
                                <button onclick="deleteAdventure(${campaign.id}, ${adventure.id})" class="px-3 py-1 text-red-500 hover:text-red-600 text-sm">Delete</button>
                            </div>
                        </div>
                        ${adventure.generated ? '<span class="inline-block mt-3 text-xs uppercase tracking-wide text-primary font-semibold">AI Generated</span>' : ''}
                    </div>
                `).join('')
                : '<p class="text-gray-500 dark:text-gray-400">No adventures logged yet. Use the buttons below to add one.</p>';

            const created = campaign.createdAt ? new Date(campaign.createdAt).toLocaleDateString() : '';

            content.innerHTML = `
                <div class="space-y-6">
                    ${campaign.description ? `<div><h4 class="font-bold mb-2">Campaign Notes</h4><div class="bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded p-4 text-sm leading-relaxed">${renderRichText(campaign.description)}</div></div>` : ''}
                    ${created ? `<div class="text-sm text-gray-500">Created ${created}</div>` : ''}
                    <div class="flex flex-wrap gap-2">
                        <button onclick="promptAddAdventure(${campaign.id})" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 text-sm">Add Adventure</button>
                        <button onclick="generateAIAdventure(${campaign.id})" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 text-sm">AI Adventure</button>
                        <button onclick="deleteCampaign(${campaign.id})" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Delete Campaign</button>
                    </div>
                    <div class="space-y-4">${adventureList}</div>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        const campaignForm = document.getElementById('campaign-form');
        if (campaignForm) {
            campaignForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const name = document.getElementById('campaign-name').value.trim() || 'Untitled Campaign';
                const description = document.getElementById('campaign-description').value.trim();

                const campaign = {
                    id: Date.now(),
                    name,
                    description,
                    createdAt: new Date().toISOString(),
                    adventures: []
                };

                campaigns.push(campaign);
                campaigns.sort((a, b) => a.name.localeCompare(b.name, undefined, {sensitivity: 'base'}));
                persistState();
                renderCampaigns();
                hideCreateCampaign();
                showCampaignDetail(campaign.id);
            });
        }

        function deleteCampaign(id) {
            showCustomConfirm('Delete this campaign and all of its adventures?', () => {
                campaigns = campaigns.filter(c => c.id !== id);
                persistState();
                renderCampaigns();
                hideCampaignDetail();
                hideAdventureDetail();
            });
        }

        async function promptAddAdventure(campaignId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            const name = await showCustomPrompt('Adventure name:');
            if (!name) return;

            const summary = await showCustomPrompt('Brief synopsis:', 'A perilous expedition with unexpected twists.');
            if (summary === null) return;

            const complication = await showCustomPrompt('Signature complication or twist (optional):', '');

            const adventure = {
                id: Date.now(),
                name,
                summary,
                complication: complication || '',
                generated: false,
                createdAt: new Date().toISOString()
            };

            campaign.adventures = Array.isArray(campaign.adventures) ? campaign.adventures : [];
            campaign.adventures.push(adventure);
            persistState();
            renderCampaigns();
            showCampaignDetail(campaignId);
        }

        function generateAIAdventure(campaignId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            const theme = (campaign.description && campaign.description.split('\n')[0]) || campaign.name;
            const hook = buildAdventureHook(theme);
            const adventure = {
                id: Date.now(),
                name: hook.title,
                summary: hook.summary,
                questGiver: hook.questGiver,
                antagonist: hook.antagonist,
                complication: hook.complication,
                reward: hook.reward,
                tone: hook.tone,
                generated: true,
                createdAt: new Date().toISOString()
            };

            campaign.adventures = Array.isArray(campaign.adventures) ? campaign.adventures : [];
            campaign.adventures.push(adventure);
            persistState();
            renderCampaigns();
            showCampaignDetail(campaignId);
            showAdventureDetail(campaignId, adventure.id);
        }

        function showAdventureDetail(campaignId, adventureId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            const adventure = (campaign.adventures || []).find(a => a.id === adventureId);
            if (!adventure) return;

            const modal = document.getElementById('adventure-detail-modal');
            const title = document.getElementById('detail-adventure-name');
            const content = document.getElementById('adventure-detail-content');
            if (!modal || !title || !content) return;

            title.textContent = adventure.name;

            const detailSections = [
                adventure.summary ? `<div><h4 class="font-semibold mb-1">Synopsis</h4><p class="text-sm leading-relaxed">${renderRichText(adventure.summary)}</p></div>` : '',
                adventure.questGiver ? `<div><h4 class="font-semibold mb-1">Quest Giver</h4><p class="text-sm">${escapeHTML(adventure.questGiver)}</p></div>` : '',
                adventure.antagonist ? `<div><h4 class="font-semibold mb-1">Primary Threat</h4><p class="text-sm">${escapeHTML(adventure.antagonist)}</p></div>` : '',
                adventure.complication ? `<div><h4 class="font-semibold mb-1">Complication</h4><p class="text-sm">${escapeHTML(adventure.complication)}</p></div>` : '',
                adventure.reward ? `<div><h4 class="font-semibold mb-1">Reward</h4><p class="text-sm">${escapeHTML(adventure.reward)}</p></div>` : '',
                adventure.tone ? `<div><h4 class="font-semibold mb-1">Tone</h4><p class="text-sm">${escapeHTML(adventure.tone)}</p></div>` : ''
            ].filter(Boolean).join('');

            const created = adventure.createdAt ? new Date(adventure.createdAt).toLocaleString() : '';

            content.innerHTML = `
                <div class="space-y-4">
                    ${adventure.generated ? '<span class="inline-block text-xs uppercase tracking-wide text-primary font-semibold">Generated via AI Tools</span>' : ''}
                    ${detailSections || '<p class="text-gray-500 dark:text-gray-400 text-sm">This adventure does not have any details yet.</p>'}
                    ${created ? `<div class="text-xs text-gray-500">Logged ${created}</div>` : ''}
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function deleteAdventure(campaignId, adventureId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            showCustomConfirm('Remove this adventure from the campaign?', () => {
                campaign.adventures = (campaign.adventures || []).filter(a => a.id !== adventureId);
                persistState();
                renderCampaigns();
                showCampaignDetail(campaignId);
                hideAdventureDetail();
            });
        }

        // Custom dialog functions
        function showCustomConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded text-base">Confirm</button>
                    </div>
                </div>
            `;

            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = () => {
                modal.remove();
                onConfirm();
            };

            document.body.appendChild(modal);
        }

        function showCustomPrompt(message, defaultValue = '') {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                        <input type="text" class="prompt-input w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 mb-4 text-base" value="${defaultValue}">
                        <div class="flex justify-end space-x-3">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                            <button class="ok-btn px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded text-base">OK</button>
                        </div>
                    </div>
                `;

                const input = modal.querySelector('.prompt-input');
                const close = (value) => {
                    modal.remove();
                    resolve(value);
                };

                modal.querySelector('.cancel-btn').onclick = () => close(null);
                modal.querySelector('.ok-btn').onclick = () => close(input.value);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        close(input.value);
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        close(null);
                    }
                });
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        close(null);
                    }
                });

                document.body.appendChild(modal);
                requestAnimationFrame(() => {
                    input.focus();
                    input.select();
                });
            });
        }

        // Initialize
        renderCharacters();
        renderCombat();
        displayRollResults();
        renderCampaigns();
        updateCombatRoundDisplay();
    </script>


</body></html>