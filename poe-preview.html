<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCC Virtual Tabletop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .dice-result {
            animation: rollIn 0.3s ease-out;
        }
        @keyframes rollIn {
            from {
                transform: scale(0.5) rotate(180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        .tab-active {
            border-bottom: 3px solid #5D5CDE;
            color: #5D5CDE;
        }
        .stat-modifier {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        .prose p {
            margin-bottom: 0.5rem;
        }
        .prose ul {
            list-style-type: disc;
            margin-left: 1.25rem;
        }
        .prose li {
            margin-bottom: 0.25rem;
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen transition-colors">
    <div class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-2">DCC Virtual Tabletop</h1>
            <p class="text-center text-gray-600 dark:text-gray-400">Dungeon Crawl Classics RPG</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="border-b border-gray-300 dark:border-gray-700 mb-6">
            <ul class="flex flex-wrap -mb-px text-sm md:text-base">
                <li class="mr-2">
                    <button onclick="switchTab('characters')" id="tab-characters" class="tab-active inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Characters</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('dice')" id="tab-dice" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Dice Roller</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('combat')" id="tab-combat" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Combat Tracker</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('tables')" id="tab-tables" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Reference Tables</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('campaigns')" id="tab-campaigns" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Campaigns</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('ai')" id="tab-ai" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">AI Tools</button>
                </li>
            </ul>
        </nav>

        <!-- Tab Content -->
        <div id="content-characters" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Characters</h2>
                <button onclick="showCreateCharacter()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ New Character</button>
            </div>
            <div id="character-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Characters will be added here -->
            </div>
        </div>

        <div id="content-dice" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Dice Roller</h2>
            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 mb-6">
                <div class="grid grid-cols-4 md:grid-cols-7 gap-2 mb-4">
                    <button onclick="rollDice(3)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d3</button>
                    <button onclick="rollDice(4)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d4</button>
                    <button onclick="rollDice(5)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d5</button>
                    <button onclick="rollDice(6)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d6</button>
                    <button onclick="rollDice(7)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d7</button>
                    <button onclick="rollDice(8)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d8</button>
                    <button onclick="rollDice(10)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d10</button>
                    <button onclick="rollDice(12)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d12</button>
                    <button onclick="rollDice(14)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d14</button>
                    <button onclick="rollDice(16)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d16</button>
                    <button onclick="rollDice(20)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d20</button>
                    <button onclick="rollDice(24)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d24</button>
                    <button onclick="rollDice(30)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d30</button>
                    <button onclick="rollDice(100)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d%</button>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Modifier</label>
                    <input type="number" id="dice-modifier" value="0" class="w-full md:w-48 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Number of Dice</label>
                    <input type="number" id="dice-count" value="1" min="1" max="20" class="w-full md:w-48 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Roll Description (optional)</label>
                    <input type="text" id="roll-description" placeholder="e.g., Attack roll, Saving throw" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Roll Results</h3>
                <div id="dice-results" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 dark:text-gray-400 text-center py-8">Roll some dice to see results</p>
                </div>
            </div>
        </div>

        <div id="content-combat" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Combat Tracker</h2>
                <div class="flex gap-2">
                    <button onclick="addCombatant()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ Add Combatant</button>
                    <button onclick="sortInitiative()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-base">Sort Initiative</button>
                    <button onclick="clearCombat()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-base">Clear All</button>
                </div>
            </div>

            <div class="mb-4 bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                <div class="flex items-center gap-4">
                    <div>
                        <label class="font-semibold">Round:</label>
                        <span id="combat-round" class="ml-2 text-xl font-bold text-primary">1</span>
                    </div>
                    <button onclick="nextRound()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Next Round</button>
                </div>
            </div>

            <div id="combat-list" class="space-y-2">
                <!-- Combat entries will be added here -->
            </div>
        </div>

        <div id="content-tables" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Reference Tables</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Critical Hit Table -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Critical Hits (d20)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-16">1-6:</span><span>Normal damage</span></div>
                        <div class="flex"><span class="font-bold w-16">7-11:</span><span>+1d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">12-13:</span><span>+2d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">14-15:</span><span>+3d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">16-17:</span><span>+1d10 damage + bleed 1d6</span></div>
                        <div class="flex"><span class="font-bold w-16">18:</span><span>+2d10 damage + bleed 1d6</span></div>
                        <div class="flex"><span class="font-bold w-16">19:</span><span>+3d10 damage + bleed 2d6</span></div>
                        <div class="flex"><span class="font-bold w-16">20:</span><span>+4d10 damage + limb/organ damage</span></div>
                    </div>
                </div>

                <!-- Fumble Table -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Fumbles (d8)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">1:</span><span>Drop weapon</span></div>
                        <div class="flex"><span class="font-bold w-12">2:</span><span>Slip, lose next action</span></div>
                        <div class="flex"><span class="font-bold w-12">3:</span><span>Twist ankle, -5 ft movement</span></div>
                        <div class="flex"><span class="font-bold w-12">4:</span><span>Stumble, foe gets free attack</span></div>
                        <div class="flex"><span class="font-bold w-12">5:</span><span>Hit ally for normal damage</span></div>
                        <div class="flex"><span class="font-bold w-12">6:</span><span>Weapon stuck, DC 10 STR to free</span></div>
                        <div class="flex"><span class="font-bold w-12">7:</span><span>Armor strap breaks, -1 AC</span></div>
                        <div class="flex"><span class="font-bold w-12">8:</span><span>Weapon damaged, -1 to hit</span></div>
                    </div>
                </div>

                <!-- Ability Score Modifiers -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Ability Score Modifiers</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">3:</span><span>-3</span></div>
                        <div class="flex"><span class="font-bold w-12">4-5:</span><span>-2</span></div>
                        <div class="flex"><span class="font-bold w-12">6-8:</span><span>-1</span></div>
                        <div class="flex"><span class="font-bold w-12">9-12:</span><span>0</span></div>
                        <div class="flex"><span class="font-bold w-12">13-15:</span><span>+1</span></div>
                        <div class="flex"><span class="font-bold w-12">16-17:</span><span>+2</span></div>
                        <div class="flex"><span class="font-bold w-12">18:</span><span>+3</span></div>
                    </div>
                </div>

                <!-- Luck Uses -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Luck Uses</h3>
                    <div class="space-y-2 text-sm">
                        <div>• Add/subtract from any roll (before or after)</div>
                        <div>• Improve critical hit/fumble results</div>
                        <div>• Modify initiative</div>
                        <div>• Find lucky items or gold</div>
                        <div>• Avoid death (at Judge's discretion)</div>
                        <div class="pt-2 italic">Luck spent is permanent unless restored</div>
                    </div>
                </div>

                <!-- Action Dice -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Action Dice by Level</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-20">Level 1-4:</span><span>1d20</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 5:</span><span>1d20 + 1d14</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 6-7:</span><span>1d20 + 1d16</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 8-9:</span><span>1d20 + 1d20</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 10:</span><span>1d20 + 1d20 + 1d14</span></div>
                        <div class="pt-2 italic text-xs">Warriors gain bonus action dice at higher levels</div>
                    </div>
                </div>

                <!-- Spell Corruption -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Spell Corruption (d10)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">1:</span><span>Eyes glow when casting</span></div>
                        <div class="flex"><span class="font-bold w-12">2:</span><span>Hair turns white/silver</span></div>
                        <div class="flex"><span class="font-bold w-12">3:</span><span>Skin becomes pale/ashen</span></div>
                        <div class="flex"><span class="font-bold w-12">4:</span><span>Fingernails turn black</span></div>
                        <div class="flex"><span class="font-bold w-12">5:</span><span>Voice becomes raspy</span></div>
                        <div class="flex"><span class="font-bold w-12">6:</span><span>Minor temperature change around caster</span></div>
                        <div class="flex"><span class="font-bold w-12">7:</span><span>Smell of brimstone/ozone</span></div>
                        <div class="flex"><span class="font-bold w-12">8:</span><span>Small horns sprout</span></div>
                        <div class="flex"><span class="font-bold w-12">9:</span><span>Shadow moves independently</span></div>
                        <div class="flex"><span class="font-bold w-12">10:</span><span>Magical runes appear on skin</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-campaigns" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Campaigns</h2>
                <button onclick="showCreateCampaign()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ New Campaign</button>
            </div>
            <div id="campaign-list" class="grid grid-cols-1 gap-4">
                <!-- Campaigns will be added here -->
            </div>
        </div>

        <div id="content-ai" class="tab-content hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
                <div>
                    <h2 class="text-2xl font-bold">AI Tools</h2>
                    <p class="text-gray-600 dark:text-gray-400 text-sm md:text-base">Generate inspiration for NPCs, quests, and vivid scene descriptions tailored to your campaign.</p>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-900 px-4 py-2 rounded">
                    These generators run locally in your browser using curated creative tables.
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <section class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5 shadow-sm border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">AI NPC Generator</h3>
                        <button onclick="copyAiText('ai-npc-output')" class="text-sm px-3 py-1.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition">Copy</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold mb-2">Tone</label>
                            <select id="ai-npc-tone" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-sm">
                                <option value="heroic">Heroic</option>
                                <option value="gritty">Gritty</option>
                                <option value="whimsical">Whimsical</option>
                                <option value="mysterious">Mysterious</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold mb-2">Role</label>
                            <select id="ai-npc-role" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-sm">
                                <option value="village guide">Village Guide</option>
                                <option value="battle-scarred warrior">Battle-Scarred Warrior</option>
                                <option value="eccentric sage">Eccentric Sage</option>
                                <option value="shadowy broker">Shadowy Broker</option>
                                <option value="wandering performer">Wandering Performer</option>
                                <option value="zealous cleric">Zealous Cleric</option>
                                <option value="underworld fixer">Underworld Fixer</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold mb-2">Campaign Thread</label>
                            <input type="text" id="ai-npc-theme" placeholder="Ancient curse, lost heir, etc." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-sm">
                        </div>
                    </div>
                    <button onclick="generateNpcIdea()" class="w-full md:w-auto bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Generate NPC</button>
                    <div id="ai-npc-output" class="mt-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-4 min-h-[160px] prose prose-sm dark:prose-invert max-w-none text-sm">
                        <p class="text-gray-500 dark:text-gray-400">Pick your tone and role to create a fresh face for your world.</p>
                    </div>
                </section>

                <section class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5 shadow-sm border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">AI Quest Hook Generator</h3>
                        <button onclick="copyAiText('ai-quest-output')" class="text-sm px-3 py-1.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition">Copy</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold mb-2">Difficulty</label>
                            <select id="ai-quest-difficulty" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-sm">
                                <option value="novice">Novice</option>
                                <option value="seasoned">Seasoned</option>
                                <option value="heroic">Heroic</option>
                                <option value="deadly">Deadly</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold mb-2">Pacing</label>
                            <select id="ai-quest-length" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-sm">
                                <option value="one-shot">One-Shot</option>
                                <option value="short arc">Short Arc</option>
                                <option value="season-long">Season Long</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold mb-2">Story Seed</label>
                            <input type="text" id="ai-quest-theme" placeholder="Plague, prophecy, rebellion..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-sm">
                        </div>
                    </div>
                    <button onclick="generateQuestIdea()" class="w-full md:w-auto bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Generate Quest Hook</button>
                    <div id="ai-quest-output" class="mt-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-4 min-h-[160px] prose prose-sm dark:prose-invert max-w-none text-sm">
                        <p class="text-gray-500 dark:text-gray-400">Blend difficulty, pacing, and seeds into a ready-to-run adventure idea.</p>
                    </div>
                </section>

                <section class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5 shadow-sm border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">AI Scene Painter</h3>
                        <button onclick="copyAiText('ai-scene-output')" class="text-sm px-3 py-1.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition">Copy</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold mb-2">Location Type</label>
                            <select id="ai-scene-location" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-sm">
                                <option value="ancient ruin">Ancient Ruin</option>
                                <option value="eldritch forest">Eldritch Forest</option>
                                <option value="bustling bazaar">Bustling Bazaar</option>
                                <option value="astral crossing">Astral Crossing</option>
                                <option value="sacred temple">Sacred Temple</option>
                                <option value="forbidden laboratory">Forbidden Laboratory</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold mb-2">Mood</label>
                            <select id="ai-scene-mood" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-sm">
                                <option value="awe">Awe</option>
                                <option value="tension">Tension</option>
                                <option value="melancholy">Melancholy</option>
                                <option value="whimsy">Whimsy</option>
                                <option value="horror">Horror</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold mb-2">Sensory Focus</label>
                            <select id="ai-scene-sense" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-sm">
                                <option value="sound">Sound</option>
                                <option value="scent">Scent</option>
                                <option value="texture">Texture</option>
                                <option value="temperature">Temperature</option>
                                <option value="light">Light</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="generateSceneDescription()" class="w-full md:w-auto bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Paint the Scene</button>
                    <div id="ai-scene-output" class="mt-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-4 min-h-[160px] prose prose-sm dark:prose-invert max-w-none text-sm">
                        <p class="text-gray-500 dark:text-gray-400">Dial in a location, mood, and sensation to receive a ready-made description.</p>
                    </div>
                </section>

                <section class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5 shadow-sm border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">AI Idea Vault</h3>
                        <button onclick="aiHistory = []; renderAiHistory(); showToast('Cleared AI idea history.');" class="text-sm px-3 py-1.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition">Clear</button>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Every generated idea is saved here for quick reference. Click any entry to copy it back to your clipboard.</p>
                    <div id="ai-history" class="space-y-3 max-h-[420px] overflow-y-auto pr-1">
                        <!-- History is rendered here -->
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div id="create-campaign-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Create Campaign</h3>
                <form id="campaign-form" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Campaign Name</label>
                        <input type="text" id="campaign-name" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Campaign Description</label>
                        <textarea id="campaign-description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="hideCreateCampaign()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-base">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-base">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Campaign Detail Modal -->
    <div id="campaign-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-campaign-name"></h3>
                    <button onclick="hideCampaignDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="campaign-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Adventure Detail Modal -->
    <div id="adventure-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-adventure-name"></h3>
                    <button onclick="hideAdventureDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="adventure-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div id="create-character-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Create Character</h3>
                <form id="character-form" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Name</label>
                        <input type="text" id="char-name" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">Level</label>
                            <input type="number" id="char-level" value="0" min="0" max="10" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Class</label>
                            <select id="char-class" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                                <option value="Peasant">0-Level (Peasant)</option>
                                <option value="Warrior">Warrior</option>
                                <option value="Wizard">Wizard</option>
                                <option value="Cleric">Cleric</option>
                                <option value="Thief">Thief</option>
                                <option value="Dwarf">Dwarf</option>
                                <option value="Elf">Elf</option>
                                <option value="Halfling">Halfling</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">STR</label>
                            <input type="number" id="char-str" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">AGI</label>
                            <input type="number" id="char-agi" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">STA</label>
                            <input type="number" id="char-sta" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">PER</label>
                            <input type="number" id="char-per" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">INT</label>
                            <input type="number" id="char-int" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">LUC</label>
                            <input type="number" id="char-luc" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">HP (Max)</label>
                            <input type="number" id="char-hp-max" value="4" min="1" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Current HP</label>
                            <input type="number" id="char-hp-current" value="4" min="0" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">AC</label>
                            <input type="number" id="char-ac" value="10" min="1" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Speed</label>
                            <input type="number" id="char-speed" value="30" min="0" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block mb-2 font-semibold">Equipment/Notes</label>
                        <textarea id="char-equipment" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base"></textarea>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="hideCreateCharacter()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-base">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-base">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Character Detail Modal -->
    <div id="character-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-char-name"></h3>
                    <button onclick="hideCharacterDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="character-detail-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data storage (in-memory)
        let characters = [];
        let combatants = [];
        let combatRound = 1;
        let rollHistory = [];
        let aiHistory = [];

        const aiTables = {
            names: ["Eldra", "Brannik", "Seraphine", "Torvyn", "Ilyssa", "Korrin", "Nymera", "Jaxom", "Vesha", "Maelor", "Quint", "Sylphene", "Orin", "Tamsin", "Vandor", "Elowen"],
            heroicDescriptors: ["steadfast", "lionhearted", "undaunted", "honorable", "radiant"],
            grittyDescriptors: ["world-weary", "scarred", "pragmatic", "grizzled", "relentless"],
            whimsicalDescriptors: ["sprightly", "eccentric", "free-spirited", "imaginative", "irrepressible"],
            mysteriousDescriptors: ["enigmatic", "soft-spoken", "veil-cloaked", "cryptic", "brooding"],
            backgrounds: ["a former court jester turned wandering mediator", "a disgraced knight seeking a path back to glory", "an archivist who catalogues forbidden prophecies", "a monster hunter who hears whispers from trophies kept in jars", "an herbalist from a vanished village of dreamwalkers", "a cartographer obsessed with mapping ley lines", "a survivor of the star-fall that scarred the land", "a pilgrim sworn to light candles in forgotten shrines"],
            motivations: ["hopes to atone for a costly mistake", "wants to protect those unable to defend themselves", "is trying to complete a vow sworn under an eclipse", "seeks rare lore to bargain for a loved one's return", "must gather debts owed to a sleeping patron", "wants to prove that fate can be rewritten"],
            personalityTraits: ["compassionate but stubborn about traditions", "calculating yet unexpectedly sentimental", "infectiously optimistic even in dire straits", "dry-witted with a talent for barbed compliments", "quietly intense and hungry for justice", "relaxed and musical, constantly tapping rhythms"],
            quirks: ["keeps a pocket full of carved bone charms", "consults a deck of mismatched tarot cards before every decision", "writes every promise on scraps of red cloth", "is trailed by a tiny, invisible bell that only animals seem to hear", "refuses to turn their back on open doorways", "collects rumors about the players and trades them back as favors"],
            hooks: ["Knows a hidden route into the next dungeon and is willing to guide the party if they help with a personal errand.", "Offers a rare artifact keyed to the party's current foe, but demands a dangerous test of character first.", "Begs the heroes to mediate a dispute that could ignite a civil feud.", "Asks the party to smuggle them past an execution squad waiting at the city gates.", "Believes one of the heroes fulfills a prophecy and wants to orchestrate the next step.", "Needs protection during a ritual that will shake the veil between planes."],
            themeConnections: ["Their fate is intertwined with the party's past misadventures.", "Their family keeps lore about a foe the heroes will soon face.", "They carry a map fragment that resonates with the party's quest item.", "They witnessed the inciting incident of the current campaign.", "They are hunted by the same enemy that stalks the heroes."],
            questTitlePrefixes: ["Echoes of", "The Last", "Shadows over", "Whispers of", "Siege of", "Secrets beneath", "The Broken", "Rescue at"],
            questTitleSuffixes: ["the Astral Spire", "Grimholt Keep", "the Moonlit Mire", "the Clockwork Oracle", "the Ember Vault", "Blackstone Fen", "the Clockmaker's Tomb", "the Sapphire Reliquary"],
            antagonists: ["a cult of star-eyed zealots", "a sentient storm forging living lightning", "a rival adventuring band striking preemptively", "a plague demon wearing a healer's guise", "a tyrant enthroned on cursed bone", "an oracle who wants to avert a prophecy at any cost"],
            questComplications: ["the environment shifts each hour like a living dungeon", "allies are forced to duel each other by a binding geas", "the villain shares a tragic bond with one hero", "the locals believe the party are the villains", "time loops if the heroes fail to show compassion", "a beloved NPC has already defected to the enemy"],
            questRewards: ["a relic that bends luck once per day", "a seat at a council that controls the region's trade", "ownership of a small keep along a ley line", "secret tutelage in an ancient spell duel tradition", "a boon from an elemental monarch", "a map leading to a legendary mentor"],
            questTwists: ["the supposed villain is a puppet for a deeper power", "the quest location shifts planes midway through", "the artifact the heroes seek is actually a sapient ally", "completing the quest may doom an innocent settlement", "the heroes must choose between two equally vital objectives", "success requires sacrificing something the party treasures"],
            pacingNotes: {
                "one-shot": "Designed for a single intense session with a decisive climax.",
                "short arc": "Built to unfold across several sessions with evolving stakes.",
                "season-long": "Structured to anchor a sprawling campaign with layered factions."
            },
            difficultyNotes: {
                "novice": "ideal for fresh adventurers finding their footing",
                "seasoned": "challenging for capable heroes with a few scars",
                "heroic": "demanding even for legends of the realm",
                "deadly": "a perilous gauntlet that could reshape the campaign"
            },
            sceneOpeners: ["A breath catches as the horizon parts...", "You crest a ridge and behold...", "Mist curls away to reveal...", "A ripple through reality unveils...", "The world hushes when you step into..."],
            sceneActions: ["Distant figures pause to watch the newcomers arrive.", "An omen flares briefly before fading back into the environment.", "Hidden runes answer the heroes with a soft resonance.", "Weather shifts the moment the party sets foot inside.", "A forgotten guardian stirs but hesitates, judging intentions."],
            moodLines: {
                "awe": ["The atmosphere swells with possibility, every detail begging to be explored."],
                "tension": ["Every line feels taut, as though the scene itself is holding its breath."],
                "melancholy": ["There is beauty in the decay here, a gentle ache woven through the silence."],
                "whimsy": ["Playful contradictions bloom in every corner, daring the party to grin despite the odds."],
                "horror": ["A creeping dread rides the air, hinting that something old refuses to stay buried."]
            },
            senseDetails: {
                "sound": ["distant chimes made of bone, swaying on unseen winds", "echoing heartbeats that do not belong to the heroes", "low chanting woven through the rustle of leaves", "a gentle hum like a sleeping beast", "the click of unseen mechanisms testing ancient gears"],
                "scent": ["ozone and singed petals mingled together", "old vellum soaked in incense and seawater", "sweet rot beneath a blanket of wildflowers", "cool iron and damp stone after rainfall", "smoldering sage mixed with fresh-baked bread"],
                "texture": ["flagstones that thrum softly like drums", "velvet moss hiding knife-sharp shards", "air thick as syrup brushing against skin", "dust motes that cling like static", "banners frayed to silk strands soft as whispers"],
                "temperature": ["a prickling chill rolling in waves", "humid warmth pulsing from the ground", "a sudden drop that frosts armor edges", "cozy hearth heat confined to a single beam of light", "drafts swirling in deliberate patterns"],
                "light": ["shafts of emerald light bending around the heroes", "lanterns suspended in mid-air like frozen fireflies", "moonlight that spills upward instead of down", "a guttering glow that reacts to spoken words", "stained glass shadows painting the party in sigils"]
            },
            sceneDetails: ["spectral fish swim lazily through the air", "a colossal statue weeps molten tears into a basin", "timeworn murals animate whenever someone blinks", "floating market stalls bump gently against each other", "a crystal lattice hums in tune with beating hearts", "an astral current tugs at loose garments"]
        };

        function aiPick(list) {
            return list[Math.floor(Math.random() * list.length)];
        }

        function toneDescriptor(tone) {
            const map = {
                heroic: aiTables.heroicDescriptors,
                gritty: aiTables.grittyDescriptors,
                whimsical: aiTables.whimsicalDescriptors,
                mysterious: aiTables.mysteriousDescriptors
            };
            const pool = map[tone] || aiTables.heroicDescriptors;
            return aiPick(pool);
        }

        function sanitizeInput(value) {
            if (!value) return '';
            return value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function generateNpcIdea() {
            const tone = document.getElementById('ai-npc-tone').value;
            const role = document.getElementById('ai-npc-role').value;
            const theme = sanitizeInput(document.getElementById('ai-npc-theme').value.trim());

            const name = aiPick(aiTables.names);
            const descriptor = toneDescriptor(tone);
            const background = aiPick(aiTables.backgrounds);
            const motivation = aiPick(aiTables.motivations);
            const personality = aiPick(aiTables.personalityTraits);
            const quirk = aiPick(aiTables.quirks);
            const hook = aiPick(aiTables.hooks);
            const themeLine = theme ? `They tie directly into ${theme.toLowerCase()}.` : aiPick(aiTables.themeConnections);

            const markdown = `### ${name}, the ${descriptor} ${role}
**Overview:** ${name} is ${background} who ${motivation}. ${themeLine}
**Personality:** ${personality}.
**Quirk:** ${quirk}.
**Adventure Hook:** ${hook}`;

            updateAiOutput('ai-npc-output', markdown, 'NPC');
        }

        function generateQuestIdea() {
            const difficulty = document.getElementById('ai-quest-difficulty').value;
            const length = document.getElementById('ai-quest-length').value;
            const theme = sanitizeInput(document.getElementById('ai-quest-theme').value.trim());

            const title = `${aiPick(aiTables.questTitlePrefixes)} ${aiPick(aiTables.questTitleSuffixes)}`;
            const antagonist = aiPick(aiTables.antagonists);
            const complication = aiPick(aiTables.questComplications);
            const twist = aiPick(aiTables.questTwists);
            const reward = aiPick(aiTables.questRewards);
            const themeLine = theme ? `The story seed revolves around ${theme.toLowerCase()}.` : 'The seed can be tailored to your current storyline.';

            const markdown = `### ${title}
**Tone:** ${difficulty.toUpperCase()} — ${aiTables.difficultyNotes[difficulty]}.
**Pacing:** ${aiTables.pacingNotes[length]}

**Quest Pitch:** The heroes confront ${antagonist} while ${themeLine}
- **Primary Obstacle:** ${complication}.
- **Signature Twist:** ${twist}.
- **Reward:** ${reward}.`;

            updateAiOutput('ai-quest-output', markdown, 'Quest');
        }

        function generateSceneDescription() {
            const location = document.getElementById('ai-scene-location').value;
            const mood = document.getElementById('ai-scene-mood').value;
            const sense = document.getElementById('ai-scene-sense').value;

            const opener = aiPick(aiTables.sceneOpeners);
            const moodLine = aiPick(aiTables.moodLines[mood] || aiTables.moodLines.awe);
            const sensory = aiPick(aiTables.senseDetails[sense]);
            const detail = aiPick(aiTables.sceneDetails);
            const action = aiPick(aiTables.sceneActions);

            const markdown = `### ${opener}
${moodLine}

You arrive at the ${location}, where ${detail}. The ${sense} is dominated by ${sensory}. ${action}`;

            updateAiOutput('ai-scene-output', markdown, 'Scene');
        }

        function updateAiOutput(elementId, markdown, typeLabel) {
            const container = document.getElementById(elementId);
            if (!container) return;

            container.innerHTML = marked.parse(markdown);
            container.dataset.raw = markdown;

            pushAiHistory(typeLabel, markdown);
        }

        function pushAiHistory(typeLabel, markdown) {
            aiHistory.unshift({
                type: typeLabel,
                markdown,
                timestamp: new Date().toLocaleTimeString()
            });

            if (aiHistory.length > 12) {
                aiHistory.pop();
            }

            renderAiHistory();
        }

        function renderAiHistory() {
            const container = document.getElementById('ai-history');
            if (!container) return;

            if (aiHistory.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Generate an idea to begin filling your vault.</p>';
                return;
            }

            container.innerHTML = aiHistory.map((entry, index) => `
                <div class="group bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-3 transition hover:border-primary hover:shadow cursor-pointer" onclick="copyAiHistory(${index})">
                    <div class="flex justify-between text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-2">
                        <span>${entry.type}</span>
                        <span>${entry.timestamp}</span>
                    </div>
                    <div class="prose prose-sm dark:prose-invert max-w-none">
                        ${marked.parse(entry.markdown)}
                    </div>
                    <p class="text-xs text-primary opacity-0 group-hover:opacity-100 transition mt-2">Click to copy</p>
                </div>
            `).join('');
        }

        function copyAiText(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            const raw = element.dataset.raw || element.textContent || '';
            copyText(raw.trim());
        }

        function copyAiHistory(index) {
            const entry = aiHistory[index];
            if (!entry) return;
            copyText(entry.markdown.trim());
        }

        function copyText(text) {
            if (!text) return;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard.'));
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                textarea.remove();
                showToast('Copied to clipboard.');
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 right-6 bg-gray-900 text-white px-4 py-2 rounded shadow-lg text-sm z-50';
            toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(8px)';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Tab switching
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('tab-active'));

            // Show selected tab
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('tab-active');
        }

        // Calculate ability modifier
        function getModifier(score) {
            if (score <= 3) return -3;
            if (score <= 5) return -2;
            if (score <= 8) return -1;
            if (score <= 12) return 0;
            if (score <= 15) return 1;
            if (score <= 17) return 2;
            return 3;
        }

        // Character Management
        function showCreateCharacter() {
            document.getElementById('create-character-modal').classList.remove('hidden');
            document.getElementById('create-character-modal').classList.add('flex');
        }

        function hideCreateCharacter() {
            document.getElementById('create-character-modal').classList.add('hidden');
            document.getElementById('create-character-modal').classList.remove('flex');
            document.getElementById('character-form').reset();
        }

        document.getElementById('character-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const character = {
                id: Date.now(),
                name: document.getElementById('char-name').value,
                level: parseInt(document.getElementById('char-level').value),
                class: document.getElementById('char-class').value,
                str: parseInt(document.getElementById('char-str').value),
                agi: parseInt(document.getElementById('char-agi').value),
                sta: parseInt(document.getElementById('char-sta').value),
                per: parseInt(document.getElementById('char-per').value),
                int: parseInt(document.getElementById('char-int').value),
                luc: parseInt(document.getElementById('char-luc').value),
                hpMax: parseInt(document.getElementById('char-hp-max').value),
                hpCurrent: parseInt(document.getElementById('char-hp-current').value),
                ac: parseInt(document.getElementById('char-ac').value),
                speed: parseInt(document.getElementById('char-speed').value),
                equipment: document.getElementById('char-equipment').value
            };

            characters.push(character);
            renderCharacters();
            hideCreateCharacter();
        });

        function renderCharacters() {
            const container = document.getElementById('character-list');

            if (characters.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-full">No characters yet. Create one to get started!</p>';
                return;
            }

            container.innerHTML = characters.map(char => `
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 hover:shadow-lg transition cursor-pointer" onclick="showCharacterDetail(${char.id})">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-xl font-bold">${char.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Level ${char.level} ${char.class}</p>
                        </div>
                        <button onclick="event.stopPropagation(); deleteCharacter(${char.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-sm mb-2">
                        <div>
                            <span class="font-semibold">HP:</span> ${char.hpCurrent}/${char.hpMax}
                        </div>
                        <div>
                            <span class="font-semibold">AC:</span> ${char.ac}
                        </div>
                        <div>
                            <span class="font-semibold">Speed:</span> ${char.speed}ft
                        </div>
                    </div>
                    <div class="grid grid-cols-6 gap-1 text-xs">
                        <div class="text-center">
                            <div class="font-semibold">STR</div>
                            <div>${char.str} <span class="stat-modifier">(${getModifier(char.str) >= 0 ? '+' : ''}${getModifier(char.str)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">AGI</div>
                            <div>${char.agi} <span class="stat-modifier">(${getModifier(char.agi) >= 0 ? '+' : ''}${getModifier(char.agi)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">STA</div>
                            <div>${char.sta} <span class="stat-modifier">(${getModifier(char.sta) >= 0 ? '+' : ''}${getModifier(char.sta)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">PER</div>
                            <div>${char.per} <span class="stat-modifier">(${getModifier(char.per) >= 0 ? '+' : ''}${getModifier(char.per)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">INT</div>
                            <div>${char.int} <span class="stat-modifier">(${getModifier(char.int) >= 0 ? '+' : ''}${getModifier(char.int)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">LUC</div>
                            <div>${char.luc} <span class="stat-modifier">(${getModifier(char.luc) >= 0 ? '+' : ''}${getModifier(char.luc)})</span></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCharacterDetail(id) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            document.getElementById('detail-char-name').textContent = char.name;

            const content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-semibold">Level:</span> ${char.level}</div>
                        <div><span class="font-semibold">Class:</span> ${char.class}</div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">HP</div>
                            <div class="text-2xl font-bold">${char.hpCurrent}/${char.hpMax}</div>
                            <div class="mt-2 flex gap-2">
                                <button onclick="adjustHP(${char.id}, -1)" class="flex-1 bg-red-500 text-white px-2 py-1 rounded text-sm">-</button>
                                <button onclick="adjustHP(${char.id}, 1)" class="flex-1 bg-green-500 text-white px-2 py-1 rounded text-sm">+</button>
                            </div>
                        </div>
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">AC</div>
                            <div class="text-2xl font-bold">${char.ac}</div>
                        </div>
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">Speed</div>
                            <div class="text-2xl font-bold">${char.speed}ft</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold mb-2">Ability Scores</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">STR</div>
                                <div class="text-xl">${char.str}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.str) >= 0 ? '+' : ''}${getModifier(char.str)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">AGI</div>
                                <div class="text-xl">${char.agi}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.agi) >= 0 ? '+' : ''}${getModifier(char.agi)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">STA</div>
                                <div class="text-xl">${char.sta}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.sta) >= 0 ? '+' : ''}${getModifier(char.sta)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">PER</div>
                                <div class="text-xl">${char.per}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.per) >= 0 ? '+' : ''}${getModifier(char.per)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">INT</div>
                                <div class="text-xl">${char.int}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.int) >= 0 ? '+' : ''}${getModifier(char.int)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">LUC</div>
                                <div class="text-xl">${char.luc}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.luc) >= 0 ? '+' : ''}${getModifier(char.luc)}</div>
                            </div>
                        </div>
                    </div>

                    ${char.equipment ? `
                    <div>
                        <h4 class="font-bold mb-2">Equipment & Notes</h4>
                        <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded whitespace-pre-wrap">${char.equipment}</div>
                    </div>
                    ` : ''}

                    <div class="flex gap-2">
                        <button onclick="addCharacterToCombat(${char.id})" class="flex-1 bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Add to Combat</button>
                        <button onclick="deleteCharacter(${char.id})" class="flex-1 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-base">Delete</button>
                    </div>
                </div>
            `;

            document.getElementById('character-detail-content').innerHTML = content;
            document.getElementById('character-detail-modal').classList.remove('hidden');
            document.getElementById('character-detail-modal').classList.add('flex');
        }

        function hideCharacterDetail() {
            document.getElementById('character-detail-modal').classList.add('hidden');
            document.getElementById('character-detail-modal').classList.remove('flex');
        }

        function adjustHP(id, amount) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            char.hpCurrent = Math.max(0, Math.min(char.hpMax, char.hpCurrent + amount));
            renderCharacters();
            showCharacterDetail(id);
        }

        function deleteCharacter(id) {
            showCustomConfirm('Are you sure you want to delete this character?', () => {
                characters = characters.filter(c => c.id !== id);
                renderCharacters();
                hideCharacterDetail();
            });
        }

        // Dice Roller
        function rollDice(sides) {
            const count = parseInt(document.getElementById('dice-count').value) || 1;
            const modifier = parseInt(document.getElementById('dice-modifier').value) || 0;
            const description = document.getElementById('roll-description').value;

            const rolls = [];
            let total = modifier;

            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }

            const result = {
                sides,
                count,
                rolls,
                modifier,
                total,
                description,
                timestamp: new Date().toLocaleTimeString()
            };

            rollHistory.unshift(result);
            if (rollHistory.length > 20) rollHistory.pop();

            displayRollResults();
        }

        function displayRollResults() {
            const container = document.getElementById('dice-results');

            if (rollHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Roll some dice to see results</p>';
                return;
            }

            container.innerHTML = rollHistory.map(r => `
                <div class="dice-result bg-white dark:bg-gray-800 p-4 rounded-lg border-l-4 border-primary">
                    ${r.description ? `<div class="font-semibold mb-1">${r.description}</div>` : ''}
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            ${r.count}d${r.sides}${r.modifier !== 0 ? (r.modifier > 0 ? '+' : '') + r.modifier : ''}
                            <span class="ml-2">[${r.rolls.join(', ')}]</span>
                        </div>
                        <div class="text-2xl font-bold text-primary">${r.total}</div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">${r.timestamp}</div>
                </div>
            `).join('');
        }

        // Combat Tracker
        function addCombatant() {
            const name = showCustomPrompt('Enter combatant name:');
            if (!name) return;

            const initiative = showCustomPrompt('Enter initiative (or leave blank to roll):');
            const init = initiative ? parseInt(initiative) : Math.floor(Math.random() * 20) + 1;

            const hp = showCustomPrompt('Enter HP:', '10');
            const ac = showCustomPrompt('Enter AC:', '10');

            combatants.push({
                id: Date.now(),
                name,
                initiative: init,
                hp: parseInt(hp) || 10,
                hpMax: parseInt(hp) || 10,
                ac: parseInt(ac) || 10,
                isActive: false
            });

            renderCombat();
        }

        function addCharacterToCombat(charId) {
            const char = characters.find(c => c.id === charId);
            if (!char) return;

            const initiative = Math.floor(Math.random() * 20) + 1 + getModifier(char.agi);

            combatants.push({
                id: Date.now(),
                name: char.name,
                initiative,
                hp: char.hpCurrent,
                hpMax: char.hpMax,
                ac: char.ac,
                isActive: false,
                characterId: charId
            });

            renderCombat();
            hideCharacterDetail();
        }

        function sortInitiative() {
            combatants.sort((a, b) => b.initiative - a.initiative);
            if (combatants.length > 0) {
                combatants.forEach(c => c.isActive = false);
                combatants[0].isActive = true;
            }
            renderCombat();
        }

        function renderCombat() {
            const container = document.getElementById('combat-list');

            if (combatants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No combatants. Add characters or NPCs to begin combat.</p>';
                return;
            }

            container.innerHTML = combatants.map((c, index) => `
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg ${c.isActive ? 'ring-2 ring-primary' : ''}">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                ${c.isActive ? '<span class="text-primary text-2xl">▶</span>' : '<span class="text-2xl opacity-0">▶</span>'}
                                <div class="flex-1">
                                    <div class="font-bold text-lg">${c.name}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Initiative: ${c.initiative} | AC: ${c.ac}</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-600 dark:text-gray-400">HP</div>
                                <div class="font-bold ${c.hp <= 0 ? 'text-red-500' : ''}">${c.hp}/${c.hpMax}</div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="adjustCombatantHP(${c.id}, -1)" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-base">-</button>
                                <button onclick="adjustCombatantHP(${c.id}, 1)" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-base">+</button>
                            </div>
                            <button onclick="removeCombatant(${c.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function adjustCombatantHP(id, amount) {
            const combatant = combatants.find(c => c.id === id);
            if (!combatant) return;

            combatant.hp = Math.max(0, Math.min(combatant.hpMax, combatant.hp + amount));

            // Update character if linked
            if (combatant.characterId) {
                const char = characters.find(c => c.id === combatant.characterId);
                if (char) {
                    char.hpCurrent = combatant.hp;
                    renderCharacters();
                }
            }

            renderCombat();
        }

        function removeCombatant(id) {
            combatants = combatants.filter(c => c.id !== id);
            renderCombat();
        }

        function clearCombat() {
            showCustomConfirm('Clear all combatants?', () => {
                combatants = [];
                combatRound = 1;
                document.getElementById('combat-round').textContent = combatRound;
                renderCombat();
            });
        }

        function nextRound() {
            combatRound++;
            document.getElementById('combat-round').textContent = combatRound;

            if (combatants.length > 0) {
                const currentIndex = combatants.findIndex(c => c.isActive);
                combatants.forEach(c => c.isActive = false);

                if (currentIndex < combatants.length - 1) {
                    combatants[currentIndex + 1].isActive = true;
                } else {
                    combatants[0].isActive = true;
                }

                renderCombat();
            }
        }

        // Custom dialog functions
        function showCustomConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded text-base">Confirm</button>
                    </div>
                </div>
            `;

            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = () => {
                modal.remove();
                onConfirm();
            };

            document.body.appendChild(modal);
        }

        function showCustomPrompt(message, defaultValue = '') {
            const result = {value: null};
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <input type="text" class="prompt-input w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 mb-4 text-base" value="${defaultValue}">
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                        <button class="ok-btn px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded text-base">OK</button>
                    </div>
                </div>
            `;

            const input = modal.querySelector('.prompt-input');
            const done = () => {
                result.value = input.value;
                modal.remove();
            };

            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.ok-btn').onclick = done;
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') done();
            });

            document.body.appendChild(modal);
            input.focus();
            input.select();

            // Synchronous-like behavior using a busy wait (not ideal but works for this use case)
            const startTime = Date.now();
            while (result.value === null && Date.now() - startTime < 60000) {
                // Wait for user input or timeout
                const event = new Promise(resolve => setTimeout(resolve, 10));
            }

            return result.value;
        }

        // Initialize
        renderAiHistory();
        renderCharacters();
        renderCombat();
    </script>


</body></html>