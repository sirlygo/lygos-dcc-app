<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCC Virtual Tabletop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .dice-result {
            animation: rollIn 0.3s ease-out;
        }
        @keyframes rollIn {
            from {
                transform: scale(0.5) rotate(180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        .tab-active {
            border-bottom: 3px solid #5D5CDE;
            color: #5D5CDE;
        }
        .stat-modifier {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        .prose {
            color: inherit;
        }
        .prose p {
            margin-bottom: 0.75rem;
        }
        .prose ul,
        .prose ol {
            margin-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .prose li {
            margin-bottom: 0.25rem;
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen transition-colors">
    <div class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-2">DCC Virtual Tabletop</h1>
            <p class="text-center text-gray-600 dark:text-gray-400">Dungeon Crawl Classics RPG</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="border-b border-gray-300 dark:border-gray-700 mb-6">
            <ul class="flex flex-wrap -mb-px text-sm md:text-base">
                <li class="mr-2">
                    <button onclick="switchTab('characters')" id="tab-characters" class="tab-active inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Characters</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('dice')" id="tab-dice" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Dice Roller</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('combat')" id="tab-combat" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Combat Tracker</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('tables')" id="tab-tables" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Reference Tables</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('campaigns')" id="tab-campaigns" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Campaigns</button>
                </li>
            </ul>
        </nav>

        <!-- Tab Content -->
        <div id="content-characters" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Characters</h2>
                <button onclick="showCreateCharacter()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ New Character</button>
            </div>
            <div id="character-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Characters will be added here -->
            </div>
        </div>

        <div id="content-dice" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Dice Roller</h2>
            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 mb-6">
                <div class="grid grid-cols-4 md:grid-cols-7 gap-2 mb-4">
                    <button onclick="rollDice(3)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d3</button>
                    <button onclick="rollDice(4)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d4</button>
                    <button onclick="rollDice(5)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d5</button>
                    <button onclick="rollDice(6)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d6</button>
                    <button onclick="rollDice(7)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d7</button>
                    <button onclick="rollDice(8)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d8</button>
                    <button onclick="rollDice(10)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d10</button>
                    <button onclick="rollDice(12)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d12</button>
                    <button onclick="rollDice(14)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d14</button>
                    <button onclick="rollDice(16)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d16</button>
                    <button onclick="rollDice(20)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d20</button>
                    <button onclick="rollDice(24)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d24</button>
                    <button onclick="rollDice(30)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d30</button>
                    <button onclick="rollDice(100)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d%</button>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Modifier</label>
                    <input type="number" id="dice-modifier" value="0" class="w-full md:w-48 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Number of Dice</label>
                    <input type="number" id="dice-count" value="1" min="1" max="20" class="w-full md:w-48 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Roll Description (optional)</label>
                    <input type="text" id="roll-description" placeholder="e.g., Attack roll, Saving throw" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Roll Results</h3>
                <div id="dice-results" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 dark:text-gray-400 text-center py-8">Roll some dice to see results</p>
                </div>
            </div>
        </div>

        <div id="content-combat" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Combat Tracker</h2>
                <div class="flex gap-2">
                    <button onclick="addCombatant()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ Add Combatant</button>
                    <button onclick="sortInitiative()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-base">Sort Initiative</button>
                    <button onclick="clearCombat()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-base">Clear All</button>
                </div>
            </div>

            <div class="mb-4 bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                <div class="flex items-center gap-4">
                    <div>
                        <label class="font-semibold">Round:</label>
                        <span id="combat-round" class="ml-2 text-xl font-bold text-primary">1</span>
                    </div>
                    <button onclick="nextRound()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Next Round</button>
                </div>
            </div>

            <div id="combat-list" class="space-y-2">
                <!-- Combat entries will be added here -->
            </div>
        </div>

        <div id="content-tables" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Reference Tables</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Critical Hit Table -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Critical Hits (d20)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-16">1-6:</span><span>Normal damage</span></div>
                        <div class="flex"><span class="font-bold w-16">7-11:</span><span>+1d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">12-13:</span><span>+2d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">14-15:</span><span>+3d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">16-17:</span><span>+1d10 damage + bleed 1d6</span></div>
                        <div class="flex"><span class="font-bold w-16">18:</span><span>+2d10 damage + bleed 1d6</span></div>
                        <div class="flex"><span class="font-bold w-16">19:</span><span>+3d10 damage + bleed 2d6</span></div>
                        <div class="flex"><span class="font-bold w-16">20:</span><span>+4d10 damage + limb/organ damage</span></div>
                    </div>
                </div>

                <!-- Fumble Table -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Fumbles (d8)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">1:</span><span>Drop weapon</span></div>
                        <div class="flex"><span class="font-bold w-12">2:</span><span>Slip, lose next action</span></div>
                        <div class="flex"><span class="font-bold w-12">3:</span><span>Twist ankle, -5 ft movement</span></div>
                        <div class="flex"><span class="font-bold w-12">4:</span><span>Stumble, foe gets free attack</span></div>
                        <div class="flex"><span class="font-bold w-12">5:</span><span>Hit ally for normal damage</span></div>
                        <div class="flex"><span class="font-bold w-12">6:</span><span>Weapon stuck, DC 10 STR to free</span></div>
                        <div class="flex"><span class="font-bold w-12">7:</span><span>Armor strap breaks, -1 AC</span></div>
                        <div class="flex"><span class="font-bold w-12">8:</span><span>Weapon damaged, -1 to hit</span></div>
                    </div>
                </div>

                <!-- Ability Score Modifiers -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Ability Score Modifiers</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">3:</span><span>-3</span></div>
                        <div class="flex"><span class="font-bold w-12">4-5:</span><span>-2</span></div>
                        <div class="flex"><span class="font-bold w-12">6-8:</span><span>-1</span></div>
                        <div class="flex"><span class="font-bold w-12">9-12:</span><span>0</span></div>
                        <div class="flex"><span class="font-bold w-12">13-15:</span><span>+1</span></div>
                        <div class="flex"><span class="font-bold w-12">16-17:</span><span>+2</span></div>
                        <div class="flex"><span class="font-bold w-12">18:</span><span>+3</span></div>
                    </div>
                </div>

                <!-- Luck Uses -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Luck Uses</h3>
                    <div class="space-y-2 text-sm">
                        <div>• Add/subtract from any roll (before or after)</div>
                        <div>• Improve critical hit/fumble results</div>
                        <div>• Modify initiative</div>
                        <div>• Find lucky items or gold</div>
                        <div>• Avoid death (at Judge's discretion)</div>
                        <div class="pt-2 italic">Luck spent is permanent unless restored</div>
                    </div>
                </div>

                <!-- Action Dice -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Action Dice by Level</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-20">Level 1-4:</span><span>1d20</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 5:</span><span>1d20 + 1d14</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 6-7:</span><span>1d20 + 1d16</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 8-9:</span><span>1d20 + 1d20</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 10:</span><span>1d20 + 1d20 + 1d14</span></div>
                        <div class="pt-2 italic text-xs">Warriors gain bonus action dice at higher levels</div>
                    </div>
                </div>

                <!-- Spell Corruption -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Spell Corruption (d10)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">1:</span><span>Eyes glow when casting</span></div>
                        <div class="flex"><span class="font-bold w-12">2:</span><span>Hair turns white/silver</span></div>
                        <div class="flex"><span class="font-bold w-12">3:</span><span>Skin becomes pale/ashen</span></div>
                        <div class="flex"><span class="font-bold w-12">4:</span><span>Fingernails turn black</span></div>
                        <div class="flex"><span class="font-bold w-12">5:</span><span>Voice becomes raspy</span></div>
                        <div class="flex"><span class="font-bold w-12">6:</span><span>Minor temperature change around caster</span></div>
                        <div class="flex"><span class="font-bold w-12">7:</span><span>Smell of brimstone/ozone</span></div>
                        <div class="flex"><span class="font-bold w-12">8:</span><span>Small horns sprout</span></div>
                        <div class="flex"><span class="font-bold w-12">9:</span><span>Shadow moves independently</span></div>
                        <div class="flex"><span class="font-bold w-12">10:</span><span>Magical runes appear on skin</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-campaigns" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Campaigns</h2>
                <button onclick="showCreateCampaign()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ New Campaign</button>
            </div>
            <div id="campaign-list" class="grid grid-cols-1 gap-4">
                <!-- Campaigns will be added here -->
            </div>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div id="create-campaign-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Create Campaign</h3>
                <form id="campaign-form" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Campaign Name</label>
                        <input type="text" id="campaign-name" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Campaign Description</label>
                        <textarea id="campaign-description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="hideCreateCampaign()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-base">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-base">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Campaign Detail Modal -->
    <div id="campaign-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-campaign-name"></h3>
                    <button onclick="hideCampaignDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="campaign-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Adventure Detail Modal -->
    <div id="adventure-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-adventure-name"></h3>
                    <button onclick="hideAdventureDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="adventure-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div id="create-character-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Create Character</h3>
                <form id="character-form" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Name</label>
                        <input type="text" id="char-name" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">Level</label>
                            <input type="number" id="char-level" value="0" min="0" max="10" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Class</label>
                            <select id="char-class" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                                <option value="Peasant">0-Level (Peasant)</option>
                                <option value="Warrior">Warrior</option>
                                <option value="Wizard">Wizard</option>
                                <option value="Cleric">Cleric</option>
                                <option value="Thief">Thief</option>
                                <option value="Dwarf">Dwarf</option>
                                <option value="Elf">Elf</option>
                                <option value="Halfling">Halfling</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">STR</label>
                            <input type="number" id="char-str" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">AGI</label>
                            <input type="number" id="char-agi" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">STA</label>
                            <input type="number" id="char-sta" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">PER</label>
                            <input type="number" id="char-per" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">INT</label>
                            <input type="number" id="char-int" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">LUC</label>
                            <input type="number" id="char-luc" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">HP (Max)</label>
                            <input type="number" id="char-hp-max" value="4" min="1" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Current HP</label>
                            <input type="number" id="char-hp-current" value="4" min="0" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">AC</label>
                            <input type="number" id="char-ac" value="10" min="1" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Speed</label>
                            <input type="number" id="char-speed" value="30" min="0" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block mb-2 font-semibold">Equipment/Notes</label>
                        <textarea id="char-equipment" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base"></textarea>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="hideCreateCharacter()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-base">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-base">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Character Detail Modal -->
    <div id="character-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-char-name"></h3>
                    <button onclick="hideCharacterDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="character-detail-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data storage (persisted with localStorage when available)
        const STORAGE_KEYS = {
            characters: 'dcc_characters',
            campaigns: 'dcc_campaigns',
            combatants: 'dcc_combatants',
            combatRound: 'dcc_combat_round',
            rollHistory: 'dcc_roll_history'
        };

        function loadFromStorage(key, fallback) {
            if (typeof localStorage === 'undefined') return fallback;
            try {
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : fallback;
            } catch (error) {
                console.warn('Failed to load from storage', key, error);
                return fallback;
            }
        }

        function saveToStorage(key, value) {
            if (typeof localStorage === 'undefined') return;
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (error) {
                console.warn('Failed to save to storage', key, error);
            }
        }

        function ensureArray(value) {
            return Array.isArray(value) ? value : [];
        }

        let characters = ensureArray(loadFromStorage(STORAGE_KEYS.characters, []));
        let campaigns = ensureArray(loadFromStorage(STORAGE_KEYS.campaigns, [])).map(campaign => ({
            ...campaign,
            createdAt: campaign?.createdAt || new Date().toLocaleDateString(),
            adventures: Array.isArray(campaign?.adventures) ? campaign.adventures : [],
            sessions: Array.isArray(campaign?.sessions) ? campaign.sessions : []
        }));
        let combatants = ensureArray(loadFromStorage(STORAGE_KEYS.combatants, []));
        let combatRound = loadFromStorage(STORAGE_KEYS.combatRound, 1);
        combatRound = parseInt(combatRound, 10);
        if (!Number.isFinite(combatRound) || combatRound < 1) {
            combatRound = 1;
        }
        let rollHistory = ensureArray(loadFromStorage(STORAGE_KEYS.rollHistory, [])).slice(0, 20);

        function saveCharacters() {
            saveToStorage(STORAGE_KEYS.characters, characters);
        }

        function saveCampaigns() {
            saveToStorage(STORAGE_KEYS.campaigns, campaigns);
        }

        function saveCombatants() {
            saveToStorage(STORAGE_KEYS.combatants, combatants);
        }

        function saveCombatRound() {
            saveToStorage(STORAGE_KEYS.combatRound, combatRound);
        }

        function saveRollHistory() {
            saveToStorage(STORAGE_KEYS.rollHistory, rollHistory.slice(0, 20));
        }

        // Tab switching
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('tab-active'));

            // Show selected tab
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('tab-active');
        }

        // Calculate ability modifier
        function getModifier(score) {
            if (score <= 3) return -3;
            if (score <= 5) return -2;
            if (score <= 8) return -1;
            if (score <= 12) return 0;
            if (score <= 15) return 1;
            if (score <= 17) return 2;
            return 3;
        }

        // Character Management
        function showCreateCharacter() {
            document.getElementById('create-character-modal').classList.remove('hidden');
            document.getElementById('create-character-modal').classList.add('flex');
        }

        function hideCreateCharacter() {
            document.getElementById('create-character-modal').classList.add('hidden');
            document.getElementById('create-character-modal').classList.remove('flex');
            document.getElementById('character-form').reset();
        }

        // Campaign Management
        let activeCampaignId = null;
        let activeAdventureId = null;
        const ADVENTURE_STATUSES = ['Planned', 'Active', 'Completed'];

        function truncateText(text, limit = 160) {
            if (!text) return '';
            return text.length > limit ? text.slice(0, limit).trim() + '…' : text;
        }

        function summarizeText(text, limit = 160) {
            if (!text) return '';
            const withoutLinks = text.replace(/\[(.*?)\]\((.*?)\)/g, '$1');
            const sanitized = withoutLinks.replace(/[\*`_>#]/g, '').replace(/-{2,}/g, ' ').replace(/\s+/g, ' ').trim();
            return truncateText(sanitized, limit);
        }

        function renderMarkdown(text) {
            if (!text) return '';
            try {
                if (typeof marked !== 'undefined' && typeof marked.parse === 'function') {
                    return marked.parse(text);
                }
            } catch (error) {
                console.warn('Markdown rendering failed', error);
            }

            const escaped = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            return escaped
                .split(/\n{2,}/)
                .map(paragraph => `<p>${paragraph.replace(/\n/g, '<br>')}</p>`)
                .join('');
        }

        function normalizeAdventureStatus(value) {
            if (!value) return ADVENTURE_STATUSES[0];
            const normalized = value.toLowerCase();
            const match = ADVENTURE_STATUSES.find(status => status.toLowerCase() === normalized);
            if (match) return match;
            return normalized.charAt(0).toUpperCase() + normalized.slice(1);
        }

        function getAdventureStatusClass(status) {
            switch (status) {
                case 'Completed':
                    return 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300';
                case 'Active':
                    return 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300';
                default:
                    return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-300';
            }
        }

        function showCreateCampaign() {
            const modal = document.getElementById('create-campaign-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideCreateCampaign() {
            const modal = document.getElementById('create-campaign-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('campaign-form').reset();
        }

        document.getElementById('campaign-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const name = document.getElementById('campaign-name').value.trim();
            if (!name) return;

            const campaign = {
                id: Date.now(),
                name,
                description: document.getElementById('campaign-description').value.trim(),
                createdAt: new Date().toLocaleDateString(),
                adventures: [],
                sessions: []
            };

            campaigns.push(campaign);
            saveCampaigns();
            renderCampaigns();
            hideCreateCampaign();
        });

        function renderCampaigns() {
            const container = document.getElementById('campaign-list');
            if (!container) return;

            if (campaigns.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No campaigns yet. Create one to organize your adventures.</p>';
                return;
            }

            container.innerHTML = campaigns.map(campaign => `
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 hover:shadow-lg transition cursor-pointer" onclick="showCampaignDetail(${campaign.id})">
                    <div class="flex justify-between items-start gap-3">
                        <div>
                            <h3 class="text-xl font-bold">${campaign.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 whitespace-pre-line">${campaign.description ? summarizeText(campaign.description, 220) : 'No description yet.'}</p>
                        </div>
                        <button onclick="event.stopPropagation(); deleteCampaign(${campaign.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                    </div>
                    <div class="mt-3 flex flex-wrap gap-3 text-xs text-gray-600 dark:text-gray-400">
                        <span>Adventures: ${campaign.adventures.length}</span>
                        <span>Session Logs: ${campaign.sessions.length}</span>
                        <span>Created: ${campaign.createdAt}</span>
                    </div>
                </div>
            `).join('');
        }

        function showCampaignDetail(id) {
            const campaign = campaigns.find(c => c.id === id);
            if (!campaign) return;

            activeCampaignId = id;
            document.getElementById('detail-campaign-name').textContent = campaign.name;

            const adventures = campaign.adventures.length > 0 ? campaign.adventures.map(adventure => `
                <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded border border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-start gap-3">
                        <div>
                            <div class="font-semibold">${adventure.name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Last updated: ${adventure.lastUpdated || 'Just now'}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${getAdventureStatusClass(adventure.status)}">${adventure.status}</span>
                            <button onclick="deleteAdventure(${campaign.id}, ${adventure.id})" class="text-red-500 hover:text-red-700 text-lg">&times;</button>
                        </div>
                    </div>
                    ${adventure.summary ? `<div class="prose prose-sm dark:prose-invert max-w-none mt-3">${renderMarkdown(adventure.summary)}</div>` : '<p class="italic text-sm text-gray-500 dark:text-gray-400 mt-3">No summary yet.</p>'}
                    <div class="mt-3 flex flex-wrap gap-2 text-xs">
                        <button onclick="showAdventureDetail(${campaign.id}, ${adventure.id})" class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90">View Detail</button>
                        <button onclick="advanceAdventureStatus(${campaign.id}, ${adventure.id})" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">Advance Status</button>
                    </div>
                </div>
            `).join('') : '<p class="text-sm text-gray-500 dark:text-gray-400">No adventures yet. Use "Add Adventure" to start building this campaign.</p>';

            const sessions = campaign.sessions.length > 0 ? campaign.sessions.map(session => `
                <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded border border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-semibold">${session.title}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${session.timestamp}</div>
                        </div>
                        <button onclick="deleteSessionLog(${campaign.id}, ${session.id})" class="text-red-500 hover:text-red-700 text-lg">&times;</button>
                    </div>
                    ${session.notes ? `<div class="prose prose-sm dark:prose-invert max-w-none mt-3">${renderMarkdown(session.notes)}</div>` : ''}
                </div>
            `).join('') : '<p class="text-sm text-gray-500 dark:text-gray-400">No session notes yet. Use "Log Session" to keep track of your adventures.</p>';

            document.getElementById('campaign-detail-content').innerHTML = `
                <div class="space-y-6 text-sm">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="addAdventure(${campaign.id})" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">+ Add Adventure</button>
                        <button onclick="addSessionLog(${campaign.id})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">+ Log Session</button>
                        <button onclick="editCampaignDescription(${campaign.id})" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">Edit Description</button>
                    </div>
                    <div>
                        <h4 class="font-bold mb-2">Campaign Overview</h4>
                        ${campaign.description ? `<div class="prose dark:prose-invert max-w-none">${renderMarkdown(campaign.description)}</div>` : '<p class="italic text-gray-500 dark:text-gray-400">No description provided yet.</p>'}
                    </div>
                    <div>
                        <h4 class="font-bold mb-2">Adventures</h4>
                        <div class="space-y-3">${adventures}</div>
                    </div>
                    <div>
                        <h4 class="font-bold mb-2">Session Log</h4>
                        <div class="space-y-3">${sessions}</div>
                    </div>
                </div>
            `;

            const modal = document.getElementById('campaign-detail-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideCampaignDetail() {
            if (activeAdventureId !== null) {
                hideAdventureDetail();
            }
            activeCampaignId = null;
            const modal = document.getElementById('campaign-detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function addAdventure(campaignId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            const name = await showCustomPrompt('Adventure name:');
            if (!name) return;

            const summary = await showTextareaPrompt({
                title: 'Adventure Summary',
                label: 'Describe the hooks, key locations, or important NPCs.',
                defaultValue: ''
            });
            if (summary === null) return;

            const statusInput = await showCustomPrompt('Adventure status (Planned, Active, Completed):', 'Planned');
            if (statusInput === null) return;

            campaign.adventures.push({
                id: Date.now(),
                name: name.trim(),
                summary,
                status: normalizeAdventureStatus(statusInput),
                lastUpdated: new Date().toLocaleString()
            });

            saveCampaigns();
            renderCampaigns();
            if (activeCampaignId === campaignId) {
                showCampaignDetail(campaignId);
            }
        }

        async function editCampaignDescription(campaignId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            const updated = await showTextareaPrompt({
                title: 'Edit Campaign Description',
                label: 'Share the tone, major factions, and overarching threats for this campaign.',
                defaultValue: campaign.description || ''
            });

            if (updated === null) return;

            campaign.description = updated;
            saveCampaigns();
            renderCampaigns();
            if (activeCampaignId === campaignId) {
                showCampaignDetail(campaignId);
            }
        }

        async function addSessionLog(campaignId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            const title = await showCustomPrompt('Session title:', `Session ${campaign.sessions.length + 1}`);
            if (!title) return;

            const notes = await showTextareaPrompt({
                title: 'Session Notes',
                label: 'Record highlights, treasure, NPCs met, and lasting consequences.',
                defaultValue: ''
            });

            if (notes === null) return;

            campaign.sessions.push({
                id: Date.now(),
                title: title.trim(),
                notes,
                timestamp: new Date().toLocaleString()
            });

            saveCampaigns();
            renderCampaigns();
            if (activeCampaignId === campaignId) {
                showCampaignDetail(campaignId);
            }
        }

        function deleteCampaign(id) {
            showCustomConfirm('Delete this campaign and all of its notes?', () => {
                campaigns = campaigns.filter(c => c.id !== id);
                saveCampaigns();
                renderCampaigns();
                if (activeCampaignId === id) {
                    if (activeAdventureId !== null) {
                        hideAdventureDetail();
                    }
                    hideCampaignDetail();
                }
            });
        }

        function deleteAdventure(campaignId, adventureId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            showCustomConfirm('Remove this adventure from the campaign?', () => {
                campaign.adventures = campaign.adventures.filter(a => a.id !== adventureId);
                saveCampaigns();
                renderCampaigns();
                if (activeCampaignId === campaignId) {
                    showCampaignDetail(campaignId);
                }
                if (activeAdventureId === adventureId) {
                    hideAdventureDetail();
                }
            });
        }

        function deleteSessionLog(campaignId, sessionId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            showCustomConfirm('Delete this session log?', () => {
                campaign.sessions = campaign.sessions.filter(s => s.id !== sessionId);
                saveCampaigns();
                renderCampaigns();
                if (activeCampaignId === campaignId) {
                    showCampaignDetail(campaignId);
                }
            });
        }

        function advanceAdventureStatus(campaignId, adventureId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            const adventure = campaign.adventures.find(a => a.id === adventureId);
            if (!adventure) return;

            const currentIndex = ADVENTURE_STATUSES.indexOf(adventure.status);
            const nextIndex = currentIndex >= 0 ? (currentIndex + 1) % ADVENTURE_STATUSES.length : 0;
            adventure.status = ADVENTURE_STATUSES[nextIndex];
            adventure.lastUpdated = new Date().toLocaleString();

            saveCampaigns();
            renderCampaigns();
            if (activeCampaignId === campaignId) {
                showCampaignDetail(campaignId);
            }
            if (activeAdventureId === adventureId) {
                showAdventureDetail(campaignId, adventureId);
            }
        }

        async function editAdventureSummary(campaignId, adventureId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            const adventure = campaign.adventures.find(a => a.id === adventureId);
            if (!adventure) return;

            const updated = await showTextareaPrompt({
                title: `Update notes for ${adventure.name}`,
                label: 'Summaries support Markdown for quick formatting.',
                defaultValue: adventure.summary || ''
            });

            if (updated === null) return;

            adventure.summary = updated;
            adventure.lastUpdated = new Date().toLocaleString();
            saveCampaigns();
            renderCampaigns();
            if (activeCampaignId === campaignId) {
                showCampaignDetail(campaignId);
            }
            if (activeAdventureId === adventureId) {
                showAdventureDetail(campaignId, adventureId);
            }
        }

        function showAdventureDetail(campaignId, adventureId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            const adventure = campaign.adventures.find(a => a.id === adventureId);
            if (!adventure) return;

            activeCampaignId = campaignId;
            activeAdventureId = adventureId;

            document.getElementById('detail-adventure-name').textContent = adventure.name;
            document.getElementById('adventure-detail-content').innerHTML = `
                <div class="space-y-4 text-sm">
                    <div class="flex flex-wrap items-center gap-3">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${getAdventureStatusClass(adventure.status)}">${adventure.status}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">Last updated: ${adventure.lastUpdated || 'Just now'}</span>
                    </div>
                    ${adventure.summary ? `<div class="prose dark:prose-invert max-w-none">${renderMarkdown(adventure.summary)}</div>` : '<p class="italic text-gray-500 dark:text-gray-400">No summary yet.</p>'}
                    <div class="flex flex-wrap gap-2">
                        <button onclick="advanceAdventureStatus(${campaign.id}, ${adventure.id})" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">Advance Status</button>
                        <button onclick="editAdventureSummary(${campaign.id}, ${adventure.id})" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">Edit Summary</button>
                    </div>
                </div>
            `;

            const modal = document.getElementById('adventure-detail-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideAdventureDetail() {
            activeAdventureId = null;
            const modal = document.getElementById('adventure-detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        document.getElementById('character-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const character = {
                id: Date.now(),
                name: document.getElementById('char-name').value,
                level: parseInt(document.getElementById('char-level').value),
                class: document.getElementById('char-class').value,
                str: parseInt(document.getElementById('char-str').value),
                agi: parseInt(document.getElementById('char-agi').value),
                sta: parseInt(document.getElementById('char-sta').value),
                per: parseInt(document.getElementById('char-per').value),
                int: parseInt(document.getElementById('char-int').value),
                luc: parseInt(document.getElementById('char-luc').value),
                hpMax: parseInt(document.getElementById('char-hp-max').value),
                hpCurrent: parseInt(document.getElementById('char-hp-current').value),
                ac: parseInt(document.getElementById('char-ac').value),
                speed: parseInt(document.getElementById('char-speed').value),
                equipment: document.getElementById('char-equipment').value
            };

            characters.push(character);
            saveCharacters();
            renderCharacters();
            hideCreateCharacter();
        });

        function renderCharacters() {
            const container = document.getElementById('character-list');

            if (characters.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-full">No characters yet. Create one to get started!</p>';
                return;
            }

            container.innerHTML = characters.map(char => `
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 hover:shadow-lg transition cursor-pointer" onclick="showCharacterDetail(${char.id})">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-xl font-bold">${char.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Level ${char.level} ${char.class}</p>
                        </div>
                        <button onclick="event.stopPropagation(); deleteCharacter(${char.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-sm mb-2">
                        <div>
                            <span class="font-semibold">HP:</span> ${char.hpCurrent}/${char.hpMax}
                        </div>
                        <div>
                            <span class="font-semibold">AC:</span> ${char.ac}
                        </div>
                        <div>
                            <span class="font-semibold">Speed:</span> ${char.speed}ft
                        </div>
                    </div>
                    <div class="grid grid-cols-6 gap-1 text-xs">
                        <div class="text-center">
                            <div class="font-semibold">STR</div>
                            <div>${char.str} <span class="stat-modifier">(${getModifier(char.str) >= 0 ? '+' : ''}${getModifier(char.str)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">AGI</div>
                            <div>${char.agi} <span class="stat-modifier">(${getModifier(char.agi) >= 0 ? '+' : ''}${getModifier(char.agi)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">STA</div>
                            <div>${char.sta} <span class="stat-modifier">(${getModifier(char.sta) >= 0 ? '+' : ''}${getModifier(char.sta)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">PER</div>
                            <div>${char.per} <span class="stat-modifier">(${getModifier(char.per) >= 0 ? '+' : ''}${getModifier(char.per)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">INT</div>
                            <div>${char.int} <span class="stat-modifier">(${getModifier(char.int) >= 0 ? '+' : ''}${getModifier(char.int)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">LUC</div>
                            <div>${char.luc} <span class="stat-modifier">(${getModifier(char.luc) >= 0 ? '+' : ''}${getModifier(char.luc)})</span></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCharacterDetail(id) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            document.getElementById('detail-char-name').textContent = char.name;

            const content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-semibold">Level:</span> ${char.level}</div>
                        <div><span class="font-semibold">Class:</span> ${char.class}</div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">HP</div>
                            <div class="text-2xl font-bold">${char.hpCurrent}/${char.hpMax}</div>
                            <div class="mt-2 flex gap-2">
                                <button onclick="adjustHP(${char.id}, -1)" class="flex-1 bg-red-500 text-white px-2 py-1 rounded text-sm">-</button>
                                <button onclick="adjustHP(${char.id}, 1)" class="flex-1 bg-green-500 text-white px-2 py-1 rounded text-sm">+</button>
                            </div>
                        </div>
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">AC</div>
                            <div class="text-2xl font-bold">${char.ac}</div>
                        </div>
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">Speed</div>
                            <div class="text-2xl font-bold">${char.speed}ft</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold mb-2">Ability Scores</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">STR</div>
                                <div class="text-xl">${char.str}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.str) >= 0 ? '+' : ''}${getModifier(char.str)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">AGI</div>
                                <div class="text-xl">${char.agi}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.agi) >= 0 ? '+' : ''}${getModifier(char.agi)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">STA</div>
                                <div class="text-xl">${char.sta}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.sta) >= 0 ? '+' : ''}${getModifier(char.sta)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">PER</div>
                                <div class="text-xl">${char.per}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.per) >= 0 ? '+' : ''}${getModifier(char.per)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">INT</div>
                                <div class="text-xl">${char.int}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.int) >= 0 ? '+' : ''}${getModifier(char.int)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">LUC</div>
                                <div class="text-xl">${char.luc}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.luc) >= 0 ? '+' : ''}${getModifier(char.luc)}</div>
                            </div>
                        </div>
                    </div>

                    ${char.equipment ? `
                    <div>
                        <h4 class="font-bold mb-2">Equipment & Notes</h4>
                        <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded whitespace-pre-wrap">${char.equipment}</div>
                    </div>
                    ` : ''}

                    <div class="flex gap-2">
                        <button onclick="addCharacterToCombat(${char.id})" class="flex-1 bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Add to Combat</button>
                        <button onclick="deleteCharacter(${char.id})" class="flex-1 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-base">Delete</button>
                    </div>
                </div>
            `;

            document.getElementById('character-detail-content').innerHTML = content;
            document.getElementById('character-detail-modal').classList.remove('hidden');
            document.getElementById('character-detail-modal').classList.add('flex');
        }

        function hideCharacterDetail() {
            document.getElementById('character-detail-modal').classList.add('hidden');
            document.getElementById('character-detail-modal').classList.remove('flex');
        }

        function adjustHP(id, amount) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            char.hpCurrent = Math.max(0, Math.min(char.hpMax, char.hpCurrent + amount));
            saveCharacters();
            renderCharacters();
            showCharacterDetail(id);
        }

        function deleteCharacter(id) {
            showCustomConfirm('Are you sure you want to delete this character?', () => {
                characters = characters.filter(c => c.id !== id);
                saveCharacters();
                const removed = combatants.filter(c => c.characterId === id);
                if (removed.length) {
                    combatants = combatants.filter(c => c.characterId !== id);
                    saveCombatants();
                    renderCombat();
                }
                renderCharacters();
                hideCharacterDetail();
            });
        }

        // Dice Roller
        function rollDice(sides) {
            const count = parseInt(document.getElementById('dice-count').value) || 1;
            const modifier = parseInt(document.getElementById('dice-modifier').value) || 0;
            const description = document.getElementById('roll-description').value;

            const rolls = [];
            let total = modifier;

            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }

            const result = {
                sides,
                count,
                rolls,
                modifier,
                total,
                description,
                timestamp: new Date().toLocaleTimeString()
            };

            rollHistory.unshift(result);
            if (rollHistory.length > 20) rollHistory.pop();

            saveRollHistory();
            displayRollResults();
        }

        function displayRollResults() {
            const container = document.getElementById('dice-results');

            if (rollHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Roll some dice to see results</p>';
                return;
            }

            const totals = rollHistory.map(r => r.total);
            const highest = Math.max(...totals);
            const average = (totals.reduce((sum, value) => sum + value, 0) / totals.length).toFixed(2);

            const stats = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-primary/20 mb-3">
                    <div class="flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-300">
                        <span><span class="font-semibold">Entries:</span> ${rollHistory.length}</span>
                        <span><span class="font-semibold">Average Total:</span> ${average}</span>
                        <span><span class="font-semibold">Highest Total:</span> ${highest}</span>
                    </div>
                </div>
            `;

            const history = rollHistory.map(r => `
                <div class="dice-result bg-white dark:bg-gray-800 p-4 rounded-lg border-l-4 border-primary">
                    ${r.description ? `<div class="font-semibold mb-1">${r.description}</div>` : ''}
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            ${r.count}d${r.sides}${r.modifier !== 0 ? (r.modifier > 0 ? '+' : '') + r.modifier : ''}
                            <span class="ml-2">[${r.rolls.join(', ')}]</span>
                        </div>
                        <div class="text-2xl font-bold text-primary">${r.total}</div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">${r.timestamp}</div>
                </div>
            `).join('');

            container.innerHTML = stats + history;
        }

        // Combat Tracker
        async function addCombatant() {
            const name = await showCustomPrompt('Enter combatant name:');
            if (!name) return;

            const initiativeInput = await showCustomPrompt('Enter initiative (or leave blank to roll):');
            const init = initiativeInput ? parseInt(initiativeInput) : Math.floor(Math.random() * 20) + 1;

            const hpInput = await showCustomPrompt('Enter HP:', '10');
            const acInput = await showCustomPrompt('Enter AC:', '10');

            combatants.push({
                id: Date.now(),
                name: name.trim(),
                initiative: init,
                hp: parseInt(hpInput) || 10,
                hpMax: parseInt(hpInput) || 10,
                ac: parseInt(acInput) || 10,
                isActive: false
            });

            saveCombatants();
            renderCombat();
        }

        function addCharacterToCombat(charId) {
            const char = characters.find(c => c.id === charId);
            if (!char) return;

            const initiative = Math.floor(Math.random() * 20) + 1 + getModifier(char.agi);

            combatants.push({
                id: Date.now(),
                name: char.name,
                initiative,
                hp: char.hpCurrent,
                hpMax: char.hpMax,
                ac: char.ac,
                isActive: false,
                characterId: charId
            });

            saveCombatants();
            renderCombat();
            hideCharacterDetail();
        }

        function sortInitiative() {
            combatants.sort((a, b) => b.initiative - a.initiative);
            if (combatants.length > 0) {
                combatants.forEach(c => c.isActive = false);
                combatants[0].isActive = true;
            }
            saveCombatants();
            renderCombat();
        }

        function renderCombat() {
            const container = document.getElementById('combat-list');
            document.getElementById('combat-round').textContent = combatRound;

            if (combatants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No combatants. Add characters or NPCs to begin combat.</p>';
                return;
            }

            container.innerHTML = combatants.map((c, index) => `
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg ${c.isActive ? 'ring-2 ring-primary' : ''}">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                ${c.isActive ? '<span class="text-primary text-2xl">▶</span>' : '<span class="text-2xl opacity-0">▶</span>'}
                                <div class="flex-1">
                                    <div class="font-bold text-lg">${c.name}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Initiative: ${c.initiative} | AC: ${c.ac}</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-600 dark:text-gray-400">HP</div>
                                <div class="font-bold ${c.hp <= 0 ? 'text-red-500' : ''}">${c.hp}/${c.hpMax}</div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="adjustCombatantHP(${c.id}, -1)" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-base">-</button>
                                <button onclick="adjustCombatantHP(${c.id}, 1)" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-base">+</button>
                            </div>
                            <button onclick="removeCombatant(${c.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function adjustCombatantHP(id, amount) {
            const combatant = combatants.find(c => c.id === id);
            if (!combatant) return;

            combatant.hp = Math.max(0, Math.min(combatant.hpMax, combatant.hp + amount));

            // Update character if linked
            if (combatant.characterId) {
                const char = characters.find(c => c.id === combatant.characterId);
                if (char) {
                    char.hpCurrent = combatant.hp;
                    saveCharacters();
                    renderCharacters();
                }
            }

            saveCombatants();
            renderCombat();
        }

        function removeCombatant(id) {
            combatants = combatants.filter(c => c.id !== id);
            saveCombatants();
            renderCombat();
        }

        function clearCombat() {
            showCustomConfirm('Clear all combatants?', () => {
                combatants = [];
                combatRound = 1;
                saveCombatants();
                saveCombatRound();
                document.getElementById('combat-round').textContent = combatRound;
                renderCombat();
            });
        }

        function nextRound() {
            combatRound++;
            document.getElementById('combat-round').textContent = combatRound;
            saveCombatRound();

            if (combatants.length > 0) {
                const currentIndex = combatants.findIndex(c => c.isActive);
                combatants.forEach(c => c.isActive = false);

                if (currentIndex < combatants.length - 1) {
                    combatants[currentIndex + 1].isActive = true;
                } else {
                    combatants[0].isActive = true;
                }

                saveCombatants();
                renderCombat();
            }
        }

        // Custom dialog functions
        function showCustomConfirm(message, onConfirm) {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                            <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded text-base">Confirm</button>
                        </div>
                    </div>
                `;

                const cleanup = (confirmed) => {
                    modal.remove();
                    if (confirmed && typeof onConfirm === 'function') {
                        onConfirm();
                    }
                    resolve(confirmed);
                };

                modal.querySelector('.cancel-btn').onclick = () => cleanup(false);
                modal.querySelector('.confirm-btn').onclick = () => cleanup(true);

                document.body.appendChild(modal);
            });
        }

        function showCustomPrompt(message, defaultValue = '') {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                        <input type="text" class="prompt-input w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 mb-4 text-base" value="${defaultValue ?? ''}">
                        <div class="flex justify-end space-x-3">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                            <button class="ok-btn px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded text-base">OK</button>
                        </div>
                    </div>
                `;

                const input = modal.querySelector('.prompt-input');
                const close = (value) => {
                    modal.remove();
                    resolve(value);
                };

                modal.querySelector('.cancel-btn').onclick = () => close(null);
                modal.querySelector('.ok-btn').onclick = () => close(input.value.trim());
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') close(input.value.trim());
                });

                document.body.appendChild(modal);
                input.focus();
                input.select();
            });
        }

        function showTextareaPrompt({ title, label, defaultValue = '' }) {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4">
                        <h3 class="text-xl font-bold mb-4">${title}</h3>
                        <label class="block mb-2 font-semibold">${label}</label>
                        <textarea class="rich-input w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base min-h-[160px]">${defaultValue ?? ''}</textarea>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                            <button class="ok-btn px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded text-base">Save</button>
                        </div>
                    </div>
                `;

                const textarea = modal.querySelector('.rich-input');
                const close = (value) => {
                    modal.remove();
                    resolve(value);
                };

                modal.querySelector('.cancel-btn').onclick = () => close(null);
                modal.querySelector('.ok-btn').onclick = () => close(textarea.value.trim());

                document.body.appendChild(modal);
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            });
        }

        // Initialize
        renderCharacters();
        renderCombat();
        renderCampaigns();
        displayRollResults();
    </script>


</body></html>