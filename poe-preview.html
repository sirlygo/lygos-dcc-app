<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCC Virtual Tabletop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .dice-result {
            animation: rollIn 0.3s ease-out;
        }
        @keyframes rollIn {
            from {
                transform: scale(0.5) rotate(180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        .tab-active {
            border-bottom: 3px solid #5D5CDE;
            color: #5D5CDE;
        }
        .stat-modifier {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen transition-colors">
    <div class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-2">DCC Virtual Tabletop</h1>
            <p class="text-center text-gray-600 dark:text-gray-400">Dungeon Crawl Classics RPG</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="border-b border-gray-300 dark:border-gray-700 mb-6">
            <ul class="flex flex-wrap -mb-px text-sm md:text-base">
                <li class="mr-2">
                    <button onclick="switchTab('characters')" id="tab-characters" class="tab-active inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Characters</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('dice')" id="tab-dice" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Dice Roller</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('combat')" id="tab-combat" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Combat Tracker</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('tables')" id="tab-tables" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Reference Tables</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('campaigns')" id="tab-campaigns" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Campaigns</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('ai')" id="tab-ai" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">AI Tools</button>
                </li>
            </ul>
        </nav>

        <!-- Tab Content -->
        <div id="content-characters" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Characters</h2>
                <button onclick="showCreateCharacter()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ New Character</button>
            </div>
            <div id="character-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Characters will be added here -->
            </div>
        </div>

        <div id="content-dice" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Dice Roller</h2>
            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 mb-6">
                <div class="grid grid-cols-4 md:grid-cols-7 gap-2 mb-4">
                    <button onclick="rollDice(3)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d3</button>
                    <button onclick="rollDice(4)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d4</button>
                    <button onclick="rollDice(5)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d5</button>
                    <button onclick="rollDice(6)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d6</button>
                    <button onclick="rollDice(7)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d7</button>
                    <button onclick="rollDice(8)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d8</button>
                    <button onclick="rollDice(10)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d10</button>
                    <button onclick="rollDice(12)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d12</button>
                    <button onclick="rollDice(14)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d14</button>
                    <button onclick="rollDice(16)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d16</button>
                    <button onclick="rollDice(20)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d20</button>
                    <button onclick="rollDice(24)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d24</button>
                    <button onclick="rollDice(30)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d30</button>
                    <button onclick="rollDice(100)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d%</button>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Modifier</label>
                    <input type="number" id="dice-modifier" value="0" class="w-full md:w-48 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Number of Dice</label>
                    <input type="number" id="dice-count" value="1" min="1" max="20" class="w-full md:w-48 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Roll Description (optional)</label>
                    <input type="text" id="roll-description" placeholder="e.g., Attack roll, Saving throw" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Roll Results</h3>
                <div id="dice-results" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 dark:text-gray-400 text-center py-8">Roll some dice to see results</p>
                </div>
            </div>
        </div>

        <div id="content-combat" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Combat Tracker</h2>
                <div class="flex gap-2">
                    <button onclick="addCombatant()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ Add Combatant</button>
                    <button onclick="sortInitiative()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-base">Sort Initiative</button>
                    <button onclick="clearCombat()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-base">Clear All</button>
                </div>
            </div>

            <div class="mb-4 bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                <div class="flex items-center gap-4">
                    <div>
                        <label class="font-semibold">Round:</label>
                        <span id="combat-round" class="ml-2 text-xl font-bold text-primary">1</span>
                    </div>
                    <button onclick="nextRound()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Next Round</button>
                </div>
            </div>

            <div id="combat-list" class="space-y-2">
                <!-- Combat entries will be added here -->
            </div>
        </div>

        <div id="content-tables" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Reference Tables</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Critical Hit Table -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Critical Hits (d20)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-16">1-6:</span><span>Normal damage</span></div>
                        <div class="flex"><span class="font-bold w-16">7-11:</span><span>+1d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">12-13:</span><span>+2d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">14-15:</span><span>+3d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">16-17:</span><span>+1d10 damage + bleed 1d6</span></div>
                        <div class="flex"><span class="font-bold w-16">18:</span><span>+2d10 damage + bleed 1d6</span></div>
                        <div class="flex"><span class="font-bold w-16">19:</span><span>+3d10 damage + bleed 2d6</span></div>
                        <div class="flex"><span class="font-bold w-16">20:</span><span>+4d10 damage + limb/organ damage</span></div>
                    </div>
                </div>

                <!-- Fumble Table -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Fumbles (d8)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">1:</span><span>Drop weapon</span></div>
                        <div class="flex"><span class="font-bold w-12">2:</span><span>Slip, lose next action</span></div>
                        <div class="flex"><span class="font-bold w-12">3:</span><span>Twist ankle, -5 ft movement</span></div>
                        <div class="flex"><span class="font-bold w-12">4:</span><span>Stumble, foe gets free attack</span></div>
                        <div class="flex"><span class="font-bold w-12">5:</span><span>Hit ally for normal damage</span></div>
                        <div class="flex"><span class="font-bold w-12">6:</span><span>Weapon stuck, DC 10 STR to free</span></div>
                        <div class="flex"><span class="font-bold w-12">7:</span><span>Armor strap breaks, -1 AC</span></div>
                        <div class="flex"><span class="font-bold w-12">8:</span><span>Weapon damaged, -1 to hit</span></div>
                    </div>
                </div>

                <!-- Ability Score Modifiers -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Ability Score Modifiers</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">3:</span><span>-3</span></div>
                        <div class="flex"><span class="font-bold w-12">4-5:</span><span>-2</span></div>
                        <div class="flex"><span class="font-bold w-12">6-8:</span><span>-1</span></div>
                        <div class="flex"><span class="font-bold w-12">9-12:</span><span>0</span></div>
                        <div class="flex"><span class="font-bold w-12">13-15:</span><span>+1</span></div>
                        <div class="flex"><span class="font-bold w-12">16-17:</span><span>+2</span></div>
                        <div class="flex"><span class="font-bold w-12">18:</span><span>+3</span></div>
                    </div>
                </div>

                <!-- Luck Uses -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Luck Uses</h3>
                    <div class="space-y-2 text-sm">
                        <div>• Add/subtract from any roll (before or after)</div>
                        <div>• Improve critical hit/fumble results</div>
                        <div>• Modify initiative</div>
                        <div>• Find lucky items or gold</div>
                        <div>• Avoid death (at Judge's discretion)</div>
                        <div class="pt-2 italic">Luck spent is permanent unless restored</div>
                    </div>
                </div>

                <!-- Action Dice -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Action Dice by Level</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-20">Level 1-4:</span><span>1d20</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 5:</span><span>1d20 + 1d14</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 6-7:</span><span>1d20 + 1d16</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 8-9:</span><span>1d20 + 1d20</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 10:</span><span>1d20 + 1d20 + 1d14</span></div>
                        <div class="pt-2 italic text-xs">Warriors gain bonus action dice at higher levels</div>
                    </div>
                </div>

                <!-- Spell Corruption -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Spell Corruption (d10)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">1:</span><span>Eyes glow when casting</span></div>
                        <div class="flex"><span class="font-bold w-12">2:</span><span>Hair turns white/silver</span></div>
                        <div class="flex"><span class="font-bold w-12">3:</span><span>Skin becomes pale/ashen</span></div>
                        <div class="flex"><span class="font-bold w-12">4:</span><span>Fingernails turn black</span></div>
                        <div class="flex"><span class="font-bold w-12">5:</span><span>Voice becomes raspy</span></div>
                        <div class="flex"><span class="font-bold w-12">6:</span><span>Minor temperature change around caster</span></div>
                        <div class="flex"><span class="font-bold w-12">7:</span><span>Smell of brimstone/ozone</span></div>
                        <div class="flex"><span class="font-bold w-12">8:</span><span>Small horns sprout</span></div>
                        <div class="flex"><span class="font-bold w-12">9:</span><span>Shadow moves independently</span></div>
                        <div class="flex"><span class="font-bold w-12">10:</span><span>Magical runes appear on skin</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-campaigns" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Campaigns</h2>
                <button onclick="showCreateCampaign()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ New Campaign</button>
            </div>
            <div id="campaign-list" class="grid grid-cols-1 gap-4">
                <!-- Campaigns will be added here -->
            </div>
        </div>

        <div id="content-ai" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-2">AI Tools & Inspiration</h2>
                <p class="text-gray-600 dark:text-gray-400 max-w-3xl">Use these smart generators to quickly spark story hooks, deepen your characters, and analyze your party's strengths without leaving the tabletop.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 shadow-sm">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold">Character Backstory Builder</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Blend a quick prompt with evocative origins, motivations, and quirks.</p>
                        </div>
                        <button onclick="copyAIResult('backstory')" class="text-primary hover:text-primary/80 text-sm font-semibold">Copy</button>
                    </div>
                    <label class="block text-sm font-semibold mb-2" for="ai-backstory-prompt">Prompt (optional)</label>
                    <input id="ai-backstory-prompt" type="text" placeholder="ex: Cowardly wizard who loves fireworks" class="w-full mb-4 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                    <button onclick="runAIGenerator('backstory')" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Generate Backstory</button>
                    <div id="ai-backstory-output" class="mt-4 text-sm text-gray-700 dark:text-gray-200 space-y-2">
                        <p class="text-gray-500 dark:text-gray-400">Your generated backstory will appear here.</p>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 shadow-sm">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold">Adventure Seed Studio</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Generate hooks with twists, memorable locations, and rewards.</p>
                        </div>
                        <button onclick="copyAIResult('adventure')" class="text-primary hover:text-primary/80 text-sm font-semibold">Copy</button>
                    </div>
                    <label class="block text-sm font-semibold mb-2" for="ai-adventure-prompt">Theme (optional)</label>
                    <input id="ai-adventure-prompt" type="text" placeholder="ex: Haunted moor with cursed treasure" class="w-full mb-4 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                    <button onclick="runAIGenerator('adventure')" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Generate Adventure Seed</button>
                    <div id="ai-adventure-output" class="mt-4 text-sm text-gray-700 dark:text-gray-200 space-y-2">
                        <p class="text-gray-500 dark:text-gray-400">Need a spark? Generate an adventure hook above.</p>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 shadow-sm">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold">Prophecy & Treasure Oracle</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Reveal omens, rumors, and wondrous loot to pepper into your sessions.</p>
                        </div>
                        <button onclick="copyAIResult('prophecy')" class="text-primary hover:text-primary/80 text-sm font-semibold">Copy</button>
                    </div>
                    <label class="block text-sm font-semibold mb-2" for="ai-prophecy-prompt">Focus (optional)</label>
                    <input id="ai-prophecy-prompt" type="text" placeholder="ex: Signs of an awakening demon" class="w-full mb-4 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                    <button onclick="runAIGenerator('prophecy')" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Reveal Prophecy</button>
                    <div id="ai-prophecy-output" class="mt-4 text-sm text-gray-700 dark:text-gray-200 space-y-2">
                        <p class="text-gray-500 dark:text-gray-400">Prophecies and treasures will reveal themselves here.</p>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 shadow-sm">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold">Party Insight Analyst</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Scan your saved characters for tactical recommendations.</p>
                        </div>
                        <button onclick="copyAIResult('party')" class="text-primary hover:text-primary/80 text-sm font-semibold">Copy</button>
                    </div>
                    <button onclick="runAIGenerator('party')" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Analyze Party</button>
                    <div id="ai-party-output" class="mt-4 text-sm text-gray-700 dark:text-gray-200 space-y-2">
                        <p class="text-gray-500 dark:text-gray-400">Analyze your saved characters to receive tactical insights.</p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">Recent AI Inspiration</h3>
                    <button onclick="clearAIHistory()" class="text-sm text-gray-500 hover:text-gray-300">Clear</button>
                </div>
                <div id="ai-history" class="space-y-4 text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div id="create-campaign-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Create Campaign</h3>
                <form id="campaign-form" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Campaign Name</label>
                        <input type="text" id="campaign-name" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Campaign Description</label>
                        <textarea id="campaign-description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="hideCreateCampaign()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-base">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-base">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Campaign Detail Modal -->
    <div id="campaign-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-campaign-name"></h3>
                    <button onclick="hideCampaignDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="campaign-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Adventure Detail Modal -->
    <div id="adventure-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-adventure-name"></h3>
                    <button onclick="hideAdventureDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="adventure-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div id="create-character-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Create Character</h3>
                <form id="character-form" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Name</label>
                        <input type="text" id="char-name" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">Level</label>
                            <input type="number" id="char-level" value="0" min="0" max="10" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Class</label>
                            <select id="char-class" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                                <option value="Peasant">0-Level (Peasant)</option>
                                <option value="Warrior">Warrior</option>
                                <option value="Wizard">Wizard</option>
                                <option value="Cleric">Cleric</option>
                                <option value="Thief">Thief</option>
                                <option value="Dwarf">Dwarf</option>
                                <option value="Elf">Elf</option>
                                <option value="Halfling">Halfling</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">STR</label>
                            <input type="number" id="char-str" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">AGI</label>
                            <input type="number" id="char-agi" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">STA</label>
                            <input type="number" id="char-sta" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">PER</label>
                            <input type="number" id="char-per" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">INT</label>
                            <input type="number" id="char-int" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">LUC</label>
                            <input type="number" id="char-luc" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">HP (Max)</label>
                            <input type="number" id="char-hp-max" value="4" min="1" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Current HP</label>
                            <input type="number" id="char-hp-current" value="4" min="0" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">AC</label>
                            <input type="number" id="char-ac" value="10" min="1" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Speed</label>
                            <input type="number" id="char-speed" value="30" min="0" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block mb-2 font-semibold">Equipment/Notes</label>
                        <textarea id="char-equipment" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base"></textarea>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="hideCreateCharacter()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-base">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-base">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Character Detail Modal -->
    <div id="character-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-char-name"></h3>
                    <button onclick="hideCharacterDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="character-detail-content"></div>
            </div>
        </div>
    </div>

    <div id="ai-toast" class="fixed bottom-6 right-6 px-4 py-2 rounded shadow-lg text-white text-sm font-semibold hidden"></div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data storage (in-memory)
        let characters = [];
        let combatants = [];
        let combatRound = 1;
        let rollHistory = [];
        let aiHistory = [];
        let aiState = {
            backstory: '',
            adventure: '',
            prophecy: '',
            party: ''
        };
        let aiToastTimeout;

        // Tab switching
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('tab-active'));

            // Show selected tab
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('tab-active');
        }

        // Calculate ability modifier
        function getModifier(score) {
            if (score <= 3) return -3;
            if (score <= 5) return -2;
            if (score <= 8) return -1;
            if (score <= 12) return 0;
            if (score <= 15) return 1;
            if (score <= 17) return 2;
            return 3;
        }

        // Character Management
        function showCreateCharacter() {
            document.getElementById('create-character-modal').classList.remove('hidden');
            document.getElementById('create-character-modal').classList.add('flex');
        }

        function hideCreateCharacter() {
            document.getElementById('create-character-modal').classList.add('hidden');
            document.getElementById('create-character-modal').classList.remove('flex');
            document.getElementById('character-form').reset();
        }

        document.getElementById('character-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const character = {
                id: Date.now(),
                name: document.getElementById('char-name').value,
                level: parseInt(document.getElementById('char-level').value),
                class: document.getElementById('char-class').value,
                str: parseInt(document.getElementById('char-str').value),
                agi: parseInt(document.getElementById('char-agi').value),
                sta: parseInt(document.getElementById('char-sta').value),
                per: parseInt(document.getElementById('char-per').value),
                int: parseInt(document.getElementById('char-int').value),
                luc: parseInt(document.getElementById('char-luc').value),
                hpMax: parseInt(document.getElementById('char-hp-max').value),
                hpCurrent: parseInt(document.getElementById('char-hp-current').value),
                ac: parseInt(document.getElementById('char-ac').value),
                speed: parseInt(document.getElementById('char-speed').value),
                equipment: document.getElementById('char-equipment').value
            };

            characters.push(character);
            renderCharacters();
            hideCreateCharacter();
        });

        function renderCharacters() {
            const container = document.getElementById('character-list');

            if (characters.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-full">No characters yet. Create one to get started!</p>';
                refreshPartyInsights();
                return;
            }

            container.innerHTML = characters.map(char => `
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 hover:shadow-lg transition cursor-pointer" onclick="showCharacterDetail(${char.id})">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-xl font-bold">${char.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Level ${char.level} ${char.class}</p>
                        </div>
                        <button onclick="event.stopPropagation(); deleteCharacter(${char.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-sm mb-2">
                        <div>
                            <span class="font-semibold">HP:</span> ${char.hpCurrent}/${char.hpMax}
                        </div>
                        <div>
                            <span class="font-semibold">AC:</span> ${char.ac}
                        </div>
                        <div>
                            <span class="font-semibold">Speed:</span> ${char.speed}ft
                        </div>
                    </div>
                    <div class="grid grid-cols-6 gap-1 text-xs">
                        <div class="text-center">
                            <div class="font-semibold">STR</div>
                            <div>${char.str} <span class="stat-modifier">(${getModifier(char.str) >= 0 ? '+' : ''}${getModifier(char.str)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">AGI</div>
                            <div>${char.agi} <span class="stat-modifier">(${getModifier(char.agi) >= 0 ? '+' : ''}${getModifier(char.agi)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">STA</div>
                            <div>${char.sta} <span class="stat-modifier">(${getModifier(char.sta) >= 0 ? '+' : ''}${getModifier(char.sta)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">PER</div>
                            <div>${char.per} <span class="stat-modifier">(${getModifier(char.per) >= 0 ? '+' : ''}${getModifier(char.per)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">INT</div>
                            <div>${char.int} <span class="stat-modifier">(${getModifier(char.int) >= 0 ? '+' : ''}${getModifier(char.int)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">LUC</div>
                            <div>${char.luc} <span class="stat-modifier">(${getModifier(char.luc) >= 0 ? '+' : ''}${getModifier(char.luc)})</span></div>
                        </div>
                    </div>
                </div>
            `).join('');

            refreshPartyInsights();
        }

        function showCharacterDetail(id) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            document.getElementById('detail-char-name').textContent = char.name;

            const content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-semibold">Level:</span> ${char.level}</div>
                        <div><span class="font-semibold">Class:</span> ${char.class}</div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">HP</div>
                            <div class="text-2xl font-bold">${char.hpCurrent}/${char.hpMax}</div>
                            <div class="mt-2 flex gap-2">
                                <button onclick="adjustHP(${char.id}, -1)" class="flex-1 bg-red-500 text-white px-2 py-1 rounded text-sm">-</button>
                                <button onclick="adjustHP(${char.id}, 1)" class="flex-1 bg-green-500 text-white px-2 py-1 rounded text-sm">+</button>
                            </div>
                        </div>
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">AC</div>
                            <div class="text-2xl font-bold">${char.ac}</div>
                        </div>
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">Speed</div>
                            <div class="text-2xl font-bold">${char.speed}ft</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold mb-2">Ability Scores</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">STR</div>
                                <div class="text-xl">${char.str}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.str) >= 0 ? '+' : ''}${getModifier(char.str)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">AGI</div>
                                <div class="text-xl">${char.agi}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.agi) >= 0 ? '+' : ''}${getModifier(char.agi)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">STA</div>
                                <div class="text-xl">${char.sta}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.sta) >= 0 ? '+' : ''}${getModifier(char.sta)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">PER</div>
                                <div class="text-xl">${char.per}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.per) >= 0 ? '+' : ''}${getModifier(char.per)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">INT</div>
                                <div class="text-xl">${char.int}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.int) >= 0 ? '+' : ''}${getModifier(char.int)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">LUC</div>
                                <div class="text-xl">${char.luc}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.luc) >= 0 ? '+' : ''}${getModifier(char.luc)}</div>
                            </div>
                        </div>
                    </div>

                    ${char.equipment ? `
                    <div>
                        <h4 class="font-bold mb-2">Equipment & Notes</h4>
                        <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded whitespace-pre-wrap">${char.equipment}</div>
                    </div>
                    ` : ''}

                    <div class="flex gap-2">
                        <button onclick="addCharacterToCombat(${char.id})" class="flex-1 bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Add to Combat</button>
                        <button onclick="deleteCharacter(${char.id})" class="flex-1 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-base">Delete</button>
                    </div>
                </div>
            `;

            document.getElementById('character-detail-content').innerHTML = content;
            document.getElementById('character-detail-modal').classList.remove('hidden');
            document.getElementById('character-detail-modal').classList.add('flex');
        }

        function hideCharacterDetail() {
            document.getElementById('character-detail-modal').classList.add('hidden');
            document.getElementById('character-detail-modal').classList.remove('flex');
        }

        function adjustHP(id, amount) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            char.hpCurrent = Math.max(0, Math.min(char.hpMax, char.hpCurrent + amount));
            renderCharacters();
            showCharacterDetail(id);
        }

        function deleteCharacter(id) {
            showCustomConfirm('Are you sure you want to delete this character?', () => {
                characters = characters.filter(c => c.id !== id);
                renderCharacters();
                hideCharacterDetail();
            });
        }

        // Dice Roller
        function rollDice(sides) {
            const count = parseInt(document.getElementById('dice-count').value) || 1;
            const modifier = parseInt(document.getElementById('dice-modifier').value) || 0;
            const description = document.getElementById('roll-description').value;

            const rolls = [];
            let total = modifier;

            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }

            const result = {
                sides,
                count,
                rolls,
                modifier,
                total,
                description,
                timestamp: new Date().toLocaleTimeString()
            };

            rollHistory.unshift(result);
            if (rollHistory.length > 20) rollHistory.pop();

            displayRollResults();
        }

        function displayRollResults() {
            const container = document.getElementById('dice-results');

            if (rollHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Roll some dice to see results</p>';
                return;
            }

            container.innerHTML = rollHistory.map(r => `
                <div class="dice-result bg-white dark:bg-gray-800 p-4 rounded-lg border-l-4 border-primary">
                    ${r.description ? `<div class="font-semibold mb-1">${r.description}</div>` : ''}
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            ${r.count}d${r.sides}${r.modifier !== 0 ? (r.modifier > 0 ? '+' : '') + r.modifier : ''}
                            <span class="ml-2">[${r.rolls.join(', ')}]</span>
                        </div>
                        <div class="text-2xl font-bold text-primary">${r.total}</div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">${r.timestamp}</div>
                </div>
            `).join('');
        }

        // Combat Tracker
        function addCombatant() {
            const name = showCustomPrompt('Enter combatant name:');
            if (!name) return;

            const initiative = showCustomPrompt('Enter initiative (or leave blank to roll):');
            const init = initiative ? parseInt(initiative) : Math.floor(Math.random() * 20) + 1;

            const hp = showCustomPrompt('Enter HP:', '10');
            const ac = showCustomPrompt('Enter AC:', '10');

            combatants.push({
                id: Date.now(),
                name,
                initiative: init,
                hp: parseInt(hp) || 10,
                hpMax: parseInt(hp) || 10,
                ac: parseInt(ac) || 10,
                isActive: false
            });

            renderCombat();
        }

        function addCharacterToCombat(charId) {
            const char = characters.find(c => c.id === charId);
            if (!char) return;

            const initiative = Math.floor(Math.random() * 20) + 1 + getModifier(char.agi);

            combatants.push({
                id: Date.now(),
                name: char.name,
                initiative,
                hp: char.hpCurrent,
                hpMax: char.hpMax,
                ac: char.ac,
                isActive: false,
                characterId: charId
            });

            renderCombat();
            hideCharacterDetail();
        }

        function sortInitiative() {
            combatants.sort((a, b) => b.initiative - a.initiative);
            if (combatants.length > 0) {
                combatants.forEach(c => c.isActive = false);
                combatants[0].isActive = true;
            }
            renderCombat();
        }

        function renderCombat() {
            const container = document.getElementById('combat-list');

            if (combatants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No combatants. Add characters or NPCs to begin combat.</p>';
                return;
            }

            container.innerHTML = combatants.map((c, index) => `
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg ${c.isActive ? 'ring-2 ring-primary' : ''}">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                ${c.isActive ? '<span class="text-primary text-2xl">▶</span>' : '<span class="text-2xl opacity-0">▶</span>'}
                                <div class="flex-1">
                                    <div class="font-bold text-lg">${c.name}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Initiative: ${c.initiative} | AC: ${c.ac}</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-600 dark:text-gray-400">HP</div>
                                <div class="font-bold ${c.hp <= 0 ? 'text-red-500' : ''}">${c.hp}/${c.hpMax}</div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="adjustCombatantHP(${c.id}, -1)" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-base">-</button>
                                <button onclick="adjustCombatantHP(${c.id}, 1)" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-base">+</button>
                            </div>
                            <button onclick="removeCombatant(${c.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function adjustCombatantHP(id, amount) {
            const combatant = combatants.find(c => c.id === id);
            if (!combatant) return;

            combatant.hp = Math.max(0, Math.min(combatant.hpMax, combatant.hp + amount));

            // Update character if linked
            if (combatant.characterId) {
                const char = characters.find(c => c.id === combatant.characterId);
                if (char) {
                    char.hpCurrent = combatant.hp;
                    renderCharacters();
                }
            }

            renderCombat();
        }

        function removeCombatant(id) {
            combatants = combatants.filter(c => c.id !== id);
            renderCombat();
        }

        function clearCombat() {
            showCustomConfirm('Clear all combatants?', () => {
                combatants = [];
                combatRound = 1;
                document.getElementById('combat-round').textContent = combatRound;
                renderCombat();
            });
        }

        function nextRound() {
            combatRound++;
            document.getElementById('combat-round').textContent = combatRound;

            if (combatants.length > 0) {
                const currentIndex = combatants.findIndex(c => c.isActive);
                combatants.forEach(c => c.isActive = false);

                if (currentIndex < combatants.length - 1) {
                    combatants[currentIndex + 1].isActive = true;
                } else {
                    combatants[0].isActive = true;
                }

                renderCombat();
            }
        }

        // AI Tools & Inspiration
        const aiTables = {
            origins: [
                "among traveling caravan storytellers",
                "in the shadow of a shattered citadel",
                "within a remote coastal hamlet that trades with spirits",
                "beneath colossal mushrooms in the Glowfen Marsh",
                "inside a mountain library guarded by taciturn dwarves",
                "on the decks of a storm-chasing privateer fleet",
                "at an abbey that charts constellations and prophecies",
                "in a bustling market built around a petrified titan",
                "deep in the borderlands where the wild hunt rides",
                "within a forgotten village that worships luck incarnate"
            ],
            training: [
                "learned to read omens dancing in campfires",
                "studied forbidden dueling forms with a reclusive mentor",
                "mapped ley lines while apprenticing to a hedge wizard",
                "mastered hardy survival tactics from caravan outriders",
                "served as an archivist who copied crumbling battle journals",
                "honed quick hands picking the purses of careless nobles",
                "kept the peace as a mediator among rival merchant houses",
                "trained beasts great and small to answer whispered commands",
                "learned sacred chants that mend wounds and calm spirits",
                "crafted clockwork curios that smuggle hidden blades"
            ],
            definingEvents: [
                "a comet split the night sky and whispered their true name",
                "bandits razed their home, leaving only a sigil scorched into stone",
                "a patron saint spoke through a dream of swirling gears",
                "an ancient relic opened and flooded them with distant memories",
                "their dearest friend vanished chasing a rumor of a golden door",
                "a duel gone wrong bound their fate to a grieving rival",
                "they navigated a labyrinth and emerged with time lost but wisdom gained",
                "a plague spared them yet etched glowing runes across their skin",
                "their ship was pulled beneath the sea and returned a day before it sank",
                "they witnessed a demon bargain for the moon's reflection"
            ],
            motivations: [
                "protect the scattered survivors of their clan",
                "prove that destiny can be rewritten through stubborn heroism",
                "reclaim an heirloom blade that chooses its bearer",
                "unlock the secret language hidden inside battle hymns",
                "track the architect of the sigil that ruined their home",
                "earn glory enough to found a sanctuary for wayward souls",
                "perfect a daring spell that stitches light and shadow",
                "help their lost friend find peace, even beyond the veil",
                "restore balance to a region cursed by gambling with fate",
                "dismantle the cabal that twists prophecy for profit"
            ],
            secrets: [
                "Haunted by a bargain they accidentally struck with a minor chaos lord",
                "Still carries the last letter from an enemy who saved their life",
                "Hides a shard of living crystal that hums when danger is near",
                "Believes a whispered voice guides their steps—and sometimes lies",
                "Knows the location of a hidden gate but fears what waits beyond",
                "Shelters a cursed song that can topple city walls if sung aloud",
                "Owes a life-debt to a witch who demands uncomfortable favors",
                "Keeps quiet about a prophecy declaring they will betray a friend",
                "Fears the moonlight will reveal their shadow moving on its own",
                "Carries an unspent luck token that exacts a price when flipped"
            ],
            quirks: [
                "Collects small clockwork trinkets and dismantles them when anxious",
                "Always hums battle hymns before rolling initiative",
                "Sketches everyone they meet in a tattered field journal",
                "Insists on sharing fortunes drawn from handmade tarot shells",
                "Keeps a pocketful of salted caramel for bargaining with fey",
                "Argues tactical points with an invisible 'captain' on their shoulder",
                "Offers heartfelt toasts to celebrate even minor victories",
                "Can fall asleep anywhere but startles awake if silence lasts too long",
                "Writes letters to future versions of the party after each adventure",
                "Sees constellations in campfire sparks and names them aloud"
            ],
            patrons: [
                "a retired judge who now runs a hidden scriptorium",
                "an ambitious demon-hunter seeking tactical allies",
                "a secretive circle of scholars who monitor wild magic",
                "a talking raven that relays the will of the Queen Below",
                "a dwarven quartermaster financing expeditions into ruins",
                "an oracle child whose visions demand careful interpretation",
                "a spectral captain that trades guidance for unfinished business",
                "a guild of mapmakers eager to chart forbidden territories",
                "a cabal of healers preserving relics of saints and sinners",
                "an ancient treant that barters knowledge for stories"
            ],
            adventureLocations: [
                "the drowned halls beneath the bell towers of Highwater",
                "a fungal forest that migrates between planes each solstice",
                "the rusted spine of a colossal war machine half-buried in dunes",
                "a market carved into the ribs of a fossilized leviathan",
                "storm-wreathed cliffs where shrines cling like barnacles",
                "a moonlit orchard that blooms with memories instead of fruit",
                "the whispering vaults below the Archivists' Collegium",
                "a border fort that swaps reality with its mirror twin at dawn",
                "mist-shrouded catacombs accessible only during eclipses",
                "the basalt citadel that crowns the Endless Stair"
            ],
            adventureObjectives: [
                "retrieve the soulbound key before the eclipse reaches zenith",
                "seal the rift leaking memories into the waking world",
                "escort a reluctant oracle to witness their destined vision",
                "liberate captives bound inside living crystal sarcophagi",
                "win the favor of an ancient spirit to avert a brewing war",
                "track a rogue judge manipulating the laws of chance",
                "steal back a relic that rewrites oaths spoken nearby",
                "stop a cult from stitching a demon into the city's clockwork",
                "rescue a caravan bearing the last seeds of a sacred grove",
                "outwit a tyrant's tournament that awards cursed boons"
            ],
            adventureComplications: [
                "The local militia hunts the same prize to fund a siege",
                "Weather turns the ground into a labyrinth of shifting mirrors",
                "An old ally leads the opposition under magical coercion",
                "A rival adventuring band spreads misinformation for clout",
                "Ancient wards demand a toll of treasured memories",
                "The area awakens constructs that copy the heroes' abilities",
                "Time loops reset progress unless specific rites are honored",
                "A protective spirit insists the heroes solve a moral dilemma first",
                "A volatile planar bleed rearranges the map every hour",
                "Unstable magic mutates mundane equipment into unpredictable forms"
            ],
            adventureTwists: [
                "The villain is a future echo of one party member",
                "The relic hides a benevolent entity seeking liberation",
                "Completing the quest crowns the heroes as reluctant stewards",
                "The supposed threat shields the region from a worse calamity",
                "The true mastermind sits within the heroes' trusted network",
                "Victory requires sacrificing a cherished shortcut or ally",
                "The quest location is a living creature that can negotiate",
                "Fulfilling the objective sparks an ancient factional feud",
                "A prophecy marks success only if mercy is shown at the climax",
                "The antagonist wants to lose but on dramatically public terms"
            ],
            adventureRewards: [
                "a map etched across a dragon scale that reshapes when heated",
                "a banner that rallies allies with heroic memories",
                "the deed to a crossroads inn that touches three realms",
                "a deck of living tarot able to store a single soul",
                "an hourglass that rewinds one round at a steep price",
                "a forged alliance with sky pirates patrolling the region",
                "a seed that sprouts into a guardian treant overnight",
                "a crystalline archive containing spells thought lost",
                "a favor owed by the enigmatic King of Beggars",
                "a thunderstone hammer that chooses a worthy bearer"
            ],
            adventureAllies: [
                "a repentant cultist with impeccable memory for rituals",
                "a chatty mimic posing as a traveler's chest",
                "an animated suit of armor sworn to an ancient code",
                "a mapmaker who sketches future paths mid-battle",
                "a stoic gargoyle who judges intentions before helping",
                "a goblin engineer armed with volatile prototypes",
                "a bard who can rewind a single conversation per day",
                "a lantern archon collecting stories of mortal courage",
                "a cleric of chance who measures fate with weighted dice",
                "a scout riding a spectral elk that scents portal magic"
            ],
            omens: [
                "shards of midnight glass raining upward into the sky",
                "choirs of distant bells ringing beneath the ocean",
                "a pale aurora coiling down staircases and alleyways",
                "ink bleeding from tomes to form cryptic stanzas",
                "mirrors fogging with the silhouettes of forgotten heroes",
                "meteors tracing sigils visible only to those who dream deeply",
                "animals speaking in perfect unison for a heartbeat",
                "lunar phases spinning through an entire cycle overnight",
                "campfires that hiss names when fed silver dust",
                "constellations reordering themselves into a warning sigil"
            ],
            sensations: [
                "Echoes taste faintly of cinnamon and lightning",
                "Shadows lag a step behind their owners",
                "Footprints fill with shimmering stardust",
                "Winds carry the cadence of ancient war drums",
                "Water refuses to reflect anyone marked by destiny",
                "Doors bloom with frost in midsummer nights",
                "Coins land on their edge and hum with resonance",
                "Children speak prophecies when skipping stones",
                "Anvil strikes chime in harmonious thirds",
                "Candles burn with inverted violet flames"
            ],
            treasures: [
                "a halo of feathers that grants a single miraculous escape",
                "a compass that points toward the heart's greatest doubt",
                "the Chronicle of Stars, able to rename constellations",
                "a chalice that transforms sorrows into protective wards",
                "a cloak stitched from aurora strands that blinds enemies",
                "a music box containing the last song of a fallen kingdom",
                "a gauntlet that can bottle the wind for later release",
                "a runeblade eager to duel its previous wielder",
                "a lantern housing a fragment of hospitable starlight",
                "a key that opens any lock but trades away a cherished memory"
            ],
            consequences: [
                "Storms of living ink will rewrite local history",
                "Luck drains from the region, empowering only tyrants",
                "The boundary between dreams and waking will dissolve",
                "A rival faction will seize the prophecy for darker ends",
                "Forgotten gods will reclaim the land with unforgiving law",
                "A doomsday clock hidden in a cathedral will begin tolling",
                "The wild hunt will ride permanently through mortal roads",
                "A planar refugee crisis will spill across the frontier",
                "The moon will refuse to rise until balance is restored",
                "The next natural 20 will instead shatter the die that rolled it"
            ]
        };

        function randomFrom(list) {
            return list[Math.floor(Math.random() * list.length)];
        }

        function capitalize(text) {
            if (!text) return '';
            return text.charAt(0).toUpperCase() + text.slice(1);
        }

        function ensurePeriod(text) {
            if (!text) return '';
            return /[.!?]$/.test(text.trim()) ? text.trim() : `${text.trim()}.`;
        }

        function generateBackstory(prompt) {
            const origin = randomFrom(aiTables.origins);
            const training = randomFrom(aiTables.training);
            const event = randomFrom(aiTables.definingEvents);
            const motivation = randomFrom(aiTables.motivations);
            const secret = randomFrom(aiTables.secrets);
            const quirk = randomFrom(aiTables.quirks);
            const patron = randomFrom(aiTables.patrons);

            const promptLead = prompt ? `**Prompt inspiration:** ${ensurePeriod(prompt)}\n\n` : '';
            const firstParagraph = `Raised ${origin}, they ${training}. When ${event}, they vowed to ${motivation}.`;

            return `${promptLead}### Backstory\n${ensurePeriod(firstParagraph)}\n\n**Driving Goal:** ${capitalize(motivation)}.\n**Hidden Complication:** ${ensurePeriod(secret)}\n**Signature Quirk:** ${ensurePeriod(quirk)}\n**Trusted Ally or Patron:** ${ensurePeriod(patron)}`;
        }

        function generateAdventure(prompt) {
            const location = randomFrom(aiTables.adventureLocations);
            const objective = randomFrom(aiTables.adventureObjectives);
            const complication = randomFrom(aiTables.adventureComplications);
            const twist = randomFrom(aiTables.adventureTwists);
            const reward = randomFrom(aiTables.adventureRewards);
            const ally = randomFrom(aiTables.adventureAllies);

            const theme = prompt ? `**Requested theme:** ${ensurePeriod(prompt)}\n\n` : '';

            return `${theme}### Adventure Seed\n**Setup:** Rumors point to ${location}. Heroes must ${objective}.\n\n**Complication:** ${ensurePeriod(complication)}\n**Twist:** ${ensurePeriod(twist)}\n**Potential Reward:** ${ensurePeriod(reward)}\n**Helpful Ally:** ${ensurePeriod(ally)}`;
        }

        function generateProphecy(prompt) {
            const omen = randomFrom(aiTables.omens);
            const sensation = randomFrom(aiTables.sensations);
            const treasure = randomFrom(aiTables.treasures);
            const consequence = randomFrom(aiTables.consequences);

            const focus = prompt ? `**Focus:** ${ensurePeriod(prompt)}\n\n` : '';
            const lead = `${capitalize(omen)} Foretellers record that ${sensation.toLowerCase()}.`;

            return `${focus}### Prophecy\n${ensurePeriod(lead)}\n\n**Treasure Foretold:** ${ensurePeriod(treasure)}\n**If Ignored:** ${ensurePeriod(consequence)}`;
        }

        function buildSynergyLine(statsAvg, classCounts) {
            if ((classCounts.Wizard || 0) + (classCounts.Elf || 0) >= 1 && statsAvg.int >= 12) {
                return 'Arcane minds thrive—seed mysteries that reward research and ritual magic.';
            }
            if ((classCounts.Warrior || 0) + (classCounts.Dwarf || 0) >= 1 && statsAvg.str >= 13) {
                return 'Frontline might is formidable—challenge them with clever terrain and concerted foes.';
            }
            if ((classCounts.Thief || 0) + statsAvg.agi >= 13) {
                return 'Agility shines—design encounters that reward mobility, stealth, and precision strikes.';
            }
            if (statsAvg.luc >= 13) {
                return 'Luck surges through the crew—sprinkle risky gambits and dramatic die rolls into play.';
            }
            return 'Balance defines this band—layer threats that demand teamwork and creative problem solving.';
        }

        function buildPartyInsights() {
            const memberCount = characters.length;
            const totalLevel = characters.reduce((sum, char) => sum + (char.level || 0), 0);
            const avgLevel = memberCount > 0 ? (totalLevel / memberCount).toFixed(1) : '0.0';
            const highestACChar = characters.reduce((best, char) => (best && best.ac > char.ac ? best : char), characters[0]);
            const healthiestChar = characters.reduce((best, char) => (best && best.hpMax > char.hpMax ? best : char), characters[0]);

            const statsTotals = { str: 0, agi: 0, sta: 0, per: 0, int: 0, luc: 0 };
            const abilityLabels = { str: 'Strength', agi: 'Agility', sta: 'Stamina', per: 'Perception', int: 'Intelligence', luc: 'Luck' };

            characters.forEach(char => {
                statsTotals.str += char.str || 0;
                statsTotals.agi += char.agi || 0;
                statsTotals.sta += char.sta || 0;
                statsTotals.per += char.per || 0;
                statsTotals.int += char.int || 0;
                statsTotals.luc += char.luc || 0;
            });

            const statsAvg = Object.fromEntries(Object.entries(statsTotals).map(([key, value]) => [key, value / memberCount]));
            const statEntries = Object.entries(statsAvg).sort((a, b) => b[1] - a[1]);
            const bestStat = statEntries[0];
            const weakestStat = statEntries[statEntries.length - 1];

            const classCounts = {};
            characters.forEach(char => {
                const cls = char.class || 'Untrained';
                classCounts[cls] = (classCounts[cls] || 0) + 1;
            });

            const suggestions = [];
            const frontlineScore = (statsAvg.str + statsAvg.sta) / 2;
            const precisionScore = (statsAvg.agi + statsAvg.per) / 2;
            const arcanePresence = (classCounts.Wizard || 0) + (classCounts.Elf || 0);
            const divinePresence = (classCounts.Cleric || 0);

            if (frontlineScore < 12 && ((classCounts.Warrior || 0) + (classCounts.Dwarf || 0)) === 0) {
                suggestions.push('Frontline durability is light—consider providing sturdier hirelings or defensive boons.');
            }
            if (precisionScore < 11 || (classCounts.Thief || 0) === 0) {
                suggestions.push('Locks, traps, and infiltration may prove difficult—offer alternate paths or gadgets to improvise.');
            }
            if (arcanePresence === 0) {
                suggestions.push('No dedicated arcane caster detected—sprinkle scrolls, wands, or scholarly NPCs to widen options.');
            }
            if (divinePresence === 0) {
                suggestions.push('Healing and blessings are scarce—schedule rest opportunities or allies who can mend wounds.');
            }
            if ((highestACChar?.ac || 0) < 14) {
                suggestions.push('Armor values trend low—reward tactical positioning, cover, or defensive magic items.');
            }
            if (statsAvg.luc > 13) {
                suggestions.push('Luck is abundant—lean into swingy tables and dramatic critical results.');
            }
            if (suggestions.length === 0) {
                suggestions.push('This party covers most bases—escalate stakes with layered objectives and moral choices.');
            }

            const classLines = Object.entries(classCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([cls, count]) => `- ${cls}: ${count}`)
                .join('\n');

            const synergy = buildSynergyLine(statsAvg, classCounts);

            return `### Party Insights\n- **Members:** ${memberCount}\n- **Average Level:** ${avgLevel}\n- **Highest AC:** ${highestACChar ? `${highestACChar.ac} (${highestACChar.name})` : 'N/A'}\n- **Greatest Health Pool:** ${healthiestChar ? `${healthiestChar.hpMax} HP (${healthiestChar.name})` : 'N/A'}\n- **Standout Aptitude:** ${abilityLabels[bestStat[0]]} (avg ${bestStat[1].toFixed(1)})\n- **Needs Support:** ${abilityLabels[weakestStat[0]]} (avg ${weakestStat[1].toFixed(1)})\n\n**Class Coverage:**\n${classLines}\n\n**Synergy Spotlight:** ${ensurePeriod(synergy)}\n\n**AI Suggestions:**\n${suggestions.map(s => `- ${s}`).join('\n')}`;
        }

        const aiGenerators = {
            backstory: {
                promptId: 'ai-backstory-prompt',
                outputId: 'ai-backstory-output',
                title: 'Character Backstory',
                generator: generateBackstory
            },
            adventure: {
                promptId: 'ai-adventure-prompt',
                outputId: 'ai-adventure-output',
                title: 'Adventure Seed',
                generator: generateAdventure
            },
            prophecy: {
                promptId: 'ai-prophecy-prompt',
                outputId: 'ai-prophecy-output',
                title: 'Prophecy & Treasure',
                generator: generateProphecy
            },
            party: {
                outputId: 'ai-party-output',
                title: 'Party Insights',
                generator: () => buildPartyInsights()
            }
        };

        function runAIGenerator(type) {
            const config = aiGenerators[type];
            if (!config) return;

            const prompt = config.promptId ? document.getElementById(config.promptId).value.trim() : '';

            if (type === 'party' && characters.length === 0) {
                updateAIOutput(config.outputId, '_Add at least one character to analyze._');
                aiState[type] = '';
                showAIToast('Add characters before running the analyst.', 'error');
                return;
            }

            const content = config.generator(prompt);
            aiState[type] = content;
            updateAIOutput(config.outputId, content);
            addAIHistory(config.title, content);
            showAIToast(`${config.title} ready!`);
        }

        function refreshPartyInsights() {
            if (!aiState.party) return;

            if (characters.length === 0) {
                aiState.party = '';
                updateAIOutput(aiGenerators.party.outputId, '_Add at least one character to analyze._');
                return;
            }

            const updated = aiGenerators.party.generator('');
            aiState.party = updated;
            updateAIOutput(aiGenerators.party.outputId, updated);
        }

        function updateAIOutput(elementId, markdown) {
            const target = document.getElementById(elementId);
            if (!target) return;

            if (!markdown) {
                target.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Try generating inspiration to see results here.</p>';
                return;
            }

            target.innerHTML = `<div class="space-y-2 leading-relaxed">${marked.parse(markdown)}</div>`;
        }

        function addAIHistory(title, content) {
            const entry = {
                id: Date.now(),
                title,
                content,
                timestamp: new Date().toLocaleString()
            };

            aiHistory.unshift(entry);
            if (aiHistory.length > 8) {
                aiHistory = aiHistory.slice(0, 8);
            }

            renderAIHistory();
        }

        function renderAIHistory() {
            const container = document.getElementById('ai-history');
            if (!container) return;

            if (aiHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Use the AI tools above to build a library of prompts and inspirations.</p>';
                return;
            }

            container.innerHTML = aiHistory.map(entry => `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm">
                    <div class="flex items-start justify-between gap-4 mb-2">
                        <div class="font-semibold text-gray-800 dark:text-gray-200">${entry.title}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">${entry.timestamp}</div>
                    </div>
                    <div class="space-y-2 text-sm leading-relaxed text-gray-700 dark:text-gray-300">${marked.parse(entry.content)}</div>
                </div>
            `).join('');
        }

        function clearAIHistory() {
            if (aiHistory.length === 0) {
                showAIToast('History is already clear.', 'error');
                return;
            }
            aiHistory = [];
            renderAIHistory();
            showAIToast('AI inspiration history cleared.');
        }

        function showAIToast(message, tone = 'success') {
            const toast = document.getElementById('ai-toast');
            if (!toast) return;

            toast.textContent = message;
            toast.classList.remove('hidden', 'bg-green-600', 'bg-red-600');
            toast.classList.add(tone === 'error' ? 'bg-red-600' : 'bg-green-600');

            clearTimeout(aiToastTimeout);
            aiToastTimeout = setTimeout(() => {
                toast.classList.add('hidden');
            }, 2200);
        }

        function copyAIResult(type) {
            const text = aiState[type];
            if (!text) {
                showAIToast('Generate something first.', 'error');
                return;
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => showAIToast('Copied to clipboard!'))
                    .catch(() => {
                        fallbackCopy(text);
                        showAIToast('Copied to clipboard!');
                    });
            } else {
                fallbackCopy(text);
                showAIToast('Copied to clipboard!');
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.setAttribute('readonly', '');
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Clipboard copy failed', err);
            }
            document.body.removeChild(textarea);
        }

        // Custom dialog functions
        function showCustomConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded text-base">Confirm</button>
                    </div>
                </div>
            `;

            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = () => {
                modal.remove();
                onConfirm();
            };

            document.body.appendChild(modal);
        }

        function showCustomPrompt(message, defaultValue = '') {
            const result = {value: null};
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <input type="text" class="prompt-input w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 mb-4 text-base" value="${defaultValue}">
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                        <button class="ok-btn px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded text-base">OK</button>
                    </div>
                </div>
            `;

            const input = modal.querySelector('.prompt-input');
            const done = () => {
                result.value = input.value;
                modal.remove();
            };

            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.ok-btn').onclick = done;
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') done();
            });

            document.body.appendChild(modal);
            input.focus();
            input.select();

            // Synchronous-like behavior using a busy wait (not ideal but works for this use case)
            const startTime = Date.now();
            while (result.value === null && Date.now() - startTime < 60000) {
                // Wait for user input or timeout
                const event = new Promise(resolve => setTimeout(resolve, 10));
            }

            return result.value;
        }

        // Initialize
        renderCharacters();
        renderCombat();
        renderAIHistory();
    </script>


</body></html>