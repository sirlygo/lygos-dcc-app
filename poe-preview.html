<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCC Virtual Tabletop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .dice-result {
            animation: rollIn 0.3s ease-out;
        }
        @keyframes rollIn {
            from {
                transform: scale(0.5) rotate(180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        .tab-active {
            border-bottom: 3px solid #5D5CDE;
            color: #5D5CDE;
        }
        .stat-modifier {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen transition-colors">
    <div class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-2">DCC Virtual Tabletop</h1>
            <p class="text-center text-gray-600 dark:text-gray-400">Dungeon Crawl Classics RPG</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="border-b border-gray-300 dark:border-gray-700 mb-6">
            <ul class="flex flex-wrap -mb-px text-sm md:text-base">
                <li class="mr-2">
                    <button onclick="switchTab('characters')" id="tab-characters" class="tab-active inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Characters</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('dice')" id="tab-dice" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Dice Roller</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('combat')" id="tab-combat" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Combat Tracker</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('tables')" id="tab-tables" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Reference Tables</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('campaigns')" id="tab-campaigns" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Campaigns</button>
                </li>
                <li class="mr-2">
                    <button onclick="switchTab('ai')" id="tab-ai" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">AI Tools</button>
                </li>
            </ul>
        </nav>

        <!-- Tab Content -->
        <div id="content-characters" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Characters</h2>
                <button onclick="showCreateCharacter()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ New Character</button>
            </div>
            <div id="character-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Characters will be added here -->
            </div>
        </div>

        <div id="content-dice" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Dice Roller</h2>
            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 mb-6">
                <div class="grid grid-cols-4 md:grid-cols-7 gap-2 mb-4">
                    <button onclick="rollDice(3)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d3</button>
                    <button onclick="rollDice(4)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d4</button>
                    <button onclick="rollDice(5)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d5</button>
                    <button onclick="rollDice(6)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d6</button>
                    <button onclick="rollDice(7)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d7</button>
                    <button onclick="rollDice(8)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d8</button>
                    <button onclick="rollDice(10)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d10</button>
                    <button onclick="rollDice(12)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d12</button>
                    <button onclick="rollDice(14)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d14</button>
                    <button onclick="rollDice(16)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d16</button>
                    <button onclick="rollDice(20)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d20</button>
                    <button onclick="rollDice(24)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d24</button>
                    <button onclick="rollDice(30)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d30</button>
                    <button onclick="rollDice(100)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d%</button>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Modifier</label>
                    <input type="number" id="dice-modifier" value="0" class="w-full md:w-48 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Number of Dice</label>
                    <input type="number" id="dice-count" value="1" min="1" max="20" class="w-full md:w-48 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">Roll Description (optional)</label>
                    <input type="text" id="roll-description" placeholder="e.g., Attack roll, Saving throw" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Roll Results</h3>
                <div id="dice-results" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 dark:text-gray-400 text-center py-8">Roll some dice to see results</p>
                </div>
            </div>
        </div>

        <div id="content-combat" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Combat Tracker</h2>
                <div class="flex gap-2">
                    <button onclick="addCombatant()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ Add Combatant</button>
                    <button onclick="sortInitiative()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-base">Sort Initiative</button>
                    <button onclick="clearCombat()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-base">Clear All</button>
                </div>
            </div>

            <div class="mb-4 bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                <div class="flex items-center gap-4">
                    <div>
                        <label class="font-semibold">Round:</label>
                        <span id="combat-round" class="ml-2 text-xl font-bold text-primary">1</span>
                    </div>
                    <button onclick="nextRound()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Next Round</button>
                </div>
            </div>

            <div id="combat-list" class="space-y-2">
                <!-- Combat entries will be added here -->
            </div>
        </div>

        <div id="content-tables" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Reference Tables</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Critical Hit Table -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Critical Hits (d20)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-16">1-6:</span><span>Normal damage</span></div>
                        <div class="flex"><span class="font-bold w-16">7-11:</span><span>+1d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">12-13:</span><span>+2d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">14-15:</span><span>+3d6 damage</span></div>
                        <div class="flex"><span class="font-bold w-16">16-17:</span><span>+1d10 damage + bleed 1d6</span></div>
                        <div class="flex"><span class="font-bold w-16">18:</span><span>+2d10 damage + bleed 1d6</span></div>
                        <div class="flex"><span class="font-bold w-16">19:</span><span>+3d10 damage + bleed 2d6</span></div>
                        <div class="flex"><span class="font-bold w-16">20:</span><span>+4d10 damage + limb/organ damage</span></div>
                    </div>
                </div>

                <!-- Fumble Table -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Fumbles (d8)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">1:</span><span>Drop weapon</span></div>
                        <div class="flex"><span class="font-bold w-12">2:</span><span>Slip, lose next action</span></div>
                        <div class="flex"><span class="font-bold w-12">3:</span><span>Twist ankle, -5 ft movement</span></div>
                        <div class="flex"><span class="font-bold w-12">4:</span><span>Stumble, foe gets free attack</span></div>
                        <div class="flex"><span class="font-bold w-12">5:</span><span>Hit ally for normal damage</span></div>
                        <div class="flex"><span class="font-bold w-12">6:</span><span>Weapon stuck, DC 10 STR to free</span></div>
                        <div class="flex"><span class="font-bold w-12">7:</span><span>Armor strap breaks, -1 AC</span></div>
                        <div class="flex"><span class="font-bold w-12">8:</span><span>Weapon damaged, -1 to hit</span></div>
                    </div>
                </div>

                <!-- Ability Score Modifiers -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Ability Score Modifiers</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">3:</span><span>-3</span></div>
                        <div class="flex"><span class="font-bold w-12">4-5:</span><span>-2</span></div>
                        <div class="flex"><span class="font-bold w-12">6-8:</span><span>-1</span></div>
                        <div class="flex"><span class="font-bold w-12">9-12:</span><span>0</span></div>
                        <div class="flex"><span class="font-bold w-12">13-15:</span><span>+1</span></div>
                        <div class="flex"><span class="font-bold w-12">16-17:</span><span>+2</span></div>
                        <div class="flex"><span class="font-bold w-12">18:</span><span>+3</span></div>
                    </div>
                </div>

                <!-- Luck Uses -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Luck Uses</h3>
                    <div class="space-y-2 text-sm">
                        <div>• Add/subtract from any roll (before or after)</div>
                        <div>• Improve critical hit/fumble results</div>
                        <div>• Modify initiative</div>
                        <div>• Find lucky items or gold</div>
                        <div>• Avoid death (at Judge's discretion)</div>
                        <div class="pt-2 italic">Luck spent is permanent unless restored</div>
                    </div>
                </div>

                <!-- Action Dice -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Action Dice by Level</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-20">Level 1-4:</span><span>1d20</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 5:</span><span>1d20 + 1d14</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 6-7:</span><span>1d20 + 1d16</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 8-9:</span><span>1d20 + 1d20</span></div>
                        <div class="flex"><span class="font-bold w-20">Level 10:</span><span>1d20 + 1d20 + 1d14</span></div>
                        <div class="pt-2 italic text-xs">Warriors gain bonus action dice at higher levels</div>
                    </div>
                </div>

                <!-- Spell Corruption -->
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">Spell Corruption (d10)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="font-bold w-12">1:</span><span>Eyes glow when casting</span></div>
                        <div class="flex"><span class="font-bold w-12">2:</span><span>Hair turns white/silver</span></div>
                        <div class="flex"><span class="font-bold w-12">3:</span><span>Skin becomes pale/ashen</span></div>
                        <div class="flex"><span class="font-bold w-12">4:</span><span>Fingernails turn black</span></div>
                        <div class="flex"><span class="font-bold w-12">5:</span><span>Voice becomes raspy</span></div>
                        <div class="flex"><span class="font-bold w-12">6:</span><span>Minor temperature change around caster</span></div>
                        <div class="flex"><span class="font-bold w-12">7:</span><span>Smell of brimstone/ozone</span></div>
                        <div class="flex"><span class="font-bold w-12">8:</span><span>Small horns sprout</span></div>
                        <div class="flex"><span class="font-bold w-12">9:</span><span>Shadow moves independently</span></div>
                        <div class="flex"><span class="font-bold w-12">10:</span><span>Magical runes appear on skin</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-campaigns" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Campaigns</h2>
                <button onclick="showCreateCampaign()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">+ New Campaign</button>
            </div>
            <div id="campaign-list" class="grid grid-cols-1 gap-4">
                <!-- Campaigns will be added here -->
            </div>
        </div>

        <div id="content-ai" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">AI Tools</h2>
            <div class="space-y-6">
                <section class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold">AI Dungeon Master</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Describe a situation and get dynamic narration ideas.</p>
                    </div>
                    <textarea id="ai-dm-prompt" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base mb-3" placeholder="The party enters a forgotten temple..."></textarea>
                    <div class="flex justify-end">
                        <button onclick="generateAIDMResponse()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Ask the AI Judge</button>
                    </div>
                    <div id="ai-dm-response" class="mt-4 text-sm text-gray-700 dark:text-gray-300 space-y-2">
                        <p class="text-gray-500 dark:text-gray-400">Prompt the AI Judge to receive scene framing, complications, and sensory details.</p>
                    </div>
                </section>

                <section class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                        <h3 class="text-xl font-bold">AI Campaign Builder</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Generate a mini-campaign outline tailored to your table.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block mb-1 font-semibold">Theme</label>
                            <input id="ai-campaign-theme" type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base" placeholder="Sword & sorcery heist">
                        </div>
                        <div>
                            <label class="block mb-1 font-semibold">Tone</label>
                            <select id="ai-campaign-tone" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                                <option value="">Surprise me</option>
                                <option>Gritty</option>
                                <option>Heroic</option>
                                <option>Whimsical</option>
                                <option>Weird</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-semibold">Length</label>
                            <select id="ai-campaign-length" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                                <option value="Short">Short (3 sessions)</option>
                                <option value="Medium">Medium (5 sessions)</option>
                                <option value="Long">Long (8+ sessions)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-semibold">Signature Twist</label>
                            <input id="ai-campaign-twist" type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base" placeholder="The patron is possessed">
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="generateAICampaign()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Generate Campaign</button>
                    </div>
                    <div id="ai-campaign-output" class="mt-4 text-sm text-gray-700 dark:text-gray-300 space-y-2">
                        <p class="text-gray-500 dark:text-gray-400">Use the builder to quickly scaffold arcs, patrons, and threats unique to your campaign.</p>
                    </div>
                </section>

                <section class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                        <h3 class="text-xl font-bold">AI DM Helper</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Grab instant prompts for encounters, NPCs, twists, and rewards.</p>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="generateDMHelper('encounter')" class="bg-primary text-white px-3 py-2 rounded hover:bg-opacity-90 transition text-sm">Encounter Idea</button>
                        <button onclick="generateDMHelper('npc')" class="bg-primary text-white px-3 py-2 rounded hover:bg-opacity-90 transition text-sm">NPC Spotlight</button>
                        <button onclick="generateDMHelper('twist')" class="bg-primary text-white px-3 py-2 rounded hover:bg-opacity-90 transition text-sm">Plot Twist</button>
                        <button onclick="generateDMHelper('challenge')" class="bg-primary text-white px-3 py-2 rounded hover:bg-opacity-90 transition text-sm">Skill Challenge</button>
                        <button onclick="generateDMHelper('treasure')" class="bg-primary text-white px-3 py-2 rounded hover:bg-opacity-90 transition text-sm">Treasure Drop</button>
                    </div>
                    <div id="ai-helper-output" class="text-sm text-gray-700 dark:text-gray-300 space-y-2">
                        <p class="text-gray-500 dark:text-gray-400">Select a category to let the AI helper fill in flavorful details.</p>
                    </div>
                </section>

                <section class="bg-gray-50 dark:bg-gray-900 rounded-lg p-5">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                        <h3 class="text-xl font-bold">AI Character Forge</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Generate balanced characters tuned to level, class, or ancestry.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block mb-1 font-semibold">Target Level</label>
                            <input id="ai-character-level" type="number" min="0" max="10" value="1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                        </div>
                        <div>
                            <label class="block mb-1 font-semibold">Preferred Class</label>
                            <select id="ai-character-class" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                                <option value="Random">Random</option>
                                <option value="Peasant">0-Level (Peasant)</option>
                                <option value="Warrior">Warrior</option>
                                <option value="Wizard">Wizard</option>
                                <option value="Cleric">Cleric</option>
                                <option value="Thief">Thief</option>
                                <option value="Dwarf">Dwarf</option>
                                <option value="Elf">Elf</option>
                                <option value="Halfling">Halfling</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-semibold">Preferred Ancestry</label>
                            <select id="ai-character-race" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                                <option value="Random">Random</option>
                                <option>Human</option>
                                <option>Dwarf</option>
                                <option>Elf</option>
                                <option>Halfling</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-semibold">Play Style Focus</label>
                            <select id="ai-character-focus" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-800 text-base">
                                <option value="Balanced">Balanced</option>
                                <option value="Combat">Combat</option>
                                <option value="Magic">Magic</option>
                                <option value="Skills">Skills</option>
                                <option value="Survival">Survival</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button onclick="generateAICharacter()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Generate Character</button>
                        <button id="ai-character-save-btn" onclick="saveGeneratedCharacter()" class="hidden bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-base">Add to Character Roster</button>
                    </div>
                    <div id="ai-character-message" class="hidden mt-2 text-sm text-green-600 dark:text-green-400 font-semibold"></div>
                    <div id="ai-character-output" class="mt-4 text-sm text-gray-700 dark:text-gray-300 space-y-2">
                        <p class="text-gray-500 dark:text-gray-400">Configure preferences, then let the forge craft a ready-to-play hero.</p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div id="create-campaign-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Create Campaign</h3>
                <form id="campaign-form" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Campaign Name</label>
                        <input type="text" id="campaign-name" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Campaign Description</label>
                        <textarea id="campaign-description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="hideCreateCampaign()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-base">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-base">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Campaign Detail Modal -->
    <div id="campaign-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-campaign-name"></h3>
                    <button onclick="hideCampaignDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="campaign-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Adventure Detail Modal -->
    <div id="adventure-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-adventure-name"></h3>
                    <button onclick="hideAdventureDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="adventure-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div id="create-character-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-4">Create Character</h3>
                <form id="character-form" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Name</label>
                        <input type="text" id="char-name" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">Level</label>
                            <input type="number" id="char-level" value="0" min="0" max="10" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Class</label>
                            <select id="char-class" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                                <option value="Peasant">0-Level (Peasant)</option>
                                <option value="Warrior">Warrior</option>
                                <option value="Wizard">Wizard</option>
                                <option value="Cleric">Cleric</option>
                                <option value="Thief">Thief</option>
                                <option value="Dwarf">Dwarf</option>
                                <option value="Elf">Elf</option>
                                <option value="Halfling">Halfling</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">STR</label>
                            <input type="number" id="char-str" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">AGI</label>
                            <input type="number" id="char-agi" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">STA</label>
                            <input type="number" id="char-sta" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">PER</label>
                            <input type="number" id="char-per" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">INT</label>
                            <input type="number" id="char-int" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">LUC</label>
                            <input type="number" id="char-luc" value="10" min="3" max="18" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">HP (Max)</label>
                            <input type="number" id="char-hp-max" value="4" min="1" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Current HP</label>
                            <input type="number" id="char-hp-current" value="4" min="0" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold">AC</label>
                            <input type="number" id="char-ac" value="10" min="1" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Speed</label>
                            <input type="number" id="char-speed" value="30" min="0" required="" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        </div>
                    </div>

                    <div>
                        <label class="block mb-2 font-semibold">Equipment/Notes</label>
                        <textarea id="char-equipment" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base"></textarea>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="hideCreateCharacter()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-base">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-base">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Character Detail Modal -->
    <div id="character-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold" id="detail-char-name"></h3>
                    <button onclick="hideCharacterDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="character-detail-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data storage (in-memory)
        let characters = [];
        let combatants = [];
        let combatRound = 1;
        let rollHistory = [];
        let lastGeneratedCharacter = null;

        const aiContent = {
            dm: {
                openings: [
                    'A chill wind coils through the chamber as',
                    'Under the watchful gaze of forgotten idols,',
                    'Warped torchlight paints jagged shadows while',
                    'The scent of ozone mingles with damp stone when',
                    'An otherworldly chant echoes faintly as'
                ],
                complications: [
                    'a rival faction interrupts with their own agenda',
                    'the environment begins to collapse around the heroes',
                    'an ancient ward awakens and demands a sacrifice',
                    'the party\'s patron contacts them with urgent, conflicting orders',
                    'a latent corruption flares, mutating the nearest creature'
                ],
                sensory: [
                    'Crystalline motes drift in the air, humming softly at each footstep.',
                    'A distant drumbeat syncs with the heartbeat of anyone who listens.',
                    'Every metallic surface is rimed with frost despite the sweltering heat.',
                    'Whispers in an unknown tongue spill from cracks in the walls.',
                    'An invisible current tugs at loose clothing toward a sealed archway.'
                ],
                twists: [
                    'The supposed villain is a bound guardian begging for release.',
                    'An artifact the party carries reacts violently, unlocking a new chamber.',
                    'The scene is a memory echo that can be altered with bold actions.',
                    'Time fractures, letting glimpses of future consequences bleed in.',
                    'A long-lost ally appears—changed, empowered, and unsure of the party.'
                ]
            },
            campaign: {
                patrons: [
                    'a repentant demon seeking redemption',
                    'an ambitious guild of alchemists',
                    'the spectral council of a ruined city',
                    'a cabal of star-sailors marooned planeside',
                    'an oracle whose visions are fragmenting reality'
                ],
                villains: [
                    'a sorcerer stitching monsters from planar echoes',
                    'a cult of dreamers weaponizing nightmares',
                    'a tyrant king wearing the Crown of Voices',
                    'a sentient dungeon expanding beneath the realm',
                    'an arch-lich composing a dirge to end the sun'
                ],
                locations: [
                    'the Veiled Expanse of mirage-ridden dunes',
                    'the Storm Loom, a floating fortress caught in a lightning gyre',
                    'the roots of the World Tree hollowed into labyrinthine halls',
                    'a chain of volcanic islands linked by living bridges',
                    'the submerged cathedral of a forgotten moon cult'
                ],
                setPieces: [
                    'negotiating with a sentient portal for safe passage',
                    'racing a collapsing ziggurat that rearranges itself each round',
                    'piloting bone skiffs through a river of spectral memories',
                    'performing a ritual duel while gravity constantly shifts',
                    'decoding a living spell that speaks in riddles'
                ],
                rewards: [
                    'a relic that lets its bearer rewrite a single past decision',
                    'boons from a grateful patron deity',
                    'a keep that exists simultaneously in two locations',
                    'ancestral weapons that level up with heroic deeds',
                    'knowledge of a hidden leyline network'
                ],
                arcs: [
                    'Secure a tenuous alliance with a rival faction.',
                    'Disrupt the villain\'s supply of eldritch resources.',
                    'Unravel the mystery surrounding a prophetic omen.',
                    'Escort an unstable artifact to its place of origin.',
                    'Seal a planar rift before it consumes a settlement.'
                ]
            },
            helper: {
                encounter: [
                    'A ghostly procession marches through town. Interacting respectfully earns blessings; disrupting it triggers spectral combat.',
                    'Bandits astride giant dragonflies swoop in, seeking a runaway noble hiding with the party.',
                    'A stone titan rises mid-river, demanding a riddle toll while water levels surge dangerously.',
                    'A rival adventuring band challenges the heroes to non-lethal contests for bragging rights.',
                    'A living storm lashes the area, forcing the party to navigate chaotic hazards to reach shelter.'
                ],
                npc: [
                    'Zerla Quickstep, halfling mapmancer who tattooed every route she has ever walked.',
                    'Brother Caldus, warrior-priest whose holy symbol glows brighter near lies.',
                    'Ivory Nyx, elf diplomat who speaks with mirror reflections instead of mouths.',
                    'Torren Blackbriar, dwarf brewer crafting ales from distilled elemental essences.',
                    'Seraphine Vell, human astrologer haunted by constellations only she can see.'
                ],
                twist: [
                    'The true villain is a future version of an ally trying to avert disaster.',
                    'Every treasure recovered is a prison cell for a benevolent spirit.',
                    'The dungeon is an elaborate test orchestrated by the party\'s patron.',
                    'An eclipse locks the world in twilight until a forgotten oath is spoken.',
                    'Magic begins to fail unless fueled by personal memories.'
                ],
                challenge: [
                    'Navigate a hall of living glyphs that drain abilities unless deciphered collaboratively.',
                    'Calm a rampaging elemental by reenacting the lullaby of its creator.',
                    'Cross a chasm using improvised rope bridges before the winds shift.',
                    'Convince a council of spirits to release the soul of a fallen companion.',
                    'Repair a cursed artifact mid-battle to turn it against its master.'
                ],
                treasure: [
                    'The Echo Key: once per session, repeat the result of a previously rolled die.',
                    'Boots of the Meteor Step: leap thrice your height and leave blazing footprints.',
                    'Lantern of Lost Paths: reveals hidden doorways, but extinguishes mundane lights nearby.',
                    'Charm of Stolen Hours: regain a spent ability by sacrificing a memory.',
                    'Farsight Compass: points toward the nearest significant secret, not true north.'
                ]
            },
            character: {
                backgrounds: [
                    'Escaped bondservant turned treasure scout.',
                    'Former courtier seeking redemption for past intrigues.',
                    'Wandering scholar obsessed with lost dialects.',
                    'Survivor of a cult uprising bearing cryptic tattoos.',
                    'Beast tamer who hears the whispers of ancient spirits.',
                    'Reluctant heir to a cursed bloodline.',
                    'Planar refugee mapping the strange new realm.'
                ],
                motivations: [
                    'Prove their worth to a skeptical mentor.',
                    'Acquire enough gold to rebuild a fallen village.',
                    'Unlock the secret behind recurring prophetic dreams.',
                    'Protect companions at all costs after losing their last band.',
                    'Amass relics to barter for a loved one\'s freedom from the afterlife.'
                ],
                gear: [
                    'Rune-etched dagger that vibrates near sorcery.',
                    'Bundle of well-worn maps tied with red twine.',
                    'Totem charm carved from meteor iron.',
                    'Hooded lantern with stained-glass panels.',
                    'Journal of enemy weaknesses compiled meticulously.',
                    'Curio satchel filled with bones, herbs, and polished stones.'
                ],
                quirks: [
                    'Keeps a tally of debts owed and favors granted.',
                    'Collects last words of fallen foes in a leather-bound book.',
                    'Always hums sea shanties before battle.',
                    'Throws knucklebones to consult fate each dawn.',
                    'Refuses to eat rations unless they are toasted over open flame.'
                ],
                names: {
                    Human: ['Arlen', 'Mira', 'Joren', 'Selise', 'Thane', 'Lysa', 'Corin', 'Velra'],
                    Dwarf: ['Bromm', 'Korga', 'Durin', 'Helga', 'Marn', 'Sigrid'],
                    Elf: ['Aerith', 'Lorian', 'Sylvar', 'Thalindra', 'Vorenn', 'Eliara'],
                    Halfling: ['Pipkin', 'Briala', 'Tucker', 'Meri', 'Lottie', 'Finnan']
                }
            }
        };

        const classBlueprints = {
            Peasant: {
                hitDie: 4,
                baseAC: 10,
                speed: 30,
                specialties: ['Improvised weapons', 'Sheer luck'],
                equipment: ['Pitchfork or club', 'Sling with 10 stones', 'Worn satchel of keepsakes']
            },
            Warrior: {
                hitDie: 12,
                baseAC: 14,
                speed: 30,
                specialties: ['Mighty deed of arms', 'Battlefield presence'],
                equipment: ['Chain hauberk', 'Shield emblazoned with personal heraldry', 'Trusted melee weapon']
            },
            Wizard: {
                hitDie: 4,
                baseAC: 10,
                speed: 30,
                specialties: ['Mercurial magic', 'Spell dueling'],
                equipment: ['Spellbook of volatile glyphs', 'Crystal focus rod', 'Pouch of alchemical reagents']
            },
            Cleric: {
                hitDie: 8,
                baseAC: 13,
                speed: 30,
                specialties: ['Turn unholy', 'Lay on hands'],
                equipment: ['Sanctified weapon', 'Holy symbol reliquary', 'Traveling prayer mat']
            },
            Thief: {
                hitDie: 6,
                baseAC: 12,
                speed: 30,
                specialties: ['Backstab', 'Luck manipulation'],
                equipment: ['Shadowweave cloak', 'Lockpick assortment', 'Throwing knives']
            },
            Dwarf: {
                hitDie: 10,
                baseAC: 15,
                speed: 20,
                specialties: ['Stonecunning', 'Shield wall'],
                equipment: ['Warhammer', 'Shield of clan sigils', 'Belt of artisan tools']
            },
            Elf: {
                hitDie: 6,
                baseAC: 13,
                speed: 30,
                specialties: ['Spellblade techniques', 'Keen senses'],
                equipment: ['Runic longsword', 'Spell-stitched cloak', 'Fey-crafted bow']
            },
            Halfling: {
                hitDie: 6,
                baseAC: 14,
                speed: 20,
                specialties: ['Two-weapon trickery', 'Luck sharing'],
                equipment: ['Paired daggers', 'Pocketful of calming herbs', 'Slingshot with lucky stones']
            }
        };

        const focusAdjustments = {
            Balanced: {},
            Combat: { str: 2, sta: 1 },
            Magic: { int: 2, per: 1, str: -1 },
            Skills: { agi: 2, per: 1 },
            Survival: { sta: 2, luc: 1 }
        };

        const raceAdjustments = {
            Human: { speed: 30 },
            Dwarf: { str: 1, sta: 2, speed: 20 },
            Elf: { agi: 1, int: 1, sta: -1, speed: 30 },
            Halfling: { agi: 2, luc: 1, str: -1, speed: 20 }
        };

        function sample(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function roll3d6() {
            return Math.floor(Math.random() * 6) + 1 + Math.floor(Math.random() * 6) + 1 + Math.floor(Math.random() * 6) + 1;
        }

        function clampAbility(score) {
            return Math.max(3, Math.min(18, score));
        }

        function generateAIDMResponse() {
            const promptInput = document.getElementById('ai-dm-prompt');
            const output = document.getElementById('ai-dm-response');
            const rawPrompt = promptInput.value.trim();

            if (!rawPrompt) {
                output.innerHTML = '<p class="text-red-600 dark:text-red-400">Provide a situation for the AI Judge to elaborate on.</p>';
                return;
            }

            const normalized = rawPrompt.replace(/\s+/g, ' ').trim();
            const lowered = normalized.charAt(0).toLowerCase() + normalized.slice(1);
            const sceneIntro = `${sample(aiContent.dm.openings)} ${lowered}`.replace(/\s+([,.!?])/g, '$1');
            const complication = sample(aiContent.dm.complications);
            const sensory = sample(aiContent.dm.sensory);
            const twist = sample(aiContent.dm.twists);

            output.innerHTML = `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-3">
                    <div>
                        <h4 class="font-semibold text-base mb-1">Scene Framing</h4>
                        <p>${sceneIntro.endsWith('.') ? sceneIntro : sceneIntro + '.'}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-base mb-1">Immediate Complication</h4>
                        <p>${complication.charAt(0).toUpperCase() + complication.slice(1)}.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-base mb-1">Sensory Details</h4>
                        <p>${sensory}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-base mb-1">Dynamic Twist</h4>
                        <p>${twist}</p>
                    </div>
                </div>
            `;
        }

        function generateAICampaign() {
            const themeInput = document.getElementById('ai-campaign-theme').value.trim();
            const toneInput = document.getElementById('ai-campaign-tone').value;
            const lengthInput = document.getElementById('ai-campaign-length').value || 'Short';
            const twistInput = document.getElementById('ai-campaign-twist').value.trim();
            const output = document.getElementById('ai-campaign-output');

            const tone = toneInput || sample(['Gritty', 'Heroic', 'Weird', 'Whimsical']);
            const theme = themeInput || sample(['forbidden magic heist', 'desperate planar rescue', 'siege of a haunted keep', 'political intrigue among warlords']);
            const twist = twistInput || sample(aiContent.dm.twists);

            const patron = sample(aiContent.campaign.patrons);
            const villain = sample(aiContent.campaign.villains);
            const location = sample(aiContent.campaign.locations);
            const setPiece = sample(aiContent.campaign.setPieces);
            const reward = sample(aiContent.campaign.rewards);

            const arcTarget = { Short: 3, Medium: 4, Long: 5 }[lengthInput] || 3;
            const arcPool = [...aiContent.campaign.arcs];
            const arcs = [];
            for (let i = 0; i < arcTarget; i++) {
                if (arcPool.length === 0) break;
                const index = Math.floor(Math.random() * arcPool.length);
                arcs.push(arcPool.splice(index, 1)[0]);
            }

            output.innerHTML = `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-4">
                    <div>
                        <h4 class="font-semibold text-base mb-1">Campaign Pitch (${tone} tone)</h4>
                        <p>The heroes embark on a ${theme} set amid ${location}. Their patron is ${patron}, but opposition gathers in the form of ${villain}.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-base mb-1">Signature Set Piece</h4>
                        <p>${setPiece.charAt(0).toUpperCase() + setPiece.slice(1)}.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-base mb-1">Story Arcs</h4>
                        <ol class="list-decimal ml-5 space-y-1">
                            ${arcs.map(arc => `<li>${arc}</li>`).join('')}
                        </ol>
                    </div>
                    <div>
                        <h4 class="font-semibold text-base mb-1">Campaign Twist</h4>
                        <p>${twist}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-base mb-1">Long-Term Reward</h4>
                        <p>${reward}</p>
                    </div>
                </div>
            `;
        }

        function generateDMHelper(type) {
            const output = document.getElementById('ai-helper-output');
            const entries = aiContent.helper[type];

            if (!entries) {
                output.innerHTML = '<p class="text-red-600 dark:text-red-400">No generator found for that category.</p>';
                return;
            }

            const idea = sample(entries);
            output.innerHTML = `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                    <p>${idea}</p>
                </div>
            `;
        }

        function buildAbilityGrid(stats) {
            const keys = [
                ['STR', stats.str],
                ['AGI', stats.agi],
                ['STA', stats.sta],
                ['PER', stats.per],
                ['INT', stats.int],
                ['LUC', stats.luc]
            ];

            return keys.map(([label, value]) => {
                const mod = getModifier(value);
                const modText = `${mod >= 0 ? '+' : ''}${mod}`;
                return `
                    <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                        <div class="font-semibold">${label}</div>
                        <div class="text-xl">${value}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${modText}</div>
                    </div>
                `;
            }).join('');
        }

        function generateAICharacter() {
            const level = Math.max(0, Math.min(10, parseInt(document.getElementById('ai-character-level').value, 10) || 0));
            const classPreference = document.getElementById('ai-character-class').value;
            const racePreference = document.getElementById('ai-character-race').value;
            const focus = document.getElementById('ai-character-focus').value || 'Balanced';
            const output = document.getElementById('ai-character-output');
            const message = document.getElementById('ai-character-message');
            const saveButton = document.getElementById('ai-character-save-btn');

            const availableClasses = Object.keys(classBlueprints);
            let chosenClass = classPreference === 'Random' ? sample(availableClasses.filter(cls => level === 0 ? cls === 'Peasant' : cls !== 'Peasant')) : classPreference;
            if (level === 0) {
                chosenClass = 'Peasant';
            }

            let chosenRace = racePreference === 'Random' ? sample(Object.keys(aiContent.character.names)) : racePreference;
            if (!aiContent.character.names[chosenRace]) {
                chosenRace = 'Human';
            }

            const baseStats = {
                str: roll3d6(),
                agi: roll3d6(),
                sta: roll3d6(),
                per: roll3d6(),
                int: roll3d6(),
                luc: roll3d6()
            };

            const focusAdjust = focusAdjustments[focus] || {};
            Object.entries(focusAdjust).forEach(([key, delta]) => {
                if (baseStats[key] !== undefined) {
                    baseStats[key] = clampAbility(baseStats[key] + delta);
                }
            });

            const raceAdjust = raceAdjustments[chosenRace] || {};
            Object.entries(raceAdjust).forEach(([key, delta]) => {
                if (key === 'speed') return;
                if (baseStats[key] !== undefined) {
                    baseStats[key] = clampAbility(baseStats[key] + delta);
                }
            });

            const classInfo = classBlueprints[chosenClass] || classBlueprints.Peasant;
            const staminaMod = getModifier(baseStats.sta);
            const effectiveLevel = Math.max(level, chosenClass === 'Peasant' ? level : Math.max(level, 1));

            let hpMax = classInfo.hitDie + staminaMod;
            if (effectiveLevel > 1) {
                for (let i = 2; i <= effectiveLevel; i++) {
                    hpMax += Math.max(1, Math.ceil(classInfo.hitDie / 2) + staminaMod);
                }
            }
            hpMax = Math.max(1, hpMax);

            const agilityMod = Math.max(0, getModifier(baseStats.agi));
            const baseSpeed = raceAdjust.speed || classInfo.speed || 30;
            const speed = focus === 'Survival' ? baseSpeed + 5 : baseSpeed;
            const ac = classInfo.baseAC + agilityMod;

            const namePool = aiContent.character.names[chosenRace] || aiContent.character.names.Human;
            const name = sample(namePool);
            const background = sample(aiContent.character.backgrounds);
            const motivation = sample(aiContent.character.motivations);
            const extraGear = sample(aiContent.character.gear);
            const quirk = sample(aiContent.character.quirks);

            const equipmentNotes = `${classInfo.equipment.join(', ')}; ${extraGear}. Quirk: ${quirk}`;
            const storyNotes = `${background} ${motivation}`;

            lastGeneratedCharacter = {
                name,
                level,
                class: chosenClass,
                str: baseStats.str,
                agi: baseStats.agi,
                sta: baseStats.sta,
                per: baseStats.per,
                int: baseStats.int,
                luc: baseStats.luc,
                hpMax,
                hpCurrent: hpMax,
                ac,
                speed,
                equipment: `${storyNotes}\n\nSignature gear: ${equipmentNotes}`
            };

            message.classList.add('hidden');
            saveButton.classList.remove('hidden');
            saveButton.disabled = false;
            saveButton.textContent = 'Add to Character Roster';

            output.innerHTML = `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                        <div>
                            <h4 class="text-xl font-bold">${name}, Level ${level} ${chosenRace} ${chosenClass}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${storyNotes}</p>
                        </div>
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div>
                                <div class="text-xs uppercase text-gray-500 dark:text-gray-400">HP</div>
                                <div class="text-lg font-semibold">${hpMax}</div>
                            </div>
                            <div>
                                <div class="text-xs uppercase text-gray-500 dark:text-gray-400">AC</div>
                                <div class="text-lg font-semibold">${ac}</div>
                            </div>
                            <div>
                                <div class="text-xs uppercase text-gray-500 dark:text-gray-400">Speed</div>
                                <div class="text-lg font-semibold">${speed} ft</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        ${buildAbilityGrid(baseStats)}
                    </div>
                    <div>
                        <h5 class="font-semibold mb-1">Class Highlights</h5>
                        <ul class="list-disc ml-5 space-y-1 text-sm">
                            ${classInfo.specialties.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                    <div>
                        <h5 class="font-semibold mb-1">Equipment & Traits</h5>
                        <p>${equipmentNotes}</p>
                    </div>
                </div>
            `;
        }

        function saveGeneratedCharacter() {
            if (!lastGeneratedCharacter) return;

            const character = {
                ...lastGeneratedCharacter,
                id: Date.now()
            };

            characters.push(character);
            renderCharacters();

            const message = document.getElementById('ai-character-message');
            const saveButton = document.getElementById('ai-character-save-btn');
            message.textContent = `${character.name} added to your character roster.`;
            message.classList.remove('hidden');
            saveButton.textContent = 'Character Added!';
            saveButton.disabled = true;
        }

        // Tab switching
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('tab-active'));

            // Show selected tab
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('tab-active');
        }

        // Calculate ability modifier
        function getModifier(score) {
            if (score <= 3) return -3;
            if (score <= 5) return -2;
            if (score <= 8) return -1;
            if (score <= 12) return 0;
            if (score <= 15) return 1;
            if (score <= 17) return 2;
            return 3;
        }

        // Character Management
        function showCreateCharacter() {
            document.getElementById('create-character-modal').classList.remove('hidden');
            document.getElementById('create-character-modal').classList.add('flex');
        }

        function hideCreateCharacter() {
            document.getElementById('create-character-modal').classList.add('hidden');
            document.getElementById('create-character-modal').classList.remove('flex');
            document.getElementById('character-form').reset();
        }

        document.getElementById('character-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const character = {
                id: Date.now(),
                name: document.getElementById('char-name').value,
                level: parseInt(document.getElementById('char-level').value),
                class: document.getElementById('char-class').value,
                str: parseInt(document.getElementById('char-str').value),
                agi: parseInt(document.getElementById('char-agi').value),
                sta: parseInt(document.getElementById('char-sta').value),
                per: parseInt(document.getElementById('char-per').value),
                int: parseInt(document.getElementById('char-int').value),
                luc: parseInt(document.getElementById('char-luc').value),
                hpMax: parseInt(document.getElementById('char-hp-max').value),
                hpCurrent: parseInt(document.getElementById('char-hp-current').value),
                ac: parseInt(document.getElementById('char-ac').value),
                speed: parseInt(document.getElementById('char-speed').value),
                equipment: document.getElementById('char-equipment').value
            };

            characters.push(character);
            renderCharacters();
            hideCreateCharacter();
        });

        function renderCharacters() {
            const container = document.getElementById('character-list');

            if (characters.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-full">No characters yet. Create one to get started!</p>';
                return;
            }

            container.innerHTML = characters.map(char => `
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 hover:shadow-lg transition cursor-pointer" onclick="showCharacterDetail(${char.id})">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-xl font-bold">${char.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Level ${char.level} ${char.class}</p>
                        </div>
                        <button onclick="event.stopPropagation(); deleteCharacter(${char.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-sm mb-2">
                        <div>
                            <span class="font-semibold">HP:</span> ${char.hpCurrent}/${char.hpMax}
                        </div>
                        <div>
                            <span class="font-semibold">AC:</span> ${char.ac}
                        </div>
                        <div>
                            <span class="font-semibold">Speed:</span> ${char.speed}ft
                        </div>
                    </div>
                    <div class="grid grid-cols-6 gap-1 text-xs">
                        <div class="text-center">
                            <div class="font-semibold">STR</div>
                            <div>${char.str} <span class="stat-modifier">(${getModifier(char.str) >= 0 ? '+' : ''}${getModifier(char.str)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">AGI</div>
                            <div>${char.agi} <span class="stat-modifier">(${getModifier(char.agi) >= 0 ? '+' : ''}${getModifier(char.agi)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">STA</div>
                            <div>${char.sta} <span class="stat-modifier">(${getModifier(char.sta) >= 0 ? '+' : ''}${getModifier(char.sta)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">PER</div>
                            <div>${char.per} <span class="stat-modifier">(${getModifier(char.per) >= 0 ? '+' : ''}${getModifier(char.per)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">INT</div>
                            <div>${char.int} <span class="stat-modifier">(${getModifier(char.int) >= 0 ? '+' : ''}${getModifier(char.int)})</span></div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold">LUC</div>
                            <div>${char.luc} <span class="stat-modifier">(${getModifier(char.luc) >= 0 ? '+' : ''}${getModifier(char.luc)})</span></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCharacterDetail(id) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            document.getElementById('detail-char-name').textContent = char.name;

            const content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-semibold">Level:</span> ${char.level}</div>
                        <div><span class="font-semibold">Class:</span> ${char.class}</div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">HP</div>
                            <div class="text-2xl font-bold">${char.hpCurrent}/${char.hpMax}</div>
                            <div class="mt-2 flex gap-2">
                                <button onclick="adjustHP(${char.id}, -1)" class="flex-1 bg-red-500 text-white px-2 py-1 rounded text-sm">-</button>
                                <button onclick="adjustHP(${char.id}, 1)" class="flex-1 bg-green-500 text-white px-2 py-1 rounded text-sm">+</button>
                            </div>
                        </div>
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">AC</div>
                            <div class="text-2xl font-bold">${char.ac}</div>
                        </div>
                        <div class="text-center bg-gray-100 dark:bg-gray-900 p-3 rounded">
                            <div class="text-sm text-gray-600 dark:text-gray-400">Speed</div>
                            <div class="text-2xl font-bold">${char.speed}ft</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold mb-2">Ability Scores</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">STR</div>
                                <div class="text-xl">${char.str}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.str) >= 0 ? '+' : ''}${getModifier(char.str)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">AGI</div>
                                <div class="text-xl">${char.agi}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.agi) >= 0 ? '+' : ''}${getModifier(char.agi)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">STA</div>
                                <div class="text-xl">${char.sta}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.sta) >= 0 ? '+' : ''}${getModifier(char.sta)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">PER</div>
                                <div class="text-xl">${char.per}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.per) >= 0 ? '+' : ''}${getModifier(char.per)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">INT</div>
                                <div class="text-xl">${char.int}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.int) >= 0 ? '+' : ''}${getModifier(char.int)}</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                <div class="font-semibold">LUC</div>
                                <div class="text-xl">${char.luc}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${getModifier(char.luc) >= 0 ? '+' : ''}${getModifier(char.luc)}</div>
                            </div>
                        </div>
                    </div>

                    ${char.equipment ? `
                    <div>
                        <h4 class="font-bold mb-2">Equipment & Notes</h4>
                        <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded whitespace-pre-wrap">${char.equipment}</div>
                    </div>
                    ` : ''}

                    <div class="flex gap-2">
                        <button onclick="addCharacterToCombat(${char.id})" class="flex-1 bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-base">Add to Combat</button>
                        <button onclick="deleteCharacter(${char.id})" class="flex-1 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-base">Delete</button>
                    </div>
                </div>
            `;

            document.getElementById('character-detail-content').innerHTML = content;
            document.getElementById('character-detail-modal').classList.remove('hidden');
            document.getElementById('character-detail-modal').classList.add('flex');
        }

        function hideCharacterDetail() {
            document.getElementById('character-detail-modal').classList.add('hidden');
            document.getElementById('character-detail-modal').classList.remove('flex');
        }

        function adjustHP(id, amount) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            char.hpCurrent = Math.max(0, Math.min(char.hpMax, char.hpCurrent + amount));
            renderCharacters();
            showCharacterDetail(id);
        }

        function deleteCharacter(id) {
            showCustomConfirm('Are you sure you want to delete this character?', () => {
                characters = characters.filter(c => c.id !== id);
                renderCharacters();
                hideCharacterDetail();
            });
        }

        // Dice Roller
        function rollDice(sides) {
            const count = parseInt(document.getElementById('dice-count').value) || 1;
            const modifier = parseInt(document.getElementById('dice-modifier').value) || 0;
            const description = document.getElementById('roll-description').value;

            const rolls = [];
            let total = modifier;

            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }

            const result = {
                sides,
                count,
                rolls,
                modifier,
                total,
                description,
                timestamp: new Date().toLocaleTimeString()
            };

            rollHistory.unshift(result);
            if (rollHistory.length > 20) rollHistory.pop();

            displayRollResults();
        }

        function displayRollResults() {
            const container = document.getElementById('dice-results');

            if (rollHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Roll some dice to see results</p>';
                return;
            }

            container.innerHTML = rollHistory.map(r => `
                <div class="dice-result bg-white dark:bg-gray-800 p-4 rounded-lg border-l-4 border-primary">
                    ${r.description ? `<div class="font-semibold mb-1">${r.description}</div>` : ''}
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            ${r.count}d${r.sides}${r.modifier !== 0 ? (r.modifier > 0 ? '+' : '') + r.modifier : ''}
                            <span class="ml-2">[${r.rolls.join(', ')}]</span>
                        </div>
                        <div class="text-2xl font-bold text-primary">${r.total}</div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">${r.timestamp}</div>
                </div>
            `).join('');
        }

        // Combat Tracker
        function addCombatant() {
            const name = showCustomPrompt('Enter combatant name:');
            if (!name) return;

            const initiative = showCustomPrompt('Enter initiative (or leave blank to roll):');
            const init = initiative ? parseInt(initiative) : Math.floor(Math.random() * 20) + 1;

            const hp = showCustomPrompt('Enter HP:', '10');
            const ac = showCustomPrompt('Enter AC:', '10');

            combatants.push({
                id: Date.now(),
                name,
                initiative: init,
                hp: parseInt(hp) || 10,
                hpMax: parseInt(hp) || 10,
                ac: parseInt(ac) || 10,
                isActive: false
            });

            renderCombat();
        }

        function addCharacterToCombat(charId) {
            const char = characters.find(c => c.id === charId);
            if (!char) return;

            const initiative = Math.floor(Math.random() * 20) + 1 + getModifier(char.agi);

            combatants.push({
                id: Date.now(),
                name: char.name,
                initiative,
                hp: char.hpCurrent,
                hpMax: char.hpMax,
                ac: char.ac,
                isActive: false,
                characterId: charId
            });

            renderCombat();
            hideCharacterDetail();
        }

        function sortInitiative() {
            combatants.sort((a, b) => b.initiative - a.initiative);
            if (combatants.length > 0) {
                combatants.forEach(c => c.isActive = false);
                combatants[0].isActive = true;
            }
            renderCombat();
        }

        function renderCombat() {
            const container = document.getElementById('combat-list');

            if (combatants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No combatants. Add characters or NPCs to begin combat.</p>';
                return;
            }

            container.innerHTML = combatants.map((c, index) => `
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg ${c.isActive ? 'ring-2 ring-primary' : ''}">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                ${c.isActive ? '<span class="text-primary text-2xl">▶</span>' : '<span class="text-2xl opacity-0">▶</span>'}
                                <div class="flex-1">
                                    <div class="font-bold text-lg">${c.name}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Initiative: ${c.initiative} | AC: ${c.ac}</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-600 dark:text-gray-400">HP</div>
                                <div class="font-bold ${c.hp <= 0 ? 'text-red-500' : ''}">${c.hp}/${c.hpMax}</div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="adjustCombatantHP(${c.id}, -1)" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-base">-</button>
                                <button onclick="adjustCombatantHP(${c.id}, 1)" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-base">+</button>
                            </div>
                            <button onclick="removeCombatant(${c.id})" class="text-red-500 hover:text-red-700 text-xl">&times;</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function adjustCombatantHP(id, amount) {
            const combatant = combatants.find(c => c.id === id);
            if (!combatant) return;

            combatant.hp = Math.max(0, Math.min(combatant.hpMax, combatant.hp + amount));

            // Update character if linked
            if (combatant.characterId) {
                const char = characters.find(c => c.id === combatant.characterId);
                if (char) {
                    char.hpCurrent = combatant.hp;
                    renderCharacters();
                }
            }

            renderCombat();
        }

        function removeCombatant(id) {
            combatants = combatants.filter(c => c.id !== id);
            renderCombat();
        }

        function clearCombat() {
            showCustomConfirm('Clear all combatants?', () => {
                combatants = [];
                combatRound = 1;
                document.getElementById('combat-round').textContent = combatRound;
                renderCombat();
            });
        }

        function nextRound() {
            combatRound++;
            document.getElementById('combat-round').textContent = combatRound;

            if (combatants.length > 0) {
                const currentIndex = combatants.findIndex(c => c.isActive);
                combatants.forEach(c => c.isActive = false);

                if (currentIndex < combatants.length - 1) {
                    combatants[currentIndex + 1].isActive = true;
                } else {
                    combatants[0].isActive = true;
                }

                renderCombat();
            }
        }

        // Custom dialog functions
        function showCustomConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded text-base">Confirm</button>
                    </div>
                </div>
            `;

            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = () => {
                modal.remove();
                onConfirm();
            };

            document.body.appendChild(modal);
        }

        function showCustomPrompt(message, defaultValue = '') {
            const result = {value: null};
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <input type="text" class="prompt-input w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 mb-4 text-base" value="${defaultValue}">
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-base">Cancel</button>
                        <button class="ok-btn px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded text-base">OK</button>
                    </div>
                </div>
            `;

            const input = modal.querySelector('.prompt-input');
            const done = () => {
                result.value = input.value;
                modal.remove();
            };

            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.ok-btn').onclick = done;
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') done();
            });

            document.body.appendChild(modal);
            input.focus();
            input.select();

            // Synchronous-like behavior using a busy wait (not ideal but works for this use case)
            const startTime = Date.now();
            while (result.value === null && Date.now() - startTime < 60000) {
                // Wait for user input or timeout
                const event = new Promise(resolve => setTimeout(resolve, 10));
            }

            return result.value;
        }

        // Initialize
        renderCharacters();
        renderCombat();
    </script>


</body></html>