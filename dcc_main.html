<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="x-poe-datastore-behavior" content="local_only">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCC Virtual Tabletop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        surface: '#1F1F1F'
                    }
                }
            }
        }
    </script>
    <style>
        .dice-result {
            animation: rollIn 0.3s ease-out;
        }
        @keyframes rollIn {
            from {
                transform: scale(0.5) rotate(180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        .tab-active {
            border-bottom: 3px solid #5D5CDE;
            color: #5D5CDE;
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        .chip {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.125rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .stat-modifier {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .map-grid {
            background-image: linear-gradient(rgba(93, 92, 222, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(93, 92, 222, 0.2) 1px, transparent 1px);
            pointer-events: none;
        }
        .map-marker {
            transform: translate(-50%, -50%);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            pointer-events: auto;
        }
        .map-marker:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }
        .map-marker-active {
            box-shadow: 0 0 0 4px rgba(93, 92, 222, 0.35);
            z-index: 30;
        }
        .map-marker-dim {
            opacity: 0.35;
        }
        .map-marker-label {
            white-space: nowrap;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
            font-size: 0.75rem;
        }
        .dm-log-entry {
            border-left: 3px solid rgba(93, 92, 222, 0.45);
        }
        .dm-note-details summary::-webkit-details-marker {
            display: none;
        }
        .dm-note-summary::marker {
            content: '';
        }
        .dm-note-preview {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
    <script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen transition-colors">
    <div class="max-w-7xl mx-auto p-4 space-y-6">
        <header class="space-y-2 text-center">
            <h1 class="text-3xl md:text-4xl font-bold">DCC Virtual Tabletop</h1>
            <p class="text-gray-600 dark:text-gray-400">Tools for Dungeon Crawl Classics campaigns, characters, and combat.</p>
        </header>

        <section class="flex flex-wrap items-center justify-between gap-3 bg-gray-50 dark:bg-surface p-4 rounded-lg border border-gray-200 dark:border-gray-800">
            <div>
                <h2 class="text-lg font-semibold">Campaign Toolkit</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400">All data is stored locally in your browser. Export regularly to back it up.</p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <button onclick="exportState()" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Export Data</button>
                <label class="px-4 py-2 border border-primary text-primary rounded cursor-pointer hover:bg-primary hover:text-white transition text-sm">
                    <input type="file" id="state-import-input" accept="application/json" class="hidden">
                    Import Data
                </label>
                <button onclick="resetState()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm">Reset</button>
            </div>
        </section>

        <nav class="border-b border-gray-300 dark:border-gray-800">
            <ul class="flex flex-wrap -mb-px text-sm md:text-base">
                <li class="mr-2">
                    <button data-tab="characters" onclick="switchTab('characters')" id="tab-characters" class="tab-active inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Characters</button>
                </li>
                <li class="mr-2">
                    <button data-tab="dice" onclick="switchTab('dice')" id="tab-dice" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Dice Roller</button>
                </li>
                <li class="mr-2">
                    <button data-tab="combat" onclick="switchTab('combat')" id="tab-combat" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Combat Tracker</button>
                </li>
                <li class="mr-2">
                    <button data-tab="map" onclick="switchTab('map')" id="tab-map" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Maps</button>
                </li>
                <li class="mr-2">
                    <button data-tab="tables" onclick="switchTab('tables')" id="tab-tables" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Reference Tables</button>
                </li>
                <li class="mr-2">
                    <button data-tab="campaigns" onclick="switchTab('campaigns')" id="tab-campaigns" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">Campaigns</button>
                </li>
                <li class="mr-2">
                    <button data-tab="dm" onclick="switchTab('dm')" id="tab-dm" class="inline-block p-4 border-b-2 border-transparent hover:text-primary transition">DM Tools</button>
                </li>
            </ul>
        </nav>

        <!-- DM Tools Tab -->
        <section id="content-dm" class="tab-content hidden space-y-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="space-y-1">
                    <h2 class="text-2xl font-bold">DM Control Panel</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Track prep, pace sessions, and surface inspiration without shuffling paper behind the screen.</p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <button onclick="resetDMTools()" class="px-4 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition text-sm">Reset Panel</button>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
                <div class="xl:col-span-2 space-y-4">
                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-semibold">Encounter Builder</h3>
                            <span class="text-xs text-gray-500" id="dm-encounter-count">0 prepped</span>
                        </div>
                        <form id="dm-encounter-form" class="grid grid-cols-1 md:grid-cols-6 gap-3">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold mb-1">Encounter Name</label>
                                <input type="text" name="encounter-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" placeholder="e.g., Goblin ambush" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Quantity</label>
                                <input type="number" name="encounter-quantity" min="1" value="1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Threat</label>
                                <select name="encounter-threat" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                                    <option value="Low">Low</option>
                                    <option value="Moderate">Moderate</option>
                                    <option value="Dangerous">Dangerous</option>
                                    <option value="Deadly">Deadly</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold mb-1">Environment</label>
                                <input type="text" name="encounter-environment" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" placeholder="Ruined temple, swamp trail...">
                            </div>
                            <div class="md:col-span-6">
                                <label class="block text-sm font-semibold mb-1">Tactics & Rewards</label>
                                <textarea name="encounter-notes" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" placeholder="Opening gambit, morale, treasure, complications..."></textarea>
                            </div>
                            <div class="md:col-span-6 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Save Encounter</button>
                            </div>
                        </form>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                            <input type="search" id="dm-encounter-search" placeholder="Search prepped encounters" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                            <button type="button" id="dm-encounter-clear-search" class="px-3 py-2 border border-gray-300 dark:border-gray-700 text-xs rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition">Clear</button>
                        </div>
                        <div id="dm-encounter-list" class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                            <p class="text-xs text-gray-500">No encounters prepped yet.</p>
                        </div>
                    </div>

                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-semibold">Session Notes</h3>
                            <span class="text-xs text-gray-500" id="dm-note-count">0 captured</span>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                            <input type="search" id="dm-note-search" placeholder="Search notes" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                            <label class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                                <input type="checkbox" id="dm-note-spotlight-filter" class="h-4 w-4 text-primary">
                                Spotlight only
                            </label>
                        </div>
                        <form id="dm-note-form" class="space-y-3">
                            <textarea id="dm-note-input" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" placeholder="Summaries, secrets revealed, NPC goals..." required></textarea>
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="dm-note-spotlight" class="h-4 w-4 text-primary">
                                    Spotlight this note
                                </label>
                                <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Log Note</button>
                            </div>
                        </form>
                        <div id="dm-note-list" class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                            <p class="text-xs text-gray-500">No notes logged yet.</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 space-y-3">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-semibold">Session Clock</h3>
                            <span class="text-xs text-gray-500" id="dm-stopwatch-status">Idle</span>
                        </div>
                        <div class="text-3xl font-bold text-primary" id="dm-stopwatch-display">00:00:00</div>
                        <div class="flex flex-wrap gap-2">
                            <button id="dm-stopwatch-start" class="flex-1 px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Start</button>
                            <button id="dm-stopwatch-pause" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition text-sm">Pause</button>
                            <button id="dm-stopwatch-reset" class="flex-1 px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm">Reset</button>
                        </div>
                    </div>

                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 space-y-3">
                        <h3 class="text-xl font-semibold">Resource Trackers</h3>
                        <div id="dm-trackers" class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm"></div>
                    </div>

                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 space-y-3">
                        <h3 class="text-xl font-semibold">Inspiration Engine</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <button id="dm-random-weather" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Weather</button>
                            <button id="dm-random-complication" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Complication</button>
                            <button id="dm-random-treasure" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Treasure Hook</button>
                            <button id="dm-random-npc" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">NPC Quirk</button>
                        </div>
                        <div id="dm-random-history" class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                            <p class="text-xs text-gray-500">Roll the inspiration engine to populate this log.</p>
                        </div>
                    </div>

                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 space-y-4">
                        <div class="flex flex-col gap-1 sm:flex-row sm:items-start sm:justify-between">
                            <div>
                                <h3 class="text-xl font-semibold">AI Co-DM Helper</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Bundle your prep into prompt-ready snippets for your favorite assistant.</p>
                            </div>
                            <button id="dm-ai-refresh-context" class="self-start px-3 py-1 text-xs border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition">Refresh</button>
                        </div>
                        <div class="flex flex-wrap gap-2 text-xs text-gray-500 dark:text-gray-400">
                            <span class="chip bg-white/70 dark:bg-gray-900/60 border border-gray-200 dark:border-gray-700">Encounters: <span id="dm-ai-encounter-count" class="ml-1 font-semibold text-gray-800 dark:text-gray-200">0</span></span>
                            <span class="chip bg-white/70 dark:bg-gray-900/60 border border-gray-200 dark:border-gray-700">Notes: <span id="dm-ai-note-count" class="ml-1 font-semibold text-gray-800 dark:text-gray-200">0</span></span>
                            <span class="chip bg-white/70 dark:bg-gray-900/60 border border-gray-200 dark:border-gray-700">Spotlight: <span id="dm-ai-spotlight-count" class="ml-1 font-semibold text-gray-800 dark:text-gray-200">0</span></span>
                            <span class="chip bg-white/70 dark:bg-gray-900/60 border border-gray-200 dark:border-gray-700">Inspiration: <span id="dm-ai-inspiration-count" class="ml-1 font-semibold text-gray-800 dark:text-gray-200">0</span></span>
                        </div>
                        <div class="space-y-2">
                            <h4 class="text-sm font-semibold">Context Builder</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Toggle which prep elements flow into the context snapshot before you copy it out.</p>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-xs sm:text-sm">
                                <label class="flex items-center gap-2 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 bg-white/70 dark:bg-gray-900/60 cursor-pointer hover:border-primary transition">
                                    <input type="checkbox" class="dm-ai-context-toggle accent-primary" data-ai-toggle="encounters" checked>
                                    <span>Upcoming Encounters</span>
                                </label>
                                <label class="flex items-center gap-2 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 bg-white/70 dark:bg-gray-900/60 cursor-pointer hover:border-primary transition">
                                    <input type="checkbox" class="dm-ai-context-toggle accent-primary" data-ai-toggle="resolved" checked>
                                    <span>Recent Victories</span>
                                </label>
                                <label class="flex items-center gap-2 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 bg-white/70 dark:bg-gray-900/60 cursor-pointer hover:border-primary transition">
                                    <input type="checkbox" class="dm-ai-context-toggle accent-primary" data-ai-toggle="spotlight" checked>
                                    <span>Spotlight Moments</span>
                                </label>
                                <label class="flex items-center gap-2 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 bg-white/70 dark:bg-gray-900/60 cursor-pointer hover:border-primary transition">
                                    <input type="checkbox" class="dm-ai-context-toggle accent-primary" data-ai-toggle="beats" checked>
                                    <span>Recent Beats</span>
                                </label>
                                <label class="flex items-center gap-2 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 bg-white/70 dark:bg-gray-900/60 cursor-pointer hover:border-primary transition">
                                    <input type="checkbox" class="dm-ai-context-toggle accent-primary" data-ai-toggle="trackers" checked>
                                    <span>Resource Trackers</span>
                                </label>
                                <label class="flex items-center gap-2 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 bg-white/70 dark:bg-gray-900/60 cursor-pointer hover:border-primary transition">
                                    <input type="checkbox" class="dm-ai-context-toggle accent-primary" data-ai-toggle="inspiration" checked>
                                    <span>Inspiration Log</span>
                                </label>
                                <label class="flex items-center gap-2 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 bg-white/70 dark:bg-gray-900/60 cursor-pointer hover:border-primary transition">
                                    <input type="checkbox" class="dm-ai-context-toggle accent-primary" data-ai-toggle="clock" checked>
                                    <span>Session Clock</span>
                                </label>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Context Snapshot</label>
                            <textarea id="dm-ai-context" rows="6" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" readonly placeholder="Log encounters or spotlight notes to build AI-ready context."></textarea>
                            <div class="flex justify-end">
                                <button id="dm-ai-copy-context" class="px-3 py-2 text-xs border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Copy Context</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <h4 class="text-sm font-semibold">Prompt Starters</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                                <button data-ai-prompt="session-recap" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Session Recap</button>
                                <button data-ai-prompt="encounter-escalation" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Encounter Twist</button>
                                <button data-ai-prompt="npc-dialogue" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">NPC Roleplay</button>
                                <button data-ai-prompt="downtime-hooks" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Downtime Hooks</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <h4 class="text-sm font-semibold">Creative Boosters</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                                <button data-ai-prompt="scene-painting" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Scene Painting</button>
                                <button data-ai-prompt="momentum-plan" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Momentum Plan</button>
                                <button data-ai-prompt="rules-lookup" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Rule Spotlight</button>
                                <button data-ai-prompt="treasure-upgrade" class="px-3 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Treasure Upgrade</button>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <h4 class="text-sm font-semibold">AI Voice &amp; Format</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm">
                                <label class="flex flex-col gap-1">
                                    <span class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Tone</span>
                                    <select id="dm-ai-tone" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                                        <option value="neutral" selected>Neutral Narrator</option>
                                        <option value="grim">Grim &amp; Perilous</option>
                                        <option value="whimsical">Weird &amp; Whimsical</option>
                                        <option value="epic">Mythic &amp; Heroic</option>
                                    </select>
                                </label>
                                <label class="flex flex-col gap-1">
                                    <span class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Structure</span>
                                    <select id="dm-ai-structure" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                                        <option value="auto" selected>Let AI Decide</option>
                                        <option value="bullet">Bullet Lists</option>
                                        <option value="narrative">Narrative Prose</option>
                                        <option value="dialogue">Dialogue Beats</option>
                                    </select>
                                </label>
                                <label class="flex flex-col gap-1">
                                    <span class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Length</span>
                                    <select id="dm-ai-length" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                                        <option value="tight">Punchy</option>
                                        <option value="standard" selected>Balanced Detail</option>
                                        <option value="epic">Sweeping</option>
                                    </select>
                                </label>
                            </div>
                            <p id="dm-ai-style-preview" class="text-xs text-gray-500 dark:text-gray-400">Neutral narrator • Format: adaptive • Length: balanced detail</p>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Working Prompt</label>
                            <textarea id="dm-ai-prompt-output" rows="4" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" placeholder="Press a prompt starter or draft your own request for the AI."></textarea>
                            <div class="flex flex-wrap justify-end gap-2">
                                <button id="dm-ai-append-context" class="px-3 py-2 text-xs border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Append Context</button>
                                <button id="dm-ai-clear-prompt" class="px-3 py-2 text-xs border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition">Clear</button>
                                <button id="dm-ai-copy-prompt" class="px-3 py-2 text-xs bg-primary text-white rounded hover:bg-opacity-90 transition">Copy Prompt</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <h4 class="text-sm font-semibold">AI Launch Pad</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Package your prompt, context, and style directives, then jump straight into your preferred assistant.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                                <label class="flex flex-col gap-1">
                                    <span class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Assistant Target</span>
                                    <select id="dm-ai-provider" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                                        <option value="poe">Poe (multi-model)</option>
                                        <option value="chatgpt">ChatGPT</option>
                                        <option value="claude">Claude</option>
                                        <option value="gemini">Gemini</option>
                                        <option value="custom">Custom URL</option>
                                    </select>
                                </label>
                                <label id="dm-ai-provider-url-wrapper" class="flex flex-col gap-1 hidden">
                                    <span class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Custom Assistant URL</span>
                                    <input id="dm-ai-provider-url" type="url" class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" placeholder="https://assistant.example.com/session">
                                </label>
                                <label class="flex items-center gap-2 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 bg-white/70 dark:bg-gray-900/60 cursor-pointer">
                                    <input type="checkbox" id="dm-ai-include-context" class="accent-primary" checked>
                                    <span class="text-xs sm:text-sm">Attach context snapshot automatically</span>
                                </label>
                                <label class="flex items-center gap-2 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 bg-white/70 dark:bg-gray-900/60 cursor-pointer">
                                    <input type="checkbox" id="dm-ai-include-style" class="accent-primary" checked>
                                    <span class="text-xs sm:text-sm">Include style guide directives</span>
                                </label>
                                <label class="flex items-center gap-2 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 bg-white/70 dark:bg-gray-900/60 cursor-pointer sm:col-span-2">
                                    <input type="checkbox" id="dm-ai-auto-copy" class="accent-primary" checked>
                                    <span class="text-xs sm:text-sm">Copy final prompt to clipboard when launching</span>
                                </label>
                            </div>
                            <p id="dm-ai-provider-hint" class="text-xs text-gray-500 dark:text-gray-400"></p>
                            <textarea id="dm-ai-full-preview" rows="4" class="w-full px-3 py-2 border border-dashed border-gray-300 dark:border-gray-700 rounded bg-white/70 dark:bg-gray-900/60 text-sm" readonly placeholder="Build a working prompt or context to preview the final AI hand-off."></textarea>
                            <div class="flex flex-wrap justify-end gap-2">
                                <button id="dm-ai-preview-full" class="px-3 py-2 text-xs border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition">Refresh Preview</button>
                                <button id="dm-ai-copy-full" class="px-3 py-2 text-xs border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Copy Final Prompt</button>
                                <button id="dm-ai-launch" class="px-3 py-2 text-xs bg-primary text-white rounded hover:bg-opacity-90 transition">Open AI Chat</button>
                            </div>
                            <p id="dm-ai-launch-status" class="text-xs text-gray-500 dark:text-gray-400"></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Characters Tab -->
        <section id="content-characters" class="tab-content space-y-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="space-y-1">
                    <h2 class="text-2xl font-bold">Characters</h2>
                    <p class="text-gray-600 dark:text-gray-400 text-sm">Manage PCs, retainers, and notable NPCs. Quick search helps you find a hero mid-session.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="showCharacterForm()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-sm">+ New Character</button>
                    <button onclick="rollZeroLevelCharacter()" class="px-4 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition text-sm">Generate 0-Level</button>
                </div>
            </div>

            <div id="character-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"></div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 space-y-3 border border-gray-200 dark:border-gray-800">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Search</label>
                        <input type="text" id="character-search" placeholder="Search by name or note" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Class Filter</label>
                        <select id="character-class-filter" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                            <option value="all">All Classes</option>
                            <option>Warrior</option>
                            <option>Wizard</option>
                            <option>Cleric</option>
                            <option>Thief</option>
                            <option>Dwarf</option>
                            <option>Elf</option>
                            <option>Halfling</option>
                            <option>Peasant</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Status Filter</label>
                        <select id="character-status-filter" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                            <option value="all">All Heroes</option>
                            <option value="ready">Battle Ready (≥ 50% HP)</option>
                            <option value="injured">Injured (&lt; 50% HP)</option>
                            <option value="down">Down / 0 HP</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Sort</label>
                        <select id="character-sort" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                            <option value="name">Name (A-Z)</option>
                            <option value="class">Class</option>
                            <option value="level">Level</option>
                            <option value="luck">Luck</option>
                        </select>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <div id="character-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </section>

        <!-- Dice Tab -->
        <section id="content-dice" class="tab-content hidden space-y-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold">Dice Roller</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Track your table rolls, save macros, and automate funky DCC dice.</p>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-semibold">d20 Mode</label>
                    <select id="advantage-mode" class="px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                        <option value="normal">Normal</option>
                        <option value="advantage">Advantage</option>
                        <option value="disadvantage">Disadvantage</option>
                    </select>
                </div>
            </div>

            <div id="dice-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"></div>

            <div class="bg-gray-50 dark:bg-surface rounded-lg p-6 border border-gray-200 dark:border-gray-800 space-y-6">
                <div class="grid grid-cols-3 sm:grid-cols-6 lg:grid-cols-9 gap-2">
                    <button onclick="rollDice(3)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d3</button>
                    <button onclick="rollDice(4)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d4</button>
                    <button onclick="rollDice(5)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d5</button>
                    <button onclick="rollDice(6)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d6</button>
                    <button onclick="rollDice(7)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d7</button>
                    <button onclick="rollDice(8)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d8</button>
                    <button onclick="rollDice(10)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d10</button>
                    <button onclick="rollDice(12)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d12</button>
                    <button onclick="rollDice(14)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d14</button>
                    <button onclick="rollDice(16)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d16</button>
                    <button onclick="rollDice(18)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d18</button>
                    <button onclick="rollDice(20)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d20</button>
                    <button onclick="rollDice(24)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d24</button>
                    <button onclick="rollDice(30)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d30</button>
                    <button onclick="rollDice(100)" class="dice-btn bg-primary text-white px-3 py-3 rounded hover:bg-opacity-90 transition text-base font-bold">d%</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block mb-2 font-semibold">Number of Dice</label>
                        <input type="number" id="dice-count" value="1" min="1" max="50" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Modifier</label>
                        <input type="number" id="dice-modifier" value="0" min="-50" max="50" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Roll Description</label>
                        <input type="text" id="roll-description" placeholder="e.g., Mighty deed, Reflex save" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                    </div>
                </div>

                <div class="space-y-3">
                    <h3 class="text-xl font-bold">Custom Formula</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Supports expressions like <span class="font-semibold">2d20+5</span>, <span class="font-semibold">3d6+1d4-2</span>, or <span class="font-semibold">1d30+Luck</span> (replace Luck manually). Save your favorite rolls below.</p>
                    <div class="flex flex-col md:flex-row gap-2">
                        <input type="text" id="custom-formula" placeholder="Enter dice formula" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        <input type="text" id="custom-label" placeholder="Label (optional)" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-base">
                        <button onclick="rollCustomFormula()" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition">Roll</button>
                        <button onclick="saveCustomFormula()" class="px-4 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Save Macro</button>
                    </div>
                    <p id="dice-error" class="text-sm text-red-500 hidden"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="lg:col-span-2 bg-gray-50 dark:bg-surface rounded-lg p-6 border border-gray-200 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">Roll Results</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="clearRollHistory()" class="px-3 py-1 text-sm border border-red-400 text-red-500 rounded hover:bg-red-500 hover:text-white transition">Clear</button>
                        </div>
                    </div>
                    <div id="dice-results" class="space-y-3 max-h-[28rem] overflow-y-auto">
                        <p class="text-gray-500 dark:text-gray-400 text-center py-12">Roll dice to populate the log.</p>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-surface rounded-lg p-6 border border-gray-200 dark:border-gray-800">
                    <h3 class="text-xl font-bold mb-3">Saved Macros</h3>
                    <div id="saved-rolls" class="space-y-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Save a custom formula to keep it handy for play.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Combat Tab -->
        <section id="content-combat" class="tab-content hidden space-y-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="space-y-1">
                    <h2 class="text-2xl font-bold">Combat Tracker</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Initiative order, hit point tracking, and round management for hectic fights.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="sortInitiative()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">Sort Initiative</button>
                    <button onclick="advanceCombat(1)" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Next Turn</button>
                    <button onclick="advanceCombat(-1)" class="px-4 py-2 border border-primary text-primary rounded hover:bg-primary hover:text-white transition text-sm">Previous Turn</button>
                    <button onclick="clearCombat()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm">Clear</button>
                </div>
            </div>

            <div id="combat-summary" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3"></div>

            <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-6 space-y-4">
                <form id="combat-form" class="grid grid-cols-1 lg:grid-cols-6 gap-3">
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-semibold mb-1">Name</label>
                        <input type="text" id="combat-name" required class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm" placeholder="NPC or monster name">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Initiative</label>
                        <input type="number" id="combat-init" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm" placeholder="Leave blank to roll">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Init Mod</label>
                        <input type="number" id="combat-init-mod" value="0" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">HP</label>
                        <input type="number" id="combat-hp" value="10" min="0" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">AC</label>
                        <input type="number" id="combat-ac" value="10" min="0" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-semibold mb-1">Tags</label>
                        <input type="text" id="combat-tags" placeholder="PC, undead, spellcaster" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                    </div>
                    <div class="lg:col-span-4">
                        <label class="block text-sm font-semibold mb-1">Notes</label>
                        <input type="text" id="combat-notes" placeholder="Weak to fire, morale 6" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Type</label>
                        <select id="combat-type" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                            <option value="pc">PC</option>
                            <option value="npc">NPC</option>
                            <option value="monster">Monster</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Add Combatant</button>
                    </div>
                </form>
                <div class="flex items-center gap-3">
                    <div class="text-sm font-semibold">Round:</div>
                    <div id="combat-round" class="text-2xl font-bold text-primary">1</div>
                    <button onclick="updateCombatRound(-1)" class="px-3 py-1 border border-primary text-primary rounded hover:bg-primary hover:text-white transition text-sm">-</button>
                    <button onclick="updateCombatRound(1)" class="px-3 py-1 border border-primary text-primary rounded hover:bg-primary hover:text-white transition text-sm">+</button>
                    <button onclick="resetCombatRound()" class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-primary">Reset</button>
                </div>
            </div>

            <div id="combat-list" class="space-y-3"></div>
        </section>

        <!-- Map Tab -->
        <section id="content-map" class="tab-content hidden space-y-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="space-y-1">
                    <h2 class="text-2xl font-bold">Map Room</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Upload battlemaps or world vistas, drop markers, and keep keyed notes handy for play.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <label class="px-4 py-2 border border-primary text-primary rounded cursor-pointer hover:bg-primary hover:text-white transition text-sm">
                        <input type="file" id="map-upload" accept="image/*" class="hidden">
                        Upload Image
                    </label>
                    <button onclick="clearMap()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm">Clear Map</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="lg:col-span-2 space-y-3">
                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 space-y-3">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                <p>Click anywhere on the map to capture coordinates for your next marker.</p>
                                <p id="map-uploaded-name">No map loaded.</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-4">
                                <label class="flex items-center gap-2 text-xs font-semibold uppercase text-gray-500">
                                    <input type="checkbox" id="map-grid-toggle" class="h-4 w-4 text-primary" checked>
                                    Show Grid
                                </label>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500">Grid Size</span>
                                    <input type="range" id="map-grid-size" min="20" max="120" value="50" class="w-28">
                                    <span id="map-grid-size-display" class="text-xs font-semibold text-primary">50 px</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500">Zoom</span>
                                    <input type="range" id="map-zoom" min="50" max="200" value="100" class="w-28">
                                    <span id="map-zoom-display" class="text-xs font-semibold text-primary">100%</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400" id="map-coordinate-hint">No marker selected.</div>
                    </div>
                    <div id="map-scroll" class="relative overflow-auto bg-gray-900 rounded-lg border border-gray-800 h-[26rem]">
                        <div id="map-placeholder" class="absolute inset-0 flex items-center justify-center text-center px-6 text-sm text-gray-400">
                            Upload a map image to begin plotting the dungeon.
                        </div>
                        <div id="map-inner" class="relative select-none" style="display: none;">
                            <img id="map-image" alt="Campaign map" class="block max-w-none">
                            <div id="map-grid" class="map-grid absolute inset-0 opacity-50"></div>
                            <div id="map-marker-layer" class="absolute inset-0 pointer-events-none"></div>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 space-y-3">
                        <h3 class="text-lg font-semibold">Add Marker</h3>
                        <form id="map-marker-form" class="space-y-3">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Label</label>
                                <input type="text" id="map-marker-label" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" placeholder="Secret door, camp, hazard..." required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Description</label>
                                <textarea id="map-marker-note" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" placeholder="Optional notes"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">X (%)</label>
                                    <input type="number" id="map-marker-x" min="0" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Y (%)</label>
                                    <input type="number" id="map-marker-y" min="0" max="100" step="0.1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Marker Color</label>
                                <select id="map-marker-color" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                                    <option value="primary">Primary</option>
                                    <option value="emerald">Emerald</option>
                                    <option value="amber">Amber</option>
                                    <option value="rose">Rose</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Drop Marker</button>
                        </form>
                        <div class="flex flex-wrap items-center justify-between gap-2 text-xs text-gray-500 dark:text-gray-400">
                            <p id="map-marker-mode-hint" class="flex-1 text-gray-500 dark:text-gray-400">Drop a new marker anywhere on the map.</p>
                            <button type="button" id="map-marker-cancel-edit" class="text-red-500 hover:text-red-600 hidden">Cancel edit</button>
                        </div>
                        <p class="text-xs text-gray-500" id="map-coordinates-display">Click the map to seed coordinates.</p>
                    </div>
                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 space-y-3">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">Markers</h3>
                            <span class="text-xs text-gray-500" id="map-marker-count">0</span>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                            <input type="search" id="map-marker-search" placeholder="Search markers" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                            <button type="button" id="map-marker-clear-search" class="px-3 py-2 border border-gray-300 dark:border-gray-700 text-xs rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition">Clear</button>
                        </div>
                        <div id="map-marker-list" class="space-y-2 max-h-64 overflow-y-auto text-sm text-gray-700 dark:text-gray-300">
                            <p class="text-xs text-gray-500">No markers yet.</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 space-y-2">
                        <h3 class="text-lg font-semibold">Map Notes</h3>
                        <textarea id="map-notes" rows="4" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" placeholder="Area legends, keyed references, or travel reminders."></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reference Tables -->
        <section id="content-tables" class="tab-content hidden space-y-4">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold mb-2">Reference Tables</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Quick lookups for common DCC rulings and random inspiration.</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="table-search" placeholder="Search tables" class="w-full sm:w-64 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                    <button id="table-random-btn" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Roll Inspiration</button>
                </div>
            </div>
            <div id="table-random-panel" class="hidden bg-gray-50 dark:bg-surface border border-primary/40 dark:border-primary/60 rounded-lg p-4 text-sm text-gray-700 dark:text-gray-300"></div>
            <p id="table-search-empty" class="hidden text-sm text-gray-500 dark:text-gray-400">No tables match the current search.</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 border border-gray-200 dark:border-gray-800" data-table-card data-table-name="Critical Hits (d20)">
                    <h3 class="text-xl font-bold mb-3">Critical Hits (d20)</h3>
                    <ul class="space-y-2 text-sm">
                        <li data-table-entry><span class="font-semibold">1-6:</span> Normal damage</li>
                        <li data-table-entry><span class="font-semibold">7-11:</span> +1d6 damage</li>
                        <li data-table-entry><span class="font-semibold">12-13:</span> +2d6 damage</li>
                        <li data-table-entry><span class="font-semibold">14-15:</span> +3d6 damage</li>
                        <li data-table-entry><span class="font-semibold">16-17:</span> +1d10 damage + bleed 1d6</li>
                        <li data-table-entry><span class="font-semibold">18:</span> +2d10 damage + bleed 1d6</li>
                        <li data-table-entry><span class="font-semibold">19:</span> +3d10 damage + bleed 2d6</li>
                        <li data-table-entry><span class="font-semibold">20:</span> +4d10 damage + limb/organ damage</li>
                    </ul>
                </div>

                <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 border border-gray-200 dark:border-gray-800" data-table-card data-table-name="Fumbles (d8)">
                    <h3 class="text-xl font-bold mb-3">Fumbles (d8)</h3>
                    <ul class="space-y-2 text-sm">
                        <li data-table-entry><span class="font-semibold">1:</span> Drop weapon</li>
                        <li data-table-entry><span class="font-semibold">2:</span> Slip, lose next action</li>
                        <li data-table-entry><span class="font-semibold">3:</span> Twist ankle, -5 ft movement</li>
                        <li data-table-entry><span class="font-semibold">4:</span> Stumble, foe gets free attack</li>
                        <li data-table-entry><span class="font-semibold">5:</span> Hit ally for normal damage</li>
                        <li data-table-entry><span class="font-semibold">6:</span> Weapon stuck, DC 10 STR to free</li>
                        <li data-table-entry><span class="font-semibold">7:</span> Armor strap breaks, -1 AC</li>
                        <li data-table-entry><span class="font-semibold">8:</span> Weapon damaged, -1 to hit</li>
                    </ul>
                </div>

                <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 border border-gray-200 dark:border-gray-800" data-table-card data-table-name="Ability Score Modifiers">
                    <h3 class="text-xl font-bold mb-3">Ability Score Modifiers</h3>
                    <ul class="grid grid-cols-2 gap-2 text-sm">
                        <li data-table-entry><span class="font-semibold">3:</span> -3</li>
                        <li data-table-entry><span class="font-semibold">4-5:</span> -2</li>
                        <li data-table-entry><span class="font-semibold">6-8:</span> -1</li>
                        <li data-table-entry><span class="font-semibold">9-12:</span> 0</li>
                        <li data-table-entry><span class="font-semibold">13-15:</span> +1</li>
                        <li data-table-entry><span class="font-semibold">16-17:</span> +2</li>
                        <li data-table-entry><span class="font-semibold">18:</span> +3</li>
                    </ul>
                </div>

                <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 border border-gray-200 dark:border-gray-800" data-table-card data-table-name="Luck Uses">
                    <h3 class="text-xl font-bold mb-3">Luck Uses</h3>
                    <ul class="space-y-2 text-sm">
                        <li data-table-entry>Modify any roll before or after it is made.</li>
                        <li data-table-entry>Improve critical hit/fumble results.</li>
                        <li data-table-entry>Adjust initiative order.</li>
                        <li data-table-entry>Discover lucky finds or clues.</li>
                        <li data-table-entry>Snatch survival from the jaws of death.</li>
                        <li data-table-entry class="italic">Luck spent is permanent unless magically restored.</li>
                    </ul>
                </div>

                <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 border border-gray-200 dark:border-gray-800" data-table-card data-table-name="Action Dice by Level">
                    <h3 class="text-xl font-bold mb-3">Action Dice by Level</h3>
                    <ul class="space-y-2 text-sm">
                        <li data-table-entry><span class="font-semibold">Level 1-4:</span> 1d20</li>
                        <li data-table-entry><span class="font-semibold">Level 5:</span> 1d20 + 1d14</li>
                        <li data-table-entry><span class="font-semibold">Level 6-7:</span> 1d20 + 1d16</li>
                        <li data-table-entry><span class="font-semibold">Level 8-9:</span> 1d20 + 1d20</li>
                        <li data-table-entry><span class="font-semibold">Level 10:</span> 1d20 + 1d20 + 1d14</li>
                        <li data-table-entry class="text-xs italic">Warriors gain additional dice at higher levels.</li>
                    </ul>
                </div>

                <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 border border-gray-200 dark:border-gray-800" data-table-card data-table-name="Spell Corruption (d10)">
                    <h3 class="text-xl font-bold mb-3">Spell Corruption (d10)</h3>
                    <ul class="space-y-2 text-sm">
                        <li data-table-entry><span class="font-semibold">1:</span> Eyes glow when casting</li>
                        <li data-table-entry><span class="font-semibold">2:</span> Hair turns white/silver</li>
                        <li data-table-entry><span class="font-semibold">3:</span> Skin becomes pallid</li>
                        <li data-table-entry><span class="font-semibold">4:</span> Fingernails blacken</li>
                        <li data-table-entry><span class="font-semibold">5:</span> Voice becomes raspy</li>
                        <li data-table-entry><span class="font-semibold">6:</span> Aura chills nearby air</li>
                        <li data-table-entry><span class="font-semibold">7:</span> Smell of ozone or brimstone</li>
                        <li data-table-entry><span class="font-semibold">8:</span> Horn nubs sprout</li>
                        <li data-table-entry><span class="font-semibold">9:</span> Shadow acts independently</li>
                        <li data-table-entry><span class="font-semibold">10:</span> Runes scar across skin</li>
                    </ul>
                </div>
                <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 border border-gray-200 dark:border-gray-800" data-table-card data-table-name="Mighty Deeds Inspiration (d5)">
                    <h3 class="text-xl font-bold mb-3">Mighty Deeds Inspiration (d5)</h3>
                    <ul class="space-y-2 text-sm">
                        <li data-table-entry><span class="font-semibold">1:</span> Disarm or batter aside a foe's weapon</li>
                        <li data-table-entry><span class="font-semibold">2:</span> Shove an enemy into hazards or off balance</li>
                        <li data-table-entry><span class="font-semibold">3:</span> Rally allies, granting +1 to hit this round</li>
                        <li data-table-entry><span class="font-semibold">4:</span> Smash shields or armor, reducing AC by 1</li>
                        <li data-table-entry><span class="font-semibold">5:</span> Seize the initiative, acting again at the end of the round</li>
                    </ul>
                </div>
                <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 border border-gray-200 dark:border-gray-800" data-table-card data-table-name="Dungeon Hazards (d6)">
                    <h3 class="text-xl font-bold mb-3">Dungeon Hazards (d6)</h3>
                    <ul class="space-y-2 text-sm">
                        <li data-table-entry><span class="font-semibold">1:</span> Collapsing ceiling (Reflex DC 12 or 1d6 damage)</li>
                        <li data-table-entry><span class="font-semibold">2:</span> Poison needle trap (Fort DC 10 or 1d4 damage + 1 CON)</li>
                        <li data-table-entry><span class="font-semibold">3:</span> Hidden pit, 10 ft drop (1d6 damage)</li>
                        <li data-table-entry><span class="font-semibold">4:</span> Swarm of bats erupts, imposing -2 to ranged attacks</li>
                        <li data-table-entry><span class="font-semibold">5:</span> Sudden darkness; treat light sources as sputtering</li>
                        <li data-table-entry><span class="font-semibold">6:</span> Arcane glyph explodes (Will DC 12 or lose next action)</li>
                    </ul>
                </div>
                <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 border border-gray-200 dark:border-gray-800" data-table-card data-table-name="Treasure Finds (d8)">
                    <h3 class="text-xl font-bold mb-3">Treasure Finds (d8)</h3>
                    <ul class="space-y-2 text-sm">
                        <li data-table-entry><span class="font-semibold">1:</span> Pouch of 3d12 silver coins</li>
                        <li data-table-entry><span class="font-semibold">2:</span> Minor potion (roll on mercurial effects when imbibed)</li>
                        <li data-table-entry><span class="font-semibold">3:</span> Map fragment hinting at a hidden level</li>
                        <li data-table-entry><span class="font-semibold">4:</span> Bundle of exotic trade goods worth 50 gp</li>
                        <li data-table-entry><span class="font-semibold">5:</span> +1 weapon with an odd personality quirk</li>
                        <li data-table-entry><span class="font-semibold">6:</span> Cache of rare spell components</li>
                        <li data-table-entry><span class="font-semibold">7:</span> Idol that whispers secrets, but demands a price</li>
                        <li data-table-entry><span class="font-semibold">8:</span> Hoard of gems worth 3d6 × 10 gp</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Campaigns Tab -->
        <section id="content-campaigns" class="tab-content hidden space-y-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="space-y-1">
                    <h2 class="text-2xl font-bold">Campaigns</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Organize adventures, track session notes, and keep a living world bible.</p>
                </div>
                <button onclick="showCampaignForm()" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90 transition text-sm">+ New Campaign</button>
            </div>
            <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Search</label>
                        <input type="text" id="campaign-search" placeholder="Search by name, player, or note" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Judge Filter</label>
                        <input type="text" id="campaign-judge-filter" placeholder="Judge name" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Sort</label>
                        <select id="campaign-sort" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                            <option value="recent">Recently Updated</option>
                            <option value="name">Name (A-Z)</option>
                            <option value="sessions">Most Sessions</option>
                        </select>
                    </div>
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-400">Filters apply instantly so you can surface the right campaign dashboard during play.</p>
            </div>

            <div id="campaign-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"></div>
            <div id="campaign-timeline" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
            <div id="campaign-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>
    </div>

    <!-- Character Form Modal -->
    <div id="character-form-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <h3 id="character-form-title" class="text-2xl font-bold">Create Character</h3>
                    <button onclick="hideCharacterForm()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <form id="character-form" class="space-y-4">
                    <input type="hidden" id="char-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Name</label>
                            <input type="text" id="char-name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Class</label>
                            <input type="text" id="char-class" list="class-options" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                            <datalist id="class-options">
                                <option value="Warrior"></option>
                                <option value="Wizard"></option>
                                <option value="Cleric"></option>
                                <option value="Thief"></option>
                                <option value="Dwarf"></option>
                                <option value="Elf"></option>
                                <option value="Halfling"></option>
                                <option value="Peasant"></option>
                                <option value="Other"></option>
                            </datalist>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Level</label>
                            <input type="number" id="char-level" value="0" min="0" max="10" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Alignment</label>
                            <select id="char-alignment" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                                <option value="Lawful">Lawful</option>
                                <option value="Neutral">Neutral</option>
                                <option value="Chaotic">Chaotic</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                        <div>
                            <label class="block text-xs font-semibold mb-1">STR</label>
                            <input type="number" id="char-str" value="10" min="3" max="18" required class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1">AGI</label>
                            <input type="number" id="char-agi" value="10" min="3" max="18" required class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1">STA</label>
                            <input type="number" id="char-sta" value="10" min="3" max="18" required class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1">PER</label>
                            <input type="number" id="char-per" value="10" min="3" max="18" required class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1">INT</label>
                            <input type="number" id="char-int" value="10" min="3" max="18" required class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1">LUC</label>
                            <input type="number" id="char-luc" value="10" min="3" max="18" required class="w-full px-2 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">HP (Max)</label>
                            <input type="number" id="char-hp-max" value="4" min="1" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Current HP</label>
                            <input type="number" id="char-hp-current" value="4" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Armor Class</label>
                            <input type="number" id="char-ac" value="10" min="1" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Speed (ft)</label>
                            <input type="number" id="char-speed" value="30" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Lucky Sign</label>
                            <input type="text" id="char-lucky" placeholder="Born on the battlefield, Raised by wolves..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Languages</label>
                            <input type="text" id="char-languages" placeholder="Common, Elf, Demonic" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1">Equipment & Notes</label>
                        <textarea id="char-equipment" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1">Story Notes</label>
                        <textarea id="char-notes" rows="3" placeholder="Allies, debts, secrets, spellbooks..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm"></textarea>
                    </div>

                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="hideCharacterForm()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-sm">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-sm">Save Character</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Character Detail Modal -->
    <div id="character-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <h3 id="detail-char-name" class="text-2xl font-bold"></h3>
                    <button onclick="hideCharacterDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="character-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Campaign Form Modal -->
    <div id="campaign-form-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <h3 id="campaign-form-title" class="text-2xl font-bold">Create Campaign</h3>
                    <button onclick="hideCampaignForm()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <form id="campaign-form" class="space-y-4">
                    <input type="hidden" id="campaign-id">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Campaign Name</label>
                        <input type="text" id="campaign-name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Judge</label>
                            <input type="text" id="campaign-judge" placeholder="Who runs this saga?" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Players</label>
                            <input type="text" id="campaign-players" placeholder="Comma separated" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Pitch</label>
                        <textarea id="campaign-description" rows="3" placeholder="Brief description or adventure hook." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Notes</label>
                        <textarea id="campaign-notes" rows="3" placeholder="Session zero notes, house rules, factions..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm"></textarea>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="hideCampaignForm()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition text-sm">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition text-sm">Save Campaign</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Campaign Detail Modal -->
    <div id="campaign-detail-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <h3 id="detail-campaign-name" class="text-2xl font-bold"></h3>
                    <button onclick="hideCampaignDetail()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">×</button>
                </div>
                <div id="campaign-detail-content"></div>
            </div>
        </div>
    </div>
    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }

        const storageKey = 'dcc-tabletop-state-v2';
        const tabKey = 'dcc-active-tab';
        const defaultDMAISettings = {
            toggles: {
                encounters: true,
                resolved: true,
                spotlight: true,
                beats: true,
                trackers: true,
                inspiration: true,
                clock: true
            },
            tone: 'neutral',
            structure: 'auto',
            length: 'standard',
            includeContext: true,
            includeStyleGuide: true,
            autoCopyFull: true,
            provider: 'poe',
            customProviderUrl: ''
        };
        const defaultState = {
            characters: [],
            campaigns: [],
            diceHistory: [],
            savedRolls: [],
            combat: {
                round: 1,
                activeId: null,
                combatants: []
            },
            map: {
                image: '',
                imageName: '',
                dimensions: null,
                zoom: 100,
                gridSize: 50,
                showGrid: true,
                markers: [],
                notes: ''
            },
            dm: {
                encounters: [],
                sessionNotes: [],
                trackers: {
                    torchBurn: 0,
                    doomClock: 0,
                    favor: 0
                },
                stopwatch: {
                    running: false,
                    startedAt: null,
                    elapsed: 0
                },
                randomHistory: [],
                aiSettings: JSON.parse(JSON.stringify(defaultDMAISettings))
            }
        };

        const uiState = {
            characterSearch: '',
            characterClass: 'all',
            characterStatus: 'all',
            characterSort: 'name',
            campaignSearch: '',
            campaignJudge: '',
            campaignSort: 'recent',
            tableSearch: '',
            mapMarkerSearch: '',
            dmEncounterSearch: '',
            dmNoteSearch: '',
            dmNoteSpotlightOnly: false
        };

        function clone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        function loadState() {
            try {
                const raw = localStorage.getItem(storageKey);
                if (!raw) return clone(defaultState);
                const parsed = JSON.parse(raw);
                return {
                    ...clone(defaultState),
                    ...parsed,
                    characters: Array.isArray(parsed.characters) ? parsed.characters : [],
                    campaigns: Array.isArray(parsed.campaigns) ? parsed.campaigns : [],
                    diceHistory: Array.isArray(parsed.diceHistory) ? parsed.diceHistory : [],
                    savedRolls: Array.isArray(parsed.savedRolls) ? parsed.savedRolls : [],
                    combat: {
                        ...clone(defaultState.combat),
                        ...(parsed.combat || {}),
                        combatants: Array.isArray(parsed?.combat?.combatants) ? parsed.combat.combatants : []
                    },
                    map: {
                        ...clone(defaultState.map),
                        ...(parsed.map || {}),
                        markers: Array.isArray(parsed?.map?.markers) ? parsed.map.markers : [],
                        dimensions: parsed?.map?.dimensions && typeof parsed.map.dimensions.width === 'number' ? parsed.map.dimensions : null
                    },
                    dm: {
                        ...clone(defaultState.dm),
                        ...(parsed.dm || {}),
                        encounters: Array.isArray(parsed?.dm?.encounters) ? parsed.dm.encounters : [],
                        sessionNotes: Array.isArray(parsed?.dm?.sessionNotes) ? parsed.dm.sessionNotes : [],
                        randomHistory: Array.isArray(parsed?.dm?.randomHistory) ? parsed.dm.randomHistory : [],
                        trackers: {
                            ...clone(defaultState.dm.trackers),
                            ...(parsed?.dm?.trackers || {})
                        },
                        stopwatch: {
                            ...clone(defaultState.dm.stopwatch),
                            ...(parsed?.dm?.stopwatch || {})
                        },
                        aiSettings: {
                            ...JSON.parse(JSON.stringify(defaultDMAISettings)),
                            ...(parsed?.dm?.aiSettings || {}),
                            toggles: {
                                ...defaultDMAISettings.toggles,
                                ...((parsed?.dm?.aiSettings || {}).toggles || {})
                            }
                        }
                    }
                };
            } catch (error) {
                console.error('Failed to load state', error);
                return clone(defaultState);
            }
        }

        let state = loadState();
        let activeCharacterDetail = null;
        let activeCampaignDetail = null;
        let activeMapMarkerId = null;
        let editingMapMarkerId = null;
        let pendingMapCoords = null;
        let mapDisplaySize = { width: 0, height: 0 };
        let stopwatchInterval = null;
        let referenceTableEntries = [];

        const mapMarkerColors = {
            primary: { background: '#5D5CDE', text: '#FFFFFF' },
            emerald: { background: '#10B981', text: '#062B24' },
            amber: { background: '#F59E0B', text: '#4C2A00' },
            rose: { background: '#F43F5E', text: '#3B0612' }
        };

        const dmTrackerLabels = {
            torchBurn: 'Torch Burn',
            doomClock: 'Doom Clock',
            favor: 'Luck Tokens'
        };

        const inspirationTables = {
            weather: [
                'Cold drizzle rolls in, extinguishing exposed flames in 1d4 rounds.',
                'Sudden heat wave; Constitution checks every hour to avoid exhaustion.',
                'Fog as thick as soup reduces visibility to 20 feet.',
                'Distant thunder heralds a storm—lightning strikes on a natural 20 attack roll.',
                'A gentle snowfall muffles sound, granting +2 to sneak attempts.',
                'A rainbow arcs overhead; luck checks gain +1 for the next hour.',
                'Howling winds impose disadvantage on ranged missile attacks.',
                'Sky opens with meteor shower; omen favors spellcasters (+1 spell checks).'
            ],
            complication: [
                'A rival faction arrives mid-scene seeking the same prize.',
                'The floor begins to collapse in sections every round.',
                'Arcane interference: spellcasting checks suffer -1d penalty this encounter.',
                'An NPC ally reveals a hidden agenda that conflicts with the party.',
                'Reinforcements arrive for the opposition on initiative 5.',
                'A moral dilemma: the objective endangers innocents unless delayed.',
                'Environmental hazard activates—poisonous spores fill the chamber.',
                'Time pressure: complete the scene in 3 rounds or suffer a setback.'
            ],
            treasure: [
                'A locked coffer containing a map fragment to a lost vault.',
                'A bundle of rare reagents worth 150 gp to the right buyer.',
                'A sentient weapon eager to guide the wielder… for a price.',
                'An idol that whispers forgotten lore but drains 1 Luck on each answer.',
                'A stash of marked coins linked to a notorious thieves’ guild.',
                'A rune-etched shield granting +1 AC but attracting undead attention.',
                'A cursed gemstone that reveals invisible creatures while held.',
                'A ledger detailing a noble’s treason—priceless leverage.'
            ],
            npc: [
                'Speaks in prophetic riddles and unconsciously sketches constellations.',
                'Collects broken weapons as trophies; offers to trade rumors for one.',
                'Haunted by an audible spirit that occasionally answers questions.',
                'Obsessed with culinary perfection; bribe with exotic spices.',
                'Wears a patchwork cloak of monster hides, each with a story.',
                'Maintains an imaginary companion who “knows secrets”.',
                'Writes everything in a floating journal; the quill never stops.',
                'Carries a pocket door that opens once per day to a random location.'
            ]
        };

        const aiToneDirectives = {
            neutral: 'Maintain a balanced, third-person narrator voice suited to pulpy sword-and-sorcery tables.',
            grim: 'Adopt a grim, perilous tone emphasizing lethal stakes and hard choices.',
            whimsical: 'Lean into Appendix N weird fantasy with playful, gonzo imagery and unexpected magic.',
            epic: 'Use mythic, heroic language that frames the party as legendary figures.'
        };

        const aiStructureDirectives = {
            bullet: 'Structure the response as concise bullet lists with bolded headers when appropriate.',
            narrative: 'Deliver the response as flowing narrative paragraphs suitable for boxed text.',
            dialogue: 'Present the response as snippets of dialogue with speaker cues and brief stage directions.'
        };

        const aiLengthDirectives = {
            tight: 'Keep the response under 180 words unless otherwise specified.',
            standard: 'Aim for 200–280 words, balancing detail with pacing.',
            epic: 'Embrace lavish detail; 350–450 words is acceptable if it serves the drama.'
        };

        const aiToneLabels = {
            neutral: 'Neutral narrator',
            grim: 'Grim & perilous',
            whimsical: 'Weird & whimsical',
            epic: 'Mythic & heroic'
        };

        const aiStructureLabels = {
            auto: 'Format: adaptive',
            bullet: 'Format: bullet lists',
            narrative: 'Format: narrative prose',
            dialogue: 'Format: dialogue beats'
        };

        const aiLengthLabels = {
            tight: 'Length: punchy',
            standard: 'Length: balanced detail',
            epic: 'Length: sweeping'
        };

        function finalizeAIPrompt(bodyLines = [], contextBlock = '', styleGuide = '') {
            const lines = [...bodyLines];
            if (contextBlock) {
                lines.push('', contextBlock);
            }
            if (styleGuide) {
                lines.push('', 'Style guide:', styleGuide);
            }
            return lines.join('\n');
        }

        function buildAIStyleDirectives(settings = {}, overrides = {}) {
            const toneKey = overrides.tone || settings?.tone || defaultDMAISettings.tone;
            const structureKey = overrides.structure
                ? overrides.structure
                : (settings?.structure === 'auto'
                    ? (overrides.preferredStructure || 'auto')
                    : (settings?.structure || 'auto'));
            const baseLength = overrides.length || settings?.length || defaultDMAISettings.length;
            const lengthKey = baseLength === defaultDMAISettings.length && overrides.preferredLength
                ? overrides.preferredLength
                : baseLength;

            const lines = [];
            if (toneKey && aiToneDirectives[toneKey]) {
                lines.push(aiToneDirectives[toneKey]);
            }
            if (structureKey && aiStructureDirectives[structureKey]) {
                lines.push(aiStructureDirectives[structureKey]);
            }
            if (lengthKey && aiLengthDirectives[lengthKey]) {
                lines.push(aiLengthDirectives[lengthKey]);
            }
            return lines.join('\n');
        }

        function describeDMAISettings(settings = {}) {
            const toneKey = settings?.tone || defaultDMAISettings.tone;
            const structureKey = settings?.structure || 'auto';
            const lengthKey = settings?.length || defaultDMAISettings.length;
            const toneLabel = aiToneLabels[toneKey] || `Tone: ${toneKey}`;
            const structureLabel = aiStructureLabels[structureKey] || `Format: ${structureKey}`;
            const lengthLabel = aiLengthLabels[lengthKey] || `Length: ${lengthKey}`;
            return [toneLabel, structureLabel, lengthLabel].filter(Boolean).join(' • ');
        }

        const aiProviderTargets = {
            poe: {
                label: 'Poe (multi-model)',
                url: 'https://poe.com/',
                hint: 'Opens Poe so you can pick Claude, GPT-4o, or other assistants and paste the copied prompt.'
            },
            chatgpt: {
                label: 'ChatGPT',
                url: 'https://chat.openai.com/',
                hint: 'Launches ChatGPT in a new tab. Paste the prompt to continue the conversation.'
            },
            claude: {
                label: 'Claude',
                url: 'https://claude.ai/new',
                hint: 'Opens Claude for a fresh chat with Anthropic models.'
            },
            gemini: {
                label: 'Gemini',
                url: 'https://gemini.google.com/app',
                hint: 'Opens Google Gemini. Paste the prompt into a new chat.'
            },
            custom: {
                label: 'Custom URL',
                url: '',
                hint: 'Provide the chat URL you want to use below, then paste the generated prompt there.'
            }
        };

        const aiPromptTemplates = {
            'session-recap': ({ context, data, settings }) => {
                const contextBlock = context ? `Context:\n${context}` : 'Context: (Ask the judge for encounter details and highlights before drafting the recap.)';
                const hasSpotlight = (data?.spotlightNotes || []).length > 0;
                const focusLine = hasSpotlight ? 'Prioritize spotlight notes when highlighting character moments.' : 'Infer key beats from the provided context even if spotlight notes are absent.';
                const styleGuide = buildAIStyleDirectives(settings, { preferredStructure: 'narrative' });
                return finalizeAIPrompt([
                    'You are chronicling a Dungeon Crawl Classics session for the players.',
                    focusLine,
                    'Write a recap with:',
                    '- A punchy session title',
                    '- 2 short paragraphs summarizing major events',
                    '- Bullet points listing unresolved threads and boons earned'
                ], contextBlock, styleGuide);
            },
            'encounter-escalation': ({ context, data, settings }) => {
                const focusEncounter = data?.encounters?.[0]?.name;
                const hook = focusEncounter ? `Focus on the encounter "${focusEncounter}" when proposing twists.` : 'Use whichever encounter seems most imminent in the context.';
                const contextBlock = context ? `Context:\n${context}` : 'Context: (Gather encounter information from the judge before responding.)';
                const styleGuide = buildAIStyleDirectives(settings, { preferredStructure: 'bullet' });
                return finalizeAIPrompt([
                    'You are an assistant Judge for Dungeon Crawl Classics helping intensify an upcoming encounter.',
                    hook,
                    'Provide:',
                    '- 3 escalating complications or environmental twists',
                    '- Tactics the opposition adopts if the party stalls',
                    '- Treasure or story rewards tied to the encounter outcome'
                ], contextBlock, styleGuide);
            },
            'npc-dialogue': ({ context, data, settings }) => {
                const reference = data?.randomHistory?.[0]?.result;
                const quirkHint = reference ? `Incorporate this spark: "${reference}".` : 'Invent a memorable quirk using the context.';
                const contextBlock = context ? `Context:\n${context}` : 'Context: (Collect current session details before drafting dialogue.)';
                const styleGuide = buildAIStyleDirectives(settings, { preferredStructure: 'dialogue', preferredLength: 'tight' });
                return finalizeAIPrompt([
                    'Help the Judge improvise NPC roleplay for Dungeon Crawl Classics.',
                    quirkHint,
                    'Output:',
                    '- A short description of the NPC\'s vibe and goal',
                    '- 3 flavorful lines of dialogue reacting to the party',
                    '- A secret or rumor they might reveal if persuaded'
                ], contextBlock, styleGuide);
            },
            'downtime-hooks': ({ context, data, settings }) => {
                const trackerSummary = Object.entries(data?.trackers || {}).some(([, value]) => Number(value) > 0)
                    ? 'Tie at least one hook to the active resource trackers.'
                    : 'Invent hooks that build on the encounters and notes provided.';
                const contextBlock = context ? `Context:\n${context}` : 'Context: (Add session details so hooks can reference current threats.)';
                const styleGuide = buildAIStyleDirectives(settings, { preferredStructure: 'bullet' });
                return finalizeAIPrompt([
                    'Generate downtime opportunities for the party between Dungeon Crawl Classics adventures.',
                    trackerSummary,
                    'Deliver 4 hooks. For each include:',
                    '- A short title',
                    '- What draws the heroes in',
                    '- What boon or fallout completing it creates'
                ], contextBlock, styleGuide);
            },
            'scene-painting': ({ context, data, settings }) => {
                const environment = data?.encounters?.[0]?.environment || (data?.encounters?.[0]?.name ? `${data.encounters[0].name} locale` : null);
                const prompt = environment
                    ? `Paint the scene for the location: ${environment}.`
                    : 'Paint the upcoming scene with sensory details gleaned from the context.';
                const contextBlock = context ? `Context:\n${context}` : 'Context: (Include the encounter or location details you want painted.)';
                const styleGuide = buildAIStyleDirectives(settings, { preferredStructure: 'narrative', preferredLength: 'tight' });
                return finalizeAIPrompt([
                    'Provide boxed text the Judge can read aloud to set the scene.',
                    prompt,
                    'Highlight sensory details (sight, sound, smell) and reveal a looming danger or opportunity.'
                ], contextBlock, styleGuide);
            },
            'momentum-plan': ({ context, data, settings }) => {
                const hasClock = Boolean(data?.stopwatch?.running) || (Number(data?.stopwatch?.elapsed) || 0) > 0;
                const contextBlock = context ? `Context:\n${context}` : 'Context: (Add session notes and goals to outline the next beats.)';
                const styleGuide = buildAIStyleDirectives(settings, { preferredStructure: 'bullet' });
                return finalizeAIPrompt([
                    'Help the Judge pace the next leg of the session.',
                    hasClock ? 'Use the session clock to gauge urgency when appropriate.' : 'Assume the Judge is keeping the session on a tight cadence.',
                    'Deliver:',
                    '- 3 escalating beats describing what happens if the party charges ahead, hesitates, or backtracks',
                    '- A spotlight idea for a quieter roleplay moment',
                    '- A contingency if the heroes skip the prepared material'
                ], contextBlock, styleGuide);
            },
            'rules-lookup': ({ context, data, settings }) => {
                const focusEncounter = data?.encounters?.[0]?.name;
                const contextBlock = context ? `Context:\n${context}` : 'Context: (Share the situation so the assistant can target relevant Dungeon Crawl Classics rules.)';
                const styleGuide = buildAIStyleDirectives(settings, { preferredStructure: 'bullet', preferredLength: 'tight' });
                return finalizeAIPrompt([
                    'Act as a Dungeon Crawl Classics rules reference for the Judge.',
                    focusEncounter ? `Prioritize mechanics most relevant to "${focusEncounter}".` : 'Focus on mechanics implied by the provided context.',
                    'Summarize 3-4 rules or tables that might be consulted next. For each include:',
                    '- The rule or table name',
                    '- When it applies',
                    '- The key modifiers or dice rolled'
                ], contextBlock, styleGuide);
            },
            'treasure-upgrade': ({ context, data, settings }) => {
                const inspiration = data?.randomHistory?.find(entry => entry.type === 'treasure');
                const spark = inspiration ? `Incorporate this treasure spark: "${inspiration.result}".` : 'Invent treasure that reinforces themes from the context.';
                const contextBlock = context ? `Context:\n${context}` : 'Context: (List encounters or factions to tailor rewards.)';
                const styleGuide = buildAIStyleDirectives(settings, { preferredStructure: 'bullet' });
                return finalizeAIPrompt([
                    'Design 3 treasure or boon options that feel bespoke to the current adventure.',
                    spark,
                    'For each include:',
                    '- The item or boon name',
                    '- A vivid description or quirk',
                    '- A mechanical or narrative payoff for claiming it'
                ], contextBlock, styleGuide);
            }
        };

        const copyFeedbackTimers = new Map();

        function saveState() {
            try {
                localStorage.setItem(storageKey, JSON.stringify(state));
            } catch (error) {
                console.error('Failed to save state', error);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button[data-tab]').forEach(el => el.classList.remove('tab-active'));
            const target = document.getElementById('content-' + tab);
            const tabButton = document.getElementById('tab-' + tab);
            if (target) target.classList.remove('hidden');
            if (tabButton) tabButton.classList.add('tab-active');
            localStorage.setItem(tabKey, tab);
        }

        function getModifier(score) {
            if (score <= 3) return -3;
            if (score <= 5) return -2;
            if (score <= 8) return -1;
            if (score <= 12) return 0;
            if (score <= 15) return 1;
            if (score <= 17) return 2;
            return 3;
        }

        function formatModifier(score) {
            const mod = getModifier(score);
            return (mod >= 0 ? '+' : '') + mod;
        }

        function formatTimestamp(isoString) {
            if (!isoString) return '—';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '—';
            return date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            return (text || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function openModal(id) {
            const modal = document.getElementById(id);
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (!modal) return;
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showCharacterForm(id = null) {
            const form = document.getElementById('character-form');
            form.reset();
            document.getElementById('char-level').value = 0;
            document.getElementById('char-str').value = 10;
            document.getElementById('char-agi').value = 10;
            document.getElementById('char-sta').value = 10;
            document.getElementById('char-per').value = 10;
            document.getElementById('char-int').value = 10;
            document.getElementById('char-luc').value = 10;
            document.getElementById('char-hp-max').value = 4;
            document.getElementById('char-hp-current').value = 4;
            document.getElementById('char-ac').value = 10;
            document.getElementById('char-speed').value = 30;
            document.getElementById('char-alignment').value = 'Lawful';
            document.getElementById('character-form-title').textContent = id ? 'Edit Character' : 'Create Character';
            form.dataset.mode = id ? 'edit' : 'create';
            document.getElementById('char-id').value = id || '';

            if (id) {
                const char = state.characters.find(c => c.id === id);
                if (char) {
                    document.getElementById('char-name').value = char.name;
                    document.getElementById('char-class').value = char.class;
                    document.getElementById('char-level').value = char.level;
                    document.getElementById('char-alignment').value = char.alignment || 'Neutral';
                    document.getElementById('char-str').value = char.str;
                    document.getElementById('char-agi').value = char.agi;
                    document.getElementById('char-sta').value = char.sta;
                    document.getElementById('char-per').value = char.per;
                    document.getElementById('char-int').value = char.int;
                    document.getElementById('char-luc').value = char.luc;
                    document.getElementById('char-hp-max').value = char.hpMax;
                    document.getElementById('char-hp-current').value = char.hpCurrent;
                    document.getElementById('char-ac').value = char.ac;
                    document.getElementById('char-speed').value = char.speed;
                    document.getElementById('char-lucky').value = char.luckySign || '';
                    document.getElementById('char-languages').value = char.languages || '';
                    document.getElementById('char-equipment').value = char.equipment || '';
                    document.getElementById('char-notes').value = char.notes || '';
                }
            }

            openModal('character-form-modal');
        }

        function hideCharacterForm() {
            closeModal('character-form-modal');
        }

        document.getElementById('character-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const mode = event.target.dataset.mode || 'create';
            const charData = {
                id: mode === 'edit' ? document.getElementById('char-id').value : `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                name: document.getElementById('char-name').value.trim(),
                class: document.getElementById('char-class').value.trim() || 'Peasant',
                level: parseInt(document.getElementById('char-level').value, 10) || 0,
                alignment: document.getElementById('char-alignment').value,
                str: parseInt(document.getElementById('char-str').value, 10) || 3,
                agi: parseInt(document.getElementById('char-agi').value, 10) || 3,
                sta: parseInt(document.getElementById('char-sta').value, 10) || 3,
                per: parseInt(document.getElementById('char-per').value, 10) || 3,
                int: parseInt(document.getElementById('char-int').value, 10) || 3,
                luc: parseInt(document.getElementById('char-luc').value, 10) || 3,
                hpMax: parseInt(document.getElementById('char-hp-max').value, 10) || 1,
                hpCurrent: parseInt(document.getElementById('char-hp-current').value, 10) || 0,
                ac: parseInt(document.getElementById('char-ac').value, 10) || 10,
                speed: parseInt(document.getElementById('char-speed').value, 10) || 30,
                luckySign: document.getElementById('char-lucky').value.trim(),
                languages: document.getElementById('char-languages').value.trim(),
                equipment: document.getElementById('char-equipment').value.trim(),
                notes: document.getElementById('char-notes').value.trim(),
                createdAt: mode === 'edit' ? undefined : new Date().toISOString()
            };

            if (mode === 'edit') {
                const index = state.characters.findIndex(c => c.id === charData.id);
                if (index !== -1) {
                    const preserved = state.characters[index];
                    state.characters[index] = { ...preserved, ...charData };
                }
            } else {
                state.characters.push(charData);
            }

            saveState();
            renderCharacters();
            hideCharacterForm();
            if (activeCharacterDetail === charData.id) {
                showCharacterDetail(charData.id);
            }
        });

        document.getElementById('character-search').addEventListener('input', (event) => {
            uiState.characterSearch = event.target.value.toLowerCase();
            renderCharacters();
        });

        document.getElementById('character-class-filter').addEventListener('change', (event) => {
            uiState.characterClass = event.target.value;
            renderCharacters();
        });

        document.getElementById('character-status-filter').addEventListener('change', (event) => {
            uiState.characterStatus = event.target.value;
            renderCharacters();
        });

        document.getElementById('character-sort').addEventListener('change', (event) => {
            uiState.characterSort = event.target.value;
            renderCharacters();
        });

        document.getElementById('campaign-search').addEventListener('input', (event) => {
            uiState.campaignSearch = event.target.value.toLowerCase();
            renderCampaigns();
        });

        document.getElementById('campaign-judge-filter').addEventListener('input', (event) => {
            uiState.campaignJudge = event.target.value.toLowerCase();
            renderCampaigns();
        });

        document.getElementById('campaign-sort').addEventListener('change', (event) => {
            uiState.campaignSort = event.target.value;
            renderCampaigns();
        });

        const mapUploadInput = document.getElementById('map-upload');
        if (mapUploadInput) {
            mapUploadInput.addEventListener('change', handleMapUpload);
        }

        const mapMarkerForm = document.getElementById('map-marker-form');
        if (mapMarkerForm) {
            mapMarkerForm.addEventListener('submit', submitMapMarker);
        }

        const mapMarkerCancelButton = document.getElementById('map-marker-cancel-edit');
        if (mapMarkerCancelButton) {
            mapMarkerCancelButton.addEventListener('click', (event) => {
                event.preventDefault();
                cancelMapMarkerEdit();
            });
        }

        const mapMarkerSearchInput = document.getElementById('map-marker-search');
        if (mapMarkerSearchInput) {
            mapMarkerSearchInput.addEventListener('input', (event) => {
                uiState.mapMarkerSearch = event.target.value || '';
                renderMap();
            });
        }

        const mapMarkerClearSearch = document.getElementById('map-marker-clear-search');
        if (mapMarkerClearSearch) {
            mapMarkerClearSearch.addEventListener('click', (event) => {
                event.preventDefault();
                if (!uiState.mapMarkerSearch) return;
                uiState.mapMarkerSearch = '';
                if (mapMarkerSearchInput) {
                    mapMarkerSearchInput.value = '';
                }
                renderMap();
            });
        }

        const mapNotesInput = document.getElementById('map-notes');
        if (mapNotesInput) {
            mapNotesInput.addEventListener('input', (event) => {
                state.map.notes = event.target.value;
                saveState();
            });
        }

        const mapGridToggle = document.getElementById('map-grid-toggle');
        if (mapGridToggle) {
            mapGridToggle.addEventListener('change', (event) => {
                state.map.showGrid = !!event.target.checked;
                saveState();
                renderMap();
            });
        }

        const mapGridSizeInput = document.getElementById('map-grid-size');
        if (mapGridSizeInput) {
            mapGridSizeInput.addEventListener('input', (event) => {
                state.map.gridSize = parseInt(event.target.value, 10) || defaultState.map.gridSize;
                saveState();
                renderMap();
            });
        }

        const mapZoomInput = document.getElementById('map-zoom');
        if (mapZoomInput) {
            mapZoomInput.addEventListener('input', (event) => {
                state.map.zoom = parseInt(event.target.value, 10) || defaultState.map.zoom;
                saveState();
                renderMap();
            });
        }

        ['map-marker-x', 'map-marker-y'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', updateManualMarkerCoordinates);
            }
        });

        const mapInner = document.getElementById('map-inner');
        if (mapInner) {
            mapInner.addEventListener('click', handleMapClick);
        }

        const dmEncounterForm = document.getElementById('dm-encounter-form');
        if (dmEncounterForm) {
            dmEncounterForm.addEventListener('submit', handleDMEncounterForm);
        }

        const dmEncounterSearchInput = document.getElementById('dm-encounter-search');
        if (dmEncounterSearchInput) {
            dmEncounterSearchInput.addEventListener('input', (event) => {
                uiState.dmEncounterSearch = event.target.value || '';
                renderDMEncounters();
            });
        }

        const dmEncounterClearSearch = document.getElementById('dm-encounter-clear-search');
        if (dmEncounterClearSearch) {
            dmEncounterClearSearch.addEventListener('click', (event) => {
                event.preventDefault();
                if (!uiState.dmEncounterSearch) return;
                uiState.dmEncounterSearch = '';
                if (dmEncounterSearchInput) {
                    dmEncounterSearchInput.value = '';
                }
                renderDMEncounters();
            });
        }

        const dmNoteForm = document.getElementById('dm-note-form');
        if (dmNoteForm) {
            dmNoteForm.addEventListener('submit', handleDMNoteForm);
        }

        const dmNoteSearchInput = document.getElementById('dm-note-search');
        if (dmNoteSearchInput) {
            dmNoteSearchInput.addEventListener('input', (event) => {
                uiState.dmNoteSearch = event.target.value || '';
                renderDMNotes();
            });
        }

        const dmNoteSpotlightFilter = document.getElementById('dm-note-spotlight-filter');
        if (dmNoteSpotlightFilter) {
            dmNoteSpotlightFilter.addEventListener('change', (event) => {
                uiState.dmNoteSpotlightOnly = !!event.target.checked;
                renderDMNotes();
            });
        }

        const stopwatchStart = document.getElementById('dm-stopwatch-start');
        if (stopwatchStart) {
            stopwatchStart.addEventListener('click', (event) => {
                event.preventDefault();
                startStopwatch();
            });
        }

        const stopwatchPause = document.getElementById('dm-stopwatch-pause');
        if (stopwatchPause) {
            stopwatchPause.addEventListener('click', (event) => {
                event.preventDefault();
                pauseStopwatch();
            });
        }

        const stopwatchReset = document.getElementById('dm-stopwatch-reset');
        if (stopwatchReset) {
            stopwatchReset.addEventListener('click', (event) => {
                event.preventDefault();
                resetStopwatch();
            });
        }

        [
            ['dm-random-weather', 'weather'],
            ['dm-random-complication', 'complication'],
            ['dm-random-treasure', 'treasure'],
            ['dm-random-npc', 'npc']
        ].forEach(([id, type]) => {
            const button = document.getElementById(id);
            if (button) {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    triggerDMGenerator(type);
                });
            }
        });

        const dmAIRefreshButton = document.getElementById('dm-ai-refresh-context');
        if (dmAIRefreshButton) {
            dmAIRefreshButton.addEventListener('click', (event) => {
                event.preventDefault();
                renderDMAIHelpers();
            });
        }

        const dmAICopyContext = document.getElementById('dm-ai-copy-context');
        if (dmAICopyContext) {
            dmAICopyContext.addEventListener('click', (event) => {
                event.preventDefault();
                const contextField = document.getElementById('dm-ai-context');
                copyTextToClipboard(contextField ? contextField.value : '', dmAICopyContext);
            });
        }

        const dmAICopyPrompt = document.getElementById('dm-ai-copy-prompt');
        if (dmAICopyPrompt) {
            dmAICopyPrompt.addEventListener('click', (event) => {
                event.preventDefault();
                const promptOutput = document.getElementById('dm-ai-prompt-output');
                copyTextToClipboard(promptOutput ? promptOutput.value : '', dmAICopyPrompt);
            });
        }

        const dmAIClearPrompt = document.getElementById('dm-ai-clear-prompt');
        if (dmAIClearPrompt) {
            dmAIClearPrompt.addEventListener('click', (event) => {
                event.preventDefault();
                const promptOutput = document.getElementById('dm-ai-prompt-output');
                if (promptOutput) {
                    promptOutput.value = '';
                }
                renderDMAIHelpers();
            });
        }

        const dmAIPromptOutput = document.getElementById('dm-ai-prompt-output');
        if (dmAIPromptOutput) {
            dmAIPromptOutput.addEventListener('input', () => {
                renderDMAIHelpers();
            });
        }

        const dmAIAppendContextButton = document.getElementById('dm-ai-append-context');
        if (dmAIAppendContextButton) {
            dmAIAppendContextButton.addEventListener('click', (event) => {
                event.preventDefault();
                const settings = ensureDMAISettings();
                const context = buildDMAIContext(gatherDMAIData(), settings);
                if (!context.trim()) {
                    setDMAILaunchStatus('No context available to append yet.', 'error', 1800);
                    return;
                }
                const promptOutput = document.getElementById('dm-ai-prompt-output');
                if (!promptOutput) return;
                const currentValue = promptOutput.value || '';
                if (currentValue.toLowerCase().includes('context:')) {
                    setDMAILaunchStatus('Context already attached to the working prompt.', 'muted', 2000);
                    return;
                }
                const insertion = currentValue.trim()
                    ? `${currentValue.trim()}\n\nContext:\n${context}`
                    : `Context:\n${context}`;
                promptOutput.value = insertion;
                renderDMAIHelpers();
                setDMAILaunchStatus('Context appended to the working prompt.', 'success', 2500);
            });
        }

        const dmAIIncludeContextToggle = document.getElementById('dm-ai-include-context');
        if (dmAIIncludeContextToggle) {
            dmAIIncludeContextToggle.addEventListener('change', (event) => {
                const settings = ensureDMAISettings();
                settings.includeContext = !!event.target.checked;
                saveState();
                renderDMAIHelpers();
            });
        }

        const dmAIIncludeStyleToggle = document.getElementById('dm-ai-include-style');
        if (dmAIIncludeStyleToggle) {
            dmAIIncludeStyleToggle.addEventListener('change', (event) => {
                const settings = ensureDMAISettings();
                settings.includeStyleGuide = !!event.target.checked;
                saveState();
                renderDMAIHelpers();
            });
        }

        const dmAIAutoCopyToggle = document.getElementById('dm-ai-auto-copy');
        if (dmAIAutoCopyToggle) {
            dmAIAutoCopyToggle.addEventListener('change', (event) => {
                const settings = ensureDMAISettings();
                settings.autoCopyFull = !!event.target.checked;
                saveState();
                renderDMAIHelpers();
            });
        }

        const dmAIProviderSelect = document.getElementById('dm-ai-provider');
        if (dmAIProviderSelect) {
            dmAIProviderSelect.addEventListener('change', (event) => {
                const settings = ensureDMAISettings();
                settings.provider = event.target.value;
                saveState();
                renderDMAIHelpers();
            });
        }

        const dmAIProviderUrl = document.getElementById('dm-ai-provider-url');
        if (dmAIProviderUrl) {
            dmAIProviderUrl.addEventListener('input', (event) => {
                const settings = ensureDMAISettings();
                settings.customProviderUrl = event.target.value;
                saveState();
                renderDMAIHelpers();
            });
        }

        const dmAIPreviewFull = document.getElementById('dm-ai-preview-full');
        if (dmAIPreviewFull) {
            dmAIPreviewFull.addEventListener('click', (event) => {
                event.preventDefault();
                renderDMAIHelpers();
                setDMAILaunchStatus('Preview refreshed.', 'muted', 1500);
            });
        }

        const dmAICopyFull = document.getElementById('dm-ai-copy-full');
        if (dmAICopyFull) {
            dmAICopyFull.addEventListener('click', async (event) => {
                event.preventDefault();
                const settings = getDMAISettings();
                const data = gatherDMAIData();
                const context = buildDMAIContext(data, settings);
                const promptOutput = document.getElementById('dm-ai-prompt-output');
                const promptValue = promptOutput ? promptOutput.value : '';
                const fullPrompt = compileDMAIFullPrompt({ context, settings, promptText: promptValue });
                if (!fullPrompt.trim()) {
                    setDMAILaunchStatus('Nothing to copy yet—add context or a working prompt.', 'error', 2000);
                    return;
                }
                const success = await copyTextToClipboard(fullPrompt, dmAICopyFull);
                if (success) {
                    setDMAILaunchStatus('Final prompt copied to your clipboard.', 'success', 2500);
                } else {
                    setDMAILaunchStatus('Clipboard copy failed—select the preview text manually.', 'error', 2500);
                }
            });
        }

        const dmAILaunchButton = document.getElementById('dm-ai-launch');
        if (dmAILaunchButton) {
            dmAILaunchButton.addEventListener('click', handleDMAILaunch);
        }

        document.querySelectorAll('.dm-ai-context-toggle').forEach(toggle => {
            toggle.addEventListener('change', (event) => {
                const key = event.target.dataset.aiToggle;
                if (!key) return;
                const settings = ensureDMAISettings();
                settings.toggles[key] = !!event.target.checked;
                saveState();
                renderDMAIHelpers();
            });
        });

        const dmAIToneSelect = document.getElementById('dm-ai-tone');
        if (dmAIToneSelect) {
            dmAIToneSelect.addEventListener('change', (event) => {
                const settings = ensureDMAISettings();
                settings.tone = event.target.value;
                saveState();
                renderDMAIHelpers();
            });
        }

        const dmAIStructureSelect = document.getElementById('dm-ai-structure');
        if (dmAIStructureSelect) {
            dmAIStructureSelect.addEventListener('change', (event) => {
                const settings = ensureDMAISettings();
                settings.structure = event.target.value;
                saveState();
                renderDMAIHelpers();
            });
        }

        const dmAILengthSelect = document.getElementById('dm-ai-length');
        if (dmAILengthSelect) {
            dmAILengthSelect.addEventListener('change', (event) => {
                const settings = ensureDMAISettings();
                settings.length = event.target.value;
                saveState();
                renderDMAIHelpers();
            });
        }

        document.querySelectorAll('[data-ai-prompt]').forEach(button => {
            button.addEventListener('click', (event) => {
                event.preventDefault();
                handleDMAIPrompt(button.dataset.aiPrompt);
            });
        });

        const tableSearchInput = document.getElementById('table-search');
        if (tableSearchInput) {
            tableSearchInput.addEventListener('input', (event) => {
                uiState.tableSearch = event.target.value.toLowerCase();
                renderReferenceTables();
            });
        }

        const tableRandomButton = document.getElementById('table-random-btn');
        if (tableRandomButton) {
            tableRandomButton.addEventListener('click', (event) => {
                event.preventDefault();
                rollReferenceInspiration();
            });
        }

        function rollDiceNTimes(count, sides) {
            const results = [];
            for (let i = 0; i < count; i++) {
                results.push(Math.floor(Math.random() * sides) + 1);
            }
            return results;
        }

        function rollZeroLevelCharacter() {
            const stats = ['str', 'agi', 'sta', 'per', 'int', 'luc'];
            const occupations = [
                'Alchemist', 'Armorer', 'Blacksmith', 'Butcher', 'Cobbler', 'Farmer', 'Gongfarmer', 'Grave digger', 'Herbalist',
                'Hunter', 'Locksmith', 'Mendicant', 'Mercenary', 'Miller', 'Rat catcher', 'Sailor', 'Scribe', 'Trapper'
            ];
            const form = document.getElementById('character-form');
            form.dataset.mode = 'create';
            document.getElementById('char-id').value = '';
            document.getElementById('char-name').value = '';
            document.getElementById('char-class').value = 'Peasant';
            document.getElementById('char-level').value = 0;
            document.getElementById('char-alignment').value = ['Lawful', 'Neutral', 'Chaotic'][Math.floor(Math.random() * 3)];
            stats.forEach(stat => {
                const rolls = rollDiceNTimes(3, 6);
                const score = rolls.reduce((a, b) => a + b, 0);
                document.getElementById(`char-${stat}`).value = score;
            });
            const hp = rollDiceNTimes(1, 4)[0];
            document.getElementById('char-hp-max').value = hp;
            document.getElementById('char-hp-current').value = hp;
            document.getElementById('char-ac').value = 10;
            document.getElementById('char-speed').value = 30;
            document.getElementById('char-lucky').value = '';
            document.getElementById('char-languages').value = 'Common';
            const occupation = occupations[Math.floor(Math.random() * occupations.length)];
            document.getElementById('char-equipment').value = `${occupation} tools`;
            document.getElementById('char-notes').value = 'Fresh 0-level recruit ready for funnel!';
            document.getElementById('character-form-title').textContent = 'Generate 0-Level Peasant';
            openModal('character-form-modal');
        }

        function renderCharacterSummary(filtered, all) {
            const container = document.getElementById('character-summary');
            if (!container) return;
            if (!all.length) {
                container.innerHTML = `
                    <div class="bg-gray-50 dark:bg-surface border border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-4 text-sm text-gray-600 dark:text-gray-400">
                        Add characters to see roster analytics at a glance.
                    </div>
                `;
                return;
            }

            const total = all.length;
            const filteredCount = filtered.length;
            const highestLevel = all.reduce((max, char) => Math.max(max, char.level || 0), 0);
            const readyCount = all.filter(char => {
                const hpCurrent = Number.isFinite(char.hpCurrent) ? char.hpCurrent : parseInt(char.hpCurrent, 10) || 0;
                const hpMax = Number.isFinite(char.hpMax) ? Math.max(char.hpMax, 1) : Math.max(parseInt(char.hpMax, 10) || 1, 1);
                const hpPercent = (hpCurrent / hpMax) * 100;
                return hpCurrent > 0 && hpPercent >= 50;
            }).length;
            const injuredCount = all.filter(char => {
                const hpCurrent = Number.isFinite(char.hpCurrent) ? char.hpCurrent : parseInt(char.hpCurrent, 10) || 0;
                const hpMax = Number.isFinite(char.hpMax) ? Math.max(char.hpMax, 1) : Math.max(parseInt(char.hpMax, 10) || 1, 1);
                const hpPercent = (hpCurrent / hpMax) * 100;
                return hpCurrent > 0 && hpPercent < 50;
            }).length;
            const downedCount = all.filter(char => (Number.isFinite(char.hpCurrent) ? char.hpCurrent : parseInt(char.hpCurrent, 10) || 0) <= 0).length;
            const averageLuck = (all.reduce((sum, char) => sum + getModifier(char.luc || 10), 0) / total).toFixed(1);

            const classFrequency = all.reduce((acc, char) => {
                const key = (char.class || 'Unknown').toLowerCase();
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});
            const mostCommonClassKey = Object.keys(classFrequency).sort((a, b) => classFrequency[b] - classFrequency[a])[0];
            const mostCommonClass = all.find(char => (char.class || '').toLowerCase() === mostCommonClassKey)?.class || '—';

            container.innerHTML = `
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Roster Size</div>
                    <div class="text-2xl font-bold">${total}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${filteredCount} matching current filters</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Highest Level</div>
                    <div class="text-2xl font-bold">${highestLevel}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Most common class: ${mostCommonClass}</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Average Luck Mod</div>
                    <div class="text-2xl font-bold">${averageLuck}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Based on ${total} heroes</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Battle Status</div>
                    <div class="text-2xl font-bold">${readyCount} ready</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${injuredCount} injured • ${downedCount} down</div>
                </div>
            `;
        }

        function renderCharacters() {
            const container = document.getElementById('character-list');
            if (!container) return;

            const filtered = state.characters
                .filter(char => {
                    const matchesSearch = !uiState.characterSearch || (
                        char.name.toLowerCase().includes(uiState.characterSearch) ||
                        (char.notes || '').toLowerCase().includes(uiState.characterSearch)
                    );
                    const matchesClass = uiState.characterClass === 'all' || char.class.toLowerCase() === uiState.characterClass.toLowerCase();
                    const hpCurrent = Number.isFinite(char.hpCurrent) ? char.hpCurrent : parseInt(char.hpCurrent, 10) || 0;
                    const hpMax = Number.isFinite(char.hpMax) ? Math.max(char.hpMax, 1) : Math.max(parseInt(char.hpMax, 10) || 1, 1);
                    const hpPercent = (hpCurrent / hpMax) * 100;
                    let matchesStatus = true;
                    switch (uiState.characterStatus) {
                        case 'ready':
                            matchesStatus = hpCurrent > 0 && hpPercent >= 50;
                            break;
                        case 'injured':
                            matchesStatus = hpCurrent > 0 && hpPercent < 50;
                            break;
                        case 'down':
                            matchesStatus = hpCurrent <= 0;
                            break;
                        default:
                            matchesStatus = true;
                    }
                    return matchesSearch && matchesClass && matchesStatus;
                })
                .sort((a, b) => {
                    switch (uiState.characterSort) {
                        case 'class':
                            return (a.class || '').localeCompare(b.class || '');
                        case 'level':
                            return (b.level || 0) - (a.level || 0);
                        case 'luck':
                            return getModifier(b.luc || 0) - getModifier(a.luc || 0);
                        default:
                            return (a.name || '').localeCompare(b.name || '');
                    }
                });

            renderCharacterSummary(filtered, state.characters);

            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-12">No characters yet. Create one or import from a JSON backup.</p>';
                return;
            }

            container.innerHTML = filtered.map(char => {
                const hpPercent = Math.max(0, Math.min(100, Math.round((char.hpCurrent / Math.max(char.hpMax, 1)) * 100)));
                const tags = [char.alignment, char.class !== 'Peasant' ? `Lvl ${char.level}` : '0-Lvl'];
                return `
                    <div class="bg-gray-50 dark:bg-surface rounded-lg p-4 border border-gray-200 dark:border-gray-800 hover:shadow-lg transition cursor-pointer" onclick="showCharacterDetail('${char.id}')">
                        <div class="flex items-start justify-between gap-2 mb-3">
                            <div>
                                <h3 class="text-xl font-bold">${char.name || 'Unnamed Hero'}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Level ${char.level} ${char.class}</p>
                            </div>
                            <div class="flex gap-1">
                                ${tags.map(tag => `<span class=\"chip bg-primary/10 text-primary\">${tag}</span>`).join('')}
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
                                <span>HP ${char.hpCurrent}/${char.hpMax}</span>
                                <span>${hpPercent}%</span>
                            </div>
                            <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full bg-primary" style="width: ${hpPercent}%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-6 gap-1 text-xs mb-3">
                            ${['str','agi','sta','per','int','luc'].map(stat => `
                                <div class="text-center">
                                    <div class="font-semibold uppercase">${stat}</div>
                                    <div>${char[stat]} <span class="stat-modifier">(${formatModifier(char[stat])})</span></div>
                                </div>
                            `).join('')}
                        </div>
                        ${char.notes ? `<p class="text-xs text-gray-600 dark:text-gray-400 mb-3 line-clamp-2">${char.notes}</p>` : ''}
                        <div class="flex flex-wrap gap-2">
                            <button onclick="event.stopPropagation(); showCharacterDetail('${char.id}')" class="flex-1 px-3 py-2 text-sm border border-primary text-primary rounded hover:bg-primary hover:text-white transition">View</button>
                            <button onclick="event.stopPropagation(); showCharacterForm('${char.id}')" class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition">Edit</button>
                            <button onclick="event.stopPropagation(); addCharacterToCombat('${char.id}')" class="flex-1 px-3 py-2 text-sm bg-primary text-white rounded hover:bg-opacity-90 transition">Add to Combat</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCharacterDetail(id) {
            const char = state.characters.find(c => c.id === id);
            if (!char) return;
            activeCharacterDetail = id;
            document.getElementById('detail-char-name').textContent = char.name || 'Unnamed Hero';
            const equipment = char.equipment ? marked.parse(char.equipment) : '';
            const notes = char.notes ? marked.parse(char.notes) : '';
            const detail = `
                <div class="space-y-6 text-sm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded">
                            <div class="text-xs uppercase text-gray-500">Health</div>
                            <div class="text-2xl font-bold">${char.hpCurrent}/${char.hpMax}</div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="adjustCharacterHP('${char.id}', -1)" class="flex-1 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">-</button>
                                <button onclick="adjustCharacterHP('${char.id}', 1)" class="flex-1 px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">+</button>
                            </div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded">
                            <div class="text-xs uppercase text-gray-500">Armor Class</div>
                            <div class="text-2xl font-bold">${char.ac}</div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded">
                            <div class="text-xs uppercase text-gray-500">Speed</div>
                            <div class="text-2xl font-bold">${char.speed} ft</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-semibold text-base mb-2">Ability Scores</h4>
                        <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                            ${['str','agi','sta','per','int','luc'].map(stat => `
                                <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-center">
                                    <div class="text-xs uppercase text-gray-500">${stat}</div>
                                    <div class="text-xl font-bold">${char[stat]}</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">${formatModifier(char[stat])}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <h4 class="font-semibold text-base">Profile</h4>
                            <p><span class="font-semibold">Class:</span> ${char.class}</p>
                            <p><span class="font-semibold">Level:</span> ${char.level}</p>
                            <p><span class="font-semibold">Alignment:</span> ${char.alignment || 'Neutral'}</p>
                            ${char.luckySign ? `<p><span class="font-semibold">Lucky Sign:</span> ${char.luckySign}</p>` : ''}
                            ${char.languages ? `<p><span class="font-semibold">Languages:</span> ${char.languages}</p>` : ''}
                        </div>
                        <div class="space-y-2">
                            <h4 class="font-semibold text-base">Actions</h4>
                            <button onclick="addCharacterToCombat('${char.id}')" class="w-full px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition">Add to Combat</button>
                            <button onclick="showCharacterForm('${char.id}')" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition">Edit Character</button>
                            <button onclick="deleteCharacter('${char.id}')" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">Delete Character</button>
                        </div>
                    </div>

                    ${char.equipment ? `
                        <div>
                            <h4 class="font-semibold text-base mb-2">Equipment</h4>
                            <div class="prose prose-sm max-w-none dark:prose-invert">${equipment}</div>
                        </div>
                    ` : ''}

                    ${char.notes ? `
                        <div>
                            <h4 class="font-semibold text-base mb-2">Story Notes</h4>
                            <div class="prose prose-sm max-w-none dark:prose-invert">${notes}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('character-detail-content').innerHTML = detail;
            openModal('character-detail-modal');
        }

        function hideCharacterDetail() {
            activeCharacterDetail = null;
            closeModal('character-detail-modal');
        }

        function adjustCharacterHP(id, amount) {
            const char = state.characters.find(c => c.id === id);
            if (!char) return;
            char.hpCurrent = Math.max(0, Math.min(char.hpMax, char.hpCurrent + amount));
            saveState();
            renderCharacters();
            if (activeCharacterDetail === id) {
                showCharacterDetail(id);
            }
            state.combat.combatants.forEach(combatant => {
                if (combatant.characterId === id) {
                    combatant.hp = Math.max(0, Math.min(combatant.hpMax, char.hpCurrent));
                }
            });
            renderCombat();
        }

        async function deleteCharacter(id) {
            if (!confirm('Delete this character? This cannot be undone.')) return;
            state.characters = state.characters.filter(c => c.id !== id);
            state.combat.combatants = state.combat.combatants.filter(c => c.characterId !== id);
            saveState();
            renderCharacters();
            renderCombat();
            hideCharacterDetail();
        }

        function addCharacterToCombat(id) {
            const char = state.characters.find(c => c.id === id);
            if (!char) return;
            const initiativeRoll = Math.floor(Math.random() * 20) + 1 + getModifier(char.agi);
            const combatant = {
                id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                name: char.name,
                initiative: initiativeRoll,
                hp: char.hpCurrent,
                hpMax: char.hpMax,
                ac: char.ac,
                tags: ['PC'],
                notes: char.class,
                type: 'pc',
                characterId: id
            };
            state.combat.combatants.push(combatant);
            sortInitiative();
            saveState();
            renderCombat();
            hideCharacterDetail();
            switchTab('combat');
        }

        // Dice roller logic
        function getAdvantageMode() {
            return document.getElementById('advantage-mode').value;
        }

        function addRollToHistory(entry) {
            state.diceHistory.unshift(entry);
            if (state.diceHistory.length > 40) {
                state.diceHistory.pop();
            }
            saveState();
            displayRollResults();
        }

        function rollDice(sides) {
            const count = parseInt(document.getElementById('dice-count').value, 10) || 1;
            const modifier = parseInt(document.getElementById('dice-modifier').value, 10) || 0;
            const description = document.getElementById('roll-description').value.trim();
            const mode = getAdvantageMode();
            let rolls = [];
            let total = modifier;
            let breakdown = '';

            if (sides === 20 && count === 1 && mode !== 'normal') {
                const first = Math.floor(Math.random() * 20) + 1;
                const second = Math.floor(Math.random() * 20) + 1;
                rolls = [first, second];
                total += mode === 'advantage' ? Math.max(first, second) : Math.min(first, second);
                breakdown = `${mode === 'advantage' ? 'Adv' : 'Dis'}: [${first}, ${second}]`;
            } else {
                for (let i = 0; i < count; i++) {
                    const roll = Math.floor(Math.random() * sides) + 1;
                    rolls.push(roll);
                    total += roll;
                }
                breakdown = `[${rolls.join(', ')}]`;
            }

            const entry = {
                id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                formula: `${count}d${sides}${modifier ? (modifier > 0 ? '+' : '') + modifier : ''}`,
                description,
                rolls,
                modifier,
                total,
                breakdown,
                timestamp: new Date().toLocaleString()
            };
            addRollToHistory(entry);
        }

        function parseDiceFormula(formulaRaw) {
            const formula = formulaRaw.replace(/\s+/g, '');
            const tokens = formula.match(/[+-]?[^+-]+/g);
            if (!tokens) throw new Error('Invalid formula');

            const details = [];
            let total = 0;
            const individual = [];

            tokens.forEach(token => {
                const sign = token.startsWith('-') ? -1 : 1;
                const cleaned = token.replace(/^[-+]/, '');
                if (cleaned.includes('d')) {
                    const [countStr, sidesStr] = cleaned.split('d');
                    const count = parseInt(countStr || '1', 10);
                    const sides = parseInt(sidesStr, 10);
                    if (isNaN(count) || isNaN(sides)) throw new Error('Invalid dice expression');
                    const rolls = rollDiceNTimes(count, sides);
                    const subtotal = rolls.reduce((a, b) => a + b, 0) * sign;
                    total += subtotal;
                    individual.push({ expression: `${sign === -1 ? '-' : ''}${count}d${sides}`, rolls, subtotal });
                } else {
                    const value = parseInt(cleaned, 10);
                    if (isNaN(value)) throw new Error('Invalid modifier');
                    total += sign * value;
                    individual.push({ expression: `${sign === -1 ? '-' : '+'}${Math.abs(value)}`, rolls: [], subtotal: sign * value });
                }
            });

            return { total, breakdown: individual };
        }

        function rollCustomFormula() {
            const formulaInput = document.getElementById('custom-formula');
            const labelInput = document.getElementById('custom-label');
            const errorEl = document.getElementById('dice-error');
            errorEl.classList.add('hidden');
            errorEl.textContent = '';

            try {
                const formula = formulaInput.value.trim();
                if (!formula) throw new Error('Enter a dice formula');
                const { total, breakdown } = parseDiceFormula(formula);
                const breakdownText = breakdown.map(part => part.rolls.length ? `${part.expression} [${part.rolls.join(', ')}]` : part.expression).join(' ');
                const entry = {
                    id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                    formula,
                    description: labelInput.value.trim(),
                    rolls: breakdown.flatMap(part => part.rolls),
                    modifier: 0,
                    total,
                    breakdown: breakdownText,
                    timestamp: new Date().toLocaleString()
                };
                addRollToHistory(entry);
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            }
        }

        function saveCustomFormula() {
            const formula = document.getElementById('custom-formula').value.trim();
            const label = document.getElementById('custom-label').value.trim();
            if (!formula) {
                alert('Enter a formula before saving.');
                return;
            }
            state.savedRolls.push({
                id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                formula,
                label: label || formula
            });
            saveState();
            renderSavedRolls();
            document.getElementById('custom-formula').value = '';
            document.getElementById('custom-label').value = '';
        }

        function renderSavedRolls() {
            const container = document.getElementById('saved-rolls');
            if (!container) return;
            if (!state.savedRolls.length) {
                container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No saved macros yet. Save a custom roll to add it here.</p>';
                return;
            }
            container.innerHTML = state.savedRolls.map(roll => `
                <div class="border border-gray-200 dark:border-gray-700 rounded p-3">
                    <div class="flex items-center justify-between gap-2 mb-2">
                        <div>
                            <p class="font-semibold">${roll.label}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${roll.formula}</p>
                        </div>
                        <button onclick="deleteSavedRoll('${roll.id}')" class="text-sm text-red-500 hover:text-red-600">Delete</button>
                    </div>
                    <button onclick="rollSavedFormula('${roll.id}')" class="w-full px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Roll</button>
                </div>
            `).join('');
        }

        function rollSavedFormula(id) {
            const roll = state.savedRolls.find(r => r.id === id);
            if (!roll) return;
            const formulaInput = document.getElementById('custom-formula');
            const labelInput = document.getElementById('custom-label');
            formulaInput.value = roll.formula;
            labelInput.value = roll.label;
            rollCustomFormula();
        }

        function deleteSavedRoll(id) {
            state.savedRolls = state.savedRolls.filter(r => r.id !== id);
            saveState();
            renderSavedRolls();
        }

        function clearRollHistory() {
            if (!state.diceHistory.length) return;
            if (!confirm('Clear the dice history?')) return;
            state.diceHistory = [];
            saveState();
            displayRollResults();
        }

        function renderDiceStats() {
            const container = document.getElementById('dice-stats');
            if (!container) return;
            if (!state.diceHistory.length) {
                container.innerHTML = `
                    <div class="bg-gray-50 dark:bg-surface border border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-4 text-sm text-gray-600 dark:text-gray-400">
                        Roll some dice to populate your analytics panel.
                    </div>
                `;
                return;
            }

            const totals = state.diceHistory.map(entry => entry.total || 0);
            const average = (totals.reduce((sum, value) => sum + value, 0) / totals.length).toFixed(1);
            const highest = Math.max(...totals);
            const mostRecent = state.diceHistory[0];
            const mostRecentTotal = mostRecent.total ?? '—';
            const mostRecentFormula = mostRecent.formula || '—';

            const formulaFrequency = state.diceHistory.reduce((acc, entry) => {
                const key = entry.formula || '—';
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});
            const popularFormula = Object.keys(formulaFrequency).sort((a, b) => formulaFrequency[b] - formulaFrequency[a])[0];
            const rolls = state.diceHistory.flatMap(entry => Array.isArray(entry.rolls) ? entry.rolls : []);
            const nat20s = rolls.filter(value => value === 20).length;
            const nat1s = rolls.filter(value => value === 1).length;
            const swing = nat20s - nat1s;

            container.innerHTML = `
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Logged Rolls</div>
                    <div class="text-2xl font-bold">${totals.length}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Last: ${mostRecentTotal} on ${mostRecentFormula}</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Average Result</div>
                    <div class="text-2xl font-bold">${average}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Across ${totals.length} rolls</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">High Water Mark</div>
                    <div class="text-2xl font-bold">${highest}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Most used: ${popularFormula} (${formulaFrequency[popularFormula]}×)</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Critical Moments</div>
                    <div class="text-2xl font-bold">${nat20s} / ${nat1s}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Nat 20s vs 1s (swing: ${swing >= 0 ? '+' : ''}${swing})</div>
                </div>
            `;
        }

        function displayRollResults() {
            const container = document.getElementById('dice-results');
            if (!container) return;
            renderDiceStats();
            if (state.diceHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-12">Roll dice to populate the log.</p>';
                return;
            }
            container.innerHTML = state.diceHistory.map(entry => `
                <div class="dice-result bg-white dark:bg-gray-800 p-4 rounded-lg border-l-4 border-primary">
                    ${entry.description ? `<div class=\"font-semibold mb-1\">${entry.description}</div>` : ''}
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600 dark:text-gray-400">${entry.formula}</div>
                        <div class="text-2xl font-bold text-primary">${entry.total}</div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${entry.breakdown}</div>
                    <div class="text-xs text-gray-400 dark:text-gray-500 mt-1">${entry.timestamp}</div>
                </div>
            `).join('');
        }

        // Combat tracker logic
        document.getElementById('combat-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const name = document.getElementById('combat-name').value.trim();
            if (!name) return;
            const initInput = document.getElementById('combat-init').value;
            const initMod = parseInt(document.getElementById('combat-init-mod').value, 10) || 0;
            const initiative = initInput ? parseInt(initInput, 10) : Math.floor(Math.random() * 20) + 1 + initMod;
            const hp = parseInt(document.getElementById('combat-hp').value, 10) || 0;
            const ac = parseInt(document.getElementById('combat-ac').value, 10) || 10;
            const tags = document.getElementById('combat-tags').value.split(',').map(t => t.trim()).filter(Boolean);
            const notes = document.getElementById('combat-notes').value.trim();
            const type = document.getElementById('combat-type').value;

            const combatant = {
                id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                name,
                initiative,
                hp,
                hpMax: hp,
                ac,
                tags,
                notes,
                type,
                characterId: null
            };

            state.combat.combatants.push(combatant);
            sortInitiative();
            saveState();
            renderCombat();
            event.target.reset();
            document.getElementById('combat-hp').value = 10;
            document.getElementById('combat-ac').value = 10;
            document.getElementById('combat-init-mod').value = 0;
        });

        function renderCombatSummary() {
            const container = document.getElementById('combat-summary');
            if (!container) return;
            const combatants = state.combat.combatants;
            if (!combatants.length) {
                container.innerHTML = `
                    <div class="bg-gray-50 dark:bg-surface border border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-4 text-sm text-gray-600 dark:text-gray-400">
                        Add combatants or pull heroes from your roster to see encounter metrics.
                    </div>
                `;
                return;
            }

            const pcs = combatants.filter(c => c.type === 'pc').length;
            const hostiles = combatants.length - pcs;
            const totalHP = combatants.reduce((sum, c) => sum + (c.hp || 0), 0);
            const bloodied = combatants.filter(c => c.hp > 0 && c.hp <= Math.max(1, Math.floor((c.hpMax || 1) / 2))).length;
            const active = combatants.find(c => c.id === state.combat.activeId) || combatants[0];

            container.innerHTML = `
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Round</div>
                    <div class="text-2xl font-bold">${state.combat.round}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Active: ${active ? active.name : '—'}</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Roster</div>
                    <div class="text-2xl font-bold">${pcs} PCs / ${hostiles} foes</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${combatants.length} combatants total</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Combined HP</div>
                    <div class="text-2xl font-bold">${totalHP}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Live bodies on the field</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Bloodied</div>
                    <div class="text-2xl font-bold">${bloodied}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">At or below half hit points</div>
                </div>
            `;
        }

        function renderCombat() {
            document.getElementById('combat-round').textContent = state.combat.round;
            const container = document.getElementById('combat-list');
            if (!container) return;
            renderCombatSummary();
            if (!state.combat.combatants.length) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-12">No combatants yet. Add a foe or pull a character from your roster.</p>';
                return;
            }

            container.innerHTML = state.combat.combatants.map((c, index) => {
                const isActive = state.combat.activeId ? state.combat.activeId === c.id : index === 0;
                const tags = c.tags && c.tags.length ? c.tags : [];
                return `
                    <div class="bg-gray-50 dark:bg-surface rounded-lg border border-gray-200 dark:border-gray-800 p-4 ${isActive ? 'ring-2 ring-primary' : ''}">
                        <div class="flex flex-col lg:flex-row lg:items-center gap-4">
                            <div class="flex-1 space-y-1">
                                <div class="flex items-center gap-2">
                                    <button onclick="setActiveCombatant('${c.id}')" class="text-2xl ${isActive ? 'text-primary' : 'text-gray-400 hover:text-primary'}">${isActive ? '▶' : '▷'}</button>
                                    <div>
                                        <div class="font-bold text-lg">${c.name}</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">Init ${c.initiative} • AC ${c.ac}</div>
                                    </div>
                                </div>
                                ${tags.length ? `<div class=\"flex flex-wrap gap-1\">${tags.map(tag => `<span class=\"chip bg-primary/10 text-primary\">${tag}</span>`).join('')}</div>` : ''}
                                ${c.notes ? `<div class=\"text-xs text-gray-600 dark:text-gray-400\">${c.notes}</div>` : ''}
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500">HP</div>
                                    <div class="text-xl font-bold ${c.hp <= 0 ? 'text-red-500' : ''}">${c.hp}/${c.hpMax}</div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="adjustCombatantHP('${c.id}', -1)" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">-</button>
                                    <button onclick="adjustCombatantHP('${c.id}', 1)" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">+</button>
                                </div>
                                <button onclick="removeCombatant('${c.id}')" class="text-red-500 hover:text-red-600 text-xl">×</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function sortInitiative() {
            state.combat.combatants.sort((a, b) => b.initiative - a.initiative);
            if (state.combat.combatants.length) {
                state.combat.activeId = state.combat.combatants[0].id;
            }
            saveState();
            renderCombat();
        }

        function setActiveCombatant(id) {
            state.combat.activeId = id;
            saveState();
            renderCombat();
        }

        function adjustCombatantHP(id, amount) {
            const combatant = state.combat.combatants.find(c => c.id === id);
            if (!combatant) return;
            combatant.hp = Math.max(0, Math.min(combatant.hpMax, combatant.hp + amount));
            if (combatant.characterId) {
                const char = state.characters.find(c => c.id === combatant.characterId);
                if (char) {
                    char.hpCurrent = combatant.hp;
                    renderCharacters();
                }
            }
            saveState();
            renderCombat();
        }

        function removeCombatant(id) {
            state.combat.combatants = state.combat.combatants.filter(c => c.id !== id);
            if (state.combat.activeId === id) {
                state.combat.activeId = state.combat.combatants[0]?.id || null;
            }
            saveState();
            renderCombat();
        }

        function clearCombat() {
            if (!state.combat.combatants.length) return;
            if (!confirm('Remove all combatants and reset the round counter?')) return;
            state.combat.combatants = [];
            state.combat.round = 1;
            state.combat.activeId = null;
            saveState();
            renderCombat();
        }

        function updateCombatRound(delta) {
            state.combat.round = Math.max(1, state.combat.round + delta);
            saveState();
            renderCombat();
        }

        function resetCombatRound() {
            state.combat.round = 1;
            saveState();
            renderCombat();
        }

        function advanceCombat(step) {
            if (!state.combat.combatants.length) return;
            const order = state.combat.combatants;
            let index = order.findIndex(c => c.id === state.combat.activeId);
            if (index === -1) index = 0;
            index = (index + step + order.length) % order.length;
            if (step > 0 && index === 0) {
                state.combat.round += 1;
            } else if (step < 0 && index === order.length - 1) {
                state.combat.round = Math.max(1, state.combat.round - 1);
            }
            state.combat.activeId = order[index].id;
            saveState();
            renderCombat();
        }

        // Map room helpers
        function getMarkerColorStyles(colorKey) {
            return mapMarkerColors[colorKey] || mapMarkerColors.primary;
        }

        function markerMatchesSearch(marker, searchTerm) {
            if (!searchTerm) return true;
            const haystack = [marker.label, marker.note, marker.color]
                .map(value => (value || '').toString().toLowerCase())
                .join(' ');
            const x = Number(marker.x);
            const y = Number(marker.y);
            const coordText = `${Number.isFinite(x) ? x.toFixed(1) : (marker.x || '')} ${Number.isFinite(y) ? y.toFixed(1) : (marker.y || '')}`;
            return haystack.includes(searchTerm) || coordText.toLowerCase().includes(searchTerm);
        }

        function handleMapUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (loadEvent) => {
                const dataUrl = loadEvent.target.result;
                const img = new Image();
                img.onload = () => {
                    state.map = {
                        ...state.map,
                        image: dataUrl,
                        imageName: file.name,
                        dimensions: { width: img.width, height: img.height }
                    };
                    pendingMapCoords = null;
                    activeMapMarkerId = null;
                    saveState();
                    renderMap();
                };
                img.src = dataUrl;
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function renderMap() {
            const mapData = state.map || clone(defaultState.map);
            const markers = Array.isArray(mapData.markers) ? mapData.markers : [];
            const searchRaw = uiState.mapMarkerSearch || '';
            const searchTerm = searchRaw.trim().toLowerCase();
            const filteredMarkers = searchTerm ? markers.filter(marker => markerMatchesSearch(marker, searchTerm)) : markers;
            const placeholder = document.getElementById('map-placeholder');
            const inner = document.getElementById('map-inner');
            const image = document.getElementById('map-image');
            const grid = document.getElementById('map-grid');
            const markerLayer = document.getElementById('map-marker-layer');
            const markerList = document.getElementById('map-marker-list');
            const markerCount = document.getElementById('map-marker-count');
            const notesInput = document.getElementById('map-notes');
            const gridSizeDisplay = document.getElementById('map-grid-size-display');
            const zoomDisplay = document.getElementById('map-zoom-display');
            const gridToggle = document.getElementById('map-grid-toggle');
            const gridSizeInput = document.getElementById('map-grid-size');
            const zoomInput = document.getElementById('map-zoom');
            const uploadName = document.getElementById('map-uploaded-name');
            const markerSearchInput = document.getElementById('map-marker-search');
            const markerClearButton = document.getElementById('map-marker-clear-search');

            if (notesInput) notesInput.value = mapData.notes || '';
            if (gridToggle) gridToggle.checked = !!mapData.showGrid;
            if (gridSizeInput) gridSizeInput.value = mapData.gridSize;
            if (zoomInput) zoomInput.value = mapData.zoom;
            if (gridSizeDisplay) gridSizeDisplay.textContent = `${mapData.gridSize} px`;
            if (zoomDisplay) zoomDisplay.textContent = `${mapData.zoom}%`;
            if (uploadName) uploadName.textContent = mapData.imageName ? `Loaded: ${mapData.imageName}` : 'No map loaded.';
            if (markerSearchInput && markerSearchInput.value !== searchRaw) {
                markerSearchInput.value = searchRaw;
            }
            if (markerClearButton) {
                const hasSearch = !!searchTerm;
                markerClearButton.disabled = !hasSearch;
                markerClearButton.classList.toggle('opacity-50', !hasSearch);
                markerClearButton.classList.toggle('cursor-not-allowed', !hasSearch);
                markerClearButton.setAttribute('aria-disabled', String(!hasSearch));
            }

            if (editingMapMarkerId && !markers.some(marker => marker.id === editingMapMarkerId)) {
                setMapMarkerFormCreateMode({ preserveCoords: true });
            }

            if (!mapData.image) {
                if (placeholder) placeholder.style.display = 'flex';
                if (inner) inner.style.display = 'none';
                mapDisplaySize = { width: 0, height: 0 };
                if (markerLayer) markerLayer.innerHTML = '';
            } else {
                let dimensions = mapData.dimensions;
                if (image && mapData.image) {
                    const imageSrcChanged = image.src !== mapData.image;
                    if (imageSrcChanged) {
                        image.onload = () => {
                            if (image.naturalWidth && image.naturalHeight) {
                                const current = state.map.dimensions || {};
                                if (current.width !== image.naturalWidth || current.height !== image.naturalHeight) {
                                    state.map.dimensions = { width: image.naturalWidth, height: image.naturalHeight };
                                    saveState();
                                    renderMap();
                                }
                            }
                        };
                    }
                    image.src = mapData.image;
                }
                if (!dimensions || !dimensions.width || !dimensions.height) {
                    if (image && image.naturalWidth && image.naturalHeight) {
                        dimensions = { width: image.naturalWidth, height: image.naturalHeight };
                    } else {
                        dimensions = { width: 1024, height: 768 };
                    }
                }
                const scale = Math.max(0.1, (mapData.zoom || 100) / 100);
                const displayWidth = Math.max(200, dimensions.width * scale);
                const displayHeight = Math.max(200, dimensions.height * scale);
                if (placeholder) placeholder.style.display = 'none';
                if (inner) {
                    inner.style.display = 'block';
                    inner.style.width = `${displayWidth}px`;
                    inner.style.height = `${displayHeight}px`;
                    const measuredWidth = inner.scrollWidth || inner.offsetWidth;
                    const measuredHeight = inner.scrollHeight || inner.offsetHeight;
                    mapDisplaySize = {
                        width: measuredWidth || displayWidth,
                        height: measuredHeight || displayHeight
                    };
                } else {
                    mapDisplaySize = { width: displayWidth, height: displayHeight };
                }
                if (image) {
                    image.style.width = `${displayWidth}px`;
                    image.style.height = `${displayHeight}px`;
                }
                if (grid) {
                    grid.classList.toggle('hidden', !mapData.showGrid);
                    grid.style.opacity = mapData.showGrid ? '0.5' : '0';
                    grid.style.backgroundSize = `${mapData.gridSize * scale}px ${mapData.gridSize * scale}px`;
                }
                if (markerLayer) {
                    markerLayer.innerHTML = markers.map(marker => {
                        const color = getMarkerColorStyles(marker.color);
                        const isActive = marker.id === activeMapMarkerId;
                        const matches = markerMatchesSearch(marker, searchTerm);
                        const dimClass = searchTerm && !matches ? 'map-marker-dim' : '';
                        const markerX = Number(marker.x) || 0;
                        const markerY = Number(marker.y) || 0;
                        return `
                            <div class="absolute map-marker ${isActive ? 'map-marker-active' : ''} ${dimClass}" data-map-marker="${marker.id}" style="left: ${markerX}%; top: ${markerY}%" onclick="focusMapMarker('${marker.id}')">
                                <span class="map-marker-label" style="background:${color.background};color:${color.text};">${escapeHtml(marker.label)}</span>
                            </div>
                        `;
                    }).join('');
                }
            }

            if (markerList) {
                if (!markers.length) {
                    markerList.innerHTML = '<p class="text-xs text-gray-500">No markers yet.</p>';
                } else if (!filteredMarkers.length) {
                    markerList.innerHTML = '<p class="text-xs text-gray-500">No markers match the current search.</p>';
                } else {
                    markerList.innerHTML = filteredMarkers.map(marker => {
                        const isActive = marker.id === activeMapMarkerId;
                        const markerX = Number(marker.x) || 0;
                        const markerY = Number(marker.y) || 0;
                        const coords = `${markerX.toFixed(1)}%, ${markerY.toFixed(1)}%`;
                        return `
                            <div class="border border-gray-200 dark:border-gray-700 rounded p-3 ${isActive ? 'ring-1 ring-primary/50' : ''}">
                                <div class="flex items-start justify-between gap-2">
                                    <div class="space-y-1">
                                        <p class="font-semibold">${escapeHtml(marker.label)}</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">${coords}</p>
                                        ${marker.note ? `<p class="text-xs text-gray-600 dark:text-gray-400">${escapeHtml(marker.note)}</p>` : ''}
                                    </div>
                                    <div class="flex flex-col gap-1 text-xs items-end">
                                        <button onclick="focusMapMarker('${marker.id}')" class="px-2 py-1 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">Focus</button>
                                        <button onclick="beginEditMapMarker('${marker.id}')" class="px-2 py-1 border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition">Edit</button>
                                        <button onclick="deleteMapMarker('${marker.id}')" class="px-2 py-1 text-red-500 hover:text-red-600">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            if (markerCount) {
                const total = markers.length;
                const visible = filteredMarkers.length;
                markerCount.textContent = total === visible ? `${total}` : `${visible} of ${total}`;
            }

            updateMapCoordinateDisplay();
        }

        function updateMapCoordinateDisplay() {
            const display = document.getElementById('map-coordinates-display');
            const hint = document.getElementById('map-coordinate-hint');
            const activeMarker = state.map.markers?.find(marker => marker.id === activeMapMarkerId);
            if (hint) {
                hint.textContent = activeMarker ? `Focused marker: ${activeMarker.label} (${activeMarker.x.toFixed(1)}%, ${activeMarker.y.toFixed(1)}%)` : 'No marker selected.';
            }
            if (!display) return;
            if (pendingMapCoords && Number.isFinite(pendingMapCoords.x) && Number.isFinite(pendingMapCoords.y)) {
                display.textContent = `Next marker: ${pendingMapCoords.x.toFixed(1)}%, ${pendingMapCoords.y.toFixed(1)}%`;
            } else {
                display.textContent = 'Click the map to seed coordinates.';
            }
        }

        function updateManualMarkerCoordinates() {
            const xInput = document.getElementById('map-marker-x');
            const yInput = document.getElementById('map-marker-y');
            if (!xInput || !yInput) return;
            const x = parseFloat(xInput.value);
            const y = parseFloat(yInput.value);
            if (Number.isFinite(x) && Number.isFinite(y)) {
                pendingMapCoords = { x: Math.max(0, Math.min(100, x)), y: Math.max(0, Math.min(100, y)) };
            } else {
                pendingMapCoords = null;
            }
            updateMapCoordinateDisplay();
        }

        function handleMapClick(event) {
            if (!state.map.image) return;
            const inner = document.getElementById('map-inner');
            if (!inner) return;
            const rect = inner.getBoundingClientRect();
            if (!rect.width || !rect.height) return;
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;
            pendingMapCoords = {
                x: Math.max(0, Math.min(100, x)),
                y: Math.max(0, Math.min(100, y))
            };
            const xInput = document.getElementById('map-marker-x');
            const yInput = document.getElementById('map-marker-y');
            if (xInput) xInput.value = pendingMapCoords.x.toFixed(1);
            if (yInput) yInput.value = pendingMapCoords.y.toFixed(1);
            updateMapCoordinateDisplay();
        }

        function submitMapMarker(event) {
            event.preventDefault();
            if (!state.map.image) {
                alert('Upload a map image before dropping markers.');
                return false;
            }
            const form = event.target;
            const mode = form.dataset.mode || 'create';
            const editingId = form.dataset.editingId;
            const labelInput = document.getElementById('map-marker-label');
            const noteInput = document.getElementById('map-marker-note');
            const xInput = document.getElementById('map-marker-x');
            const yInput = document.getElementById('map-marker-y');
            const colorInput = document.getElementById('map-marker-color');
            const label = labelInput?.value.trim();
            const note = noteInput?.value.trim();
            const x = parseFloat(xInput?.value);
            const y = parseFloat(yInput?.value);
            if (!label) {
                alert('Marker needs a label.');
                return false;
            }
            if (!Number.isFinite(x) || !Number.isFinite(y)) {
                alert('Set coordinates for the marker.');
                return false;
            }
            const normalizedX = Math.max(0, Math.min(100, Number(x.toFixed(1))));
            const normalizedY = Math.max(0, Math.min(100, Number(y.toFixed(1))));
            const color = colorInput?.value || 'primary';

            if (mode === 'edit' && editingId) {
                const index = state.map.markers.findIndex(marker => marker.id === editingId);
                if (index === -1) {
                    alert('The marker you were editing no longer exists. A new marker will be created instead.');
                    const newMarker = {
                        id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                        label,
                        note,
                        x: normalizedX,
                        y: normalizedY,
                        color
                    };
                    state.map.markers.push(newMarker);
                    activeMapMarkerId = newMarker.id;
                } else {
                    state.map.markers[index] = {
                        ...state.map.markers[index],
                        label,
                        note,
                        x: normalizedX,
                        y: normalizedY,
                        color
                    };
                    activeMapMarkerId = editingId;
                }
            } else {
                const marker = {
                    id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                    label,
                    note,
                    x: normalizedX,
                    y: normalizedY,
                    color
                };
                state.map.markers.push(marker);
                activeMapMarkerId = marker.id;
            }
            pendingMapCoords = null;
            saveState();
            setMapMarkerFormCreateMode();
            renderMap();
            return false;
        }

        function deleteMapMarker(id) {
            state.map.markers = state.map.markers.filter(marker => marker.id !== id);
            if (activeMapMarkerId === id) {
                activeMapMarkerId = null;
            }
            if (editingMapMarkerId === id) {
                setMapMarkerFormCreateMode();
            }
            saveState();
            renderMap();
        }

        function focusMapMarker(id) {
            const marker = state.map.markers.find(m => m.id === id);
            if (!marker) return;
            activeMapMarkerId = id;
            if (editingMapMarkerId && editingMapMarkerId !== id) {
                setMapMarkerFormCreateMode({ preserveCoords: true });
            }
            renderMap();
            const scroll = document.getElementById('map-scroll');
            const inner = document.getElementById('map-inner');
            if (!scroll || !inner) return;
            const width = inner.scrollWidth || inner.offsetWidth || mapDisplaySize.width;
            const height = inner.scrollHeight || inner.offsetHeight || mapDisplaySize.height;
            if (!width || !height) return;
            const markerX = Number(marker.x) || 0;
            const markerY = Number(marker.y) || 0;
            const targetLeft = Math.max(0, (markerX / 100) * width - scroll.clientWidth / 2);
            const targetTop = Math.max(0, (markerY / 100) * height - scroll.clientHeight / 2);
            scroll.scrollTo({ left: targetLeft, top: targetTop, behavior: 'smooth' });
            const markerElement = document.querySelector(`[data-map-marker="${id}"]`);
            if (markerElement) {
                markerElement.classList.add('map-marker-active');
            }
        }

        function setMapMarkerFormCreateMode({ preserveCoords = false } = {}) {
            const form = document.getElementById('map-marker-form');
            if (!form) return;
            form.dataset.mode = 'create';
            delete form.dataset.editingId;
            editingMapMarkerId = null;
            const labelInput = document.getElementById('map-marker-label');
            const noteInput = document.getElementById('map-marker-note');
            const xInput = document.getElementById('map-marker-x');
            const yInput = document.getElementById('map-marker-y');
            if (labelInput) labelInput.value = '';
            if (noteInput) noteInput.value = '';
            if (!preserveCoords) {
                pendingMapCoords = null;
                if (xInput) xInput.value = '';
                if (yInput) yInput.value = '';
            }
            const modeHint = document.getElementById('map-marker-mode-hint');
            if (modeHint) {
                modeHint.textContent = 'Drop a new marker anywhere on the map.';
                modeHint.classList.remove('text-amber-500', 'dark:text-amber-300');
                modeHint.classList.add('text-gray-500', 'dark:text-gray-400');
            }
            const cancelButton = document.getElementById('map-marker-cancel-edit');
            if (cancelButton) {
                cancelButton.classList.add('hidden');
            }
            updateMapCoordinateDisplay();
        }

        function setMapMarkerFormEditMode(marker) {
            const form = document.getElementById('map-marker-form');
            if (!form || !marker) return;
            form.dataset.mode = 'edit';
            form.dataset.editingId = marker.id;
            editingMapMarkerId = marker.id;
            activeMapMarkerId = marker.id;
            const labelInput = document.getElementById('map-marker-label');
            const noteInput = document.getElementById('map-marker-note');
            const xInput = document.getElementById('map-marker-x');
            const yInput = document.getElementById('map-marker-y');
            const colorInput = document.getElementById('map-marker-color');
            const xValue = Number(marker.x);
            const yValue = Number(marker.y);
            if (labelInput) {
                labelInput.value = marker.label || '';
                labelInput.focus();
                labelInput.select();
            }
            if (noteInput) noteInput.value = marker.note || '';
            if (xInput) xInput.value = Number.isFinite(xValue) ? xValue.toFixed(1) : '';
            if (yInput) yInput.value = Number.isFinite(yValue) ? yValue.toFixed(1) : '';
            if (colorInput && marker.color) colorInput.value = marker.color;
            if (Number.isFinite(xValue) && Number.isFinite(yValue)) {
                pendingMapCoords = {
                    x: Math.max(0, Math.min(100, xValue)),
                    y: Math.max(0, Math.min(100, yValue))
                };
            } else {
                pendingMapCoords = null;
            }
            const modeHint = document.getElementById('map-marker-mode-hint');
            if (modeHint) {
                modeHint.textContent = 'Editing marker. Update the details and save to apply.';
                modeHint.classList.remove('text-gray-500', 'dark:text-gray-400');
                modeHint.classList.add('text-amber-500', 'dark:text-amber-300');
            }
            const cancelButton = document.getElementById('map-marker-cancel-edit');
            if (cancelButton) {
                cancelButton.classList.remove('hidden');
            }
            updateMapCoordinateDisplay();
            renderMap();
        }

        function beginEditMapMarker(id) {
            const marker = state.map.markers.find(m => m.id === id);
            if (!marker) return;
            setMapMarkerFormEditMode(marker);
        }

        function cancelMapMarkerEdit() {
            setMapMarkerFormCreateMode({ preserveCoords: true });
            renderMap();
        }

        function clearMap() {
            if (!state.map.image && !state.map.markers.length && !state.map.notes) return;
            if (!confirm('Remove the current map image, markers, and notes?')) return;
            state.map = clone(defaultState.map);
            activeMapMarkerId = null;
            pendingMapCoords = null;
            mapDisplaySize = { width: 0, height: 0 };
            editingMapMarkerId = null;
            uiState.mapMarkerSearch = '';
            saveState();
            setMapMarkerFormCreateMode();
            renderMap();
        }

        // DM tools helpers
        function renderDMTools() {
            renderDMEncounters();
            renderDMNotes();
            renderDMTrackers();
            renderDMRandomHistory();
            renderDMAIHelpers();
            updateStopwatchDisplay();
            ensureStopwatchInterval();
        }

        function handleDMEncounterForm(event) {
            event.preventDefault();
            const form = event.target;
            const name = form['encounter-name'].value.trim();
            if (!name) return false;
            const quantity = parseInt(form['encounter-quantity'].value, 10) || 1;
            const threat = form['encounter-threat'].value || 'Moderate';
            const environment = form['encounter-environment'].value.trim();
            const notes = form['encounter-notes'].value.trim();
            state.dm.encounters.unshift({
                id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                name,
                quantity,
                threat,
                environment,
                notes,
                resolved: false,
                createdAt: new Date().toISOString()
            });
            saveState();
            renderDMTools();
            form.reset();
            form['encounter-quantity'].value = 1;
            return false;
        }

        function toggleEncounterStatus(id) {
            const encounter = state.dm.encounters.find(enc => enc.id === id);
            if (!encounter) return;
            encounter.resolved = !encounter.resolved;
            saveState();
            renderDMEncounters();
            renderDMAIHelpers();
        }

        function deleteEncounter(id) {
            state.dm.encounters = state.dm.encounters.filter(enc => enc.id !== id);
            saveState();
            renderDMEncounters();
            renderDMAIHelpers();
        }

        function renderDMEncounters() {
            const list = document.getElementById('dm-encounter-list');
            const count = document.getElementById('dm-encounter-count');
            if (!list) return;
            const searchInput = document.getElementById('dm-encounter-search');
            const clearButton = document.getElementById('dm-encounter-clear-search');
            const encounters = state.dm.encounters || [];
            const searchRaw = uiState.dmEncounterSearch || '';
            const searchTerm = searchRaw.trim().toLowerCase();
            if (searchInput && searchInput.value !== searchRaw) {
                searchInput.value = searchRaw;
            }
            if (clearButton) {
                const hasSearch = !!searchTerm;
                clearButton.disabled = !hasSearch;
                clearButton.classList.toggle('opacity-50', !hasSearch);
                clearButton.classList.toggle('cursor-not-allowed', !hasSearch);
                clearButton.setAttribute('aria-disabled', String(!hasSearch));
            }
            const filtered = searchTerm ? encounters.filter(encounter => {
                const haystack = [
                    encounter.name,
                    encounter.threat,
                    encounter.environment,
                    encounter.notes,
                    encounter.quantity
                ].map(value => (value ?? '').toString().toLowerCase());
                return haystack.some(value => value.includes(searchTerm));
            }) : encounters;
            if (count) {
                const total = encounters.length;
                const visible = filtered.length;
                count.textContent = total === visible ? `${total} prepped` : `${visible} of ${total} prepped`;
            }
            if (!encounters.length) {
                list.innerHTML = '<p class="text-xs text-gray-500">No encounters prepped yet.</p>';
                return;
            }
            if (!filtered.length) {
                list.innerHTML = '<p class="text-xs text-gray-500">No encounters match the current search.</p>';
                return;
            }
            list.innerHTML = filtered.map(encounter => {
                const statusLabel = encounter.resolved ? 'Spent' : 'Ready';
                return `
                    <div class="border border-gray-200 dark:border-gray-700 rounded p-3 ${encounter.resolved ? 'opacity-70' : ''}">
                        <div class="flex items-start justify-between gap-2">
                            <div class="space-y-1">
                                <p class="font-semibold">${escapeHtml(encounter.name)}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${encounter.quantity} creatures • ${escapeHtml(encounter.threat)}${encounter.environment ? ' • ' + escapeHtml(encounter.environment) : ''}</p>
                                ${encounter.notes ? `<p class="text-xs text-gray-600 dark:text-gray-400">${escapeHtml(encounter.notes)}</p>` : ''}
                            </div>
                            <div class="flex flex-col gap-1 text-xs items-end">
                                <button onclick="toggleEncounterStatus('${encounter.id}')" class="px-2 py-1 border border-primary text-primary rounded hover:bg-primary hover:text-white transition">${statusLabel}</button>
                                <button onclick="deleteEncounter('${encounter.id}')" class="px-2 py-1 text-red-500 hover:text-red-600">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function handleDMNoteForm(event) {
            event.preventDefault();
            const input = document.getElementById('dm-note-input');
            if (!input) return false;
            const text = input.value.trim();
            if (!text) return false;
            const spotlight = document.getElementById('dm-note-spotlight')?.checked || false;
            const elapsedAt = getStopwatchElapsed();
            state.dm.sessionNotes.unshift({
                id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                text,
                spotlight,
                timestamp: new Date().toISOString(),
                elapsedAt
            });
            saveState();
            renderDMTools();
            input.value = '';
            const spotlightBox = document.getElementById('dm-note-spotlight');
            if (spotlightBox) spotlightBox.checked = false;
            return false;
        }

        function deleteDMNote(id) {
            state.dm.sessionNotes = state.dm.sessionNotes.filter(note => note.id !== id);
            saveState();
            renderDMNotes();
            renderDMAIHelpers();
        }

        function renderDMNotes() {
            const list = document.getElementById('dm-note-list');
            const count = document.getElementById('dm-note-count');
            if (!list) return;
            const searchInput = document.getElementById('dm-note-search');
            const spotlightFilter = document.getElementById('dm-note-spotlight-filter');
            const notes = state.dm.sessionNotes || [];
            const searchRaw = uiState.dmNoteSearch || '';
            const searchTerm = searchRaw.trim().toLowerCase();
            const spotlightOnly = !!uiState.dmNoteSpotlightOnly;
            if (searchInput && searchInput.value !== searchRaw) {
                searchInput.value = searchRaw;
            }
            if (spotlightFilter) {
                spotlightFilter.checked = spotlightOnly;
            }
            const filtered = notes.filter(note => {
                if (spotlightOnly && !note.spotlight) return false;
                if (!searchTerm) return true;
                return (note.text || '').toLowerCase().includes(searchTerm);
            });
            if (count) {
                const total = notes.length;
                const visible = filtered.length;
                count.textContent = total === visible ? `${total} captured` : `${visible} of ${total} captured`;
            }
            if (!notes.length) {
                list.innerHTML = '<p class="text-xs text-gray-500">No notes logged yet.</p>';
                return;
            }
            if (!filtered.length) {
                list.innerHTML = '<p class="text-xs text-gray-500">No notes match the current filters.</p>';
                return;
            }
            list.innerHTML = filtered.map(note => {
                const timestamp = escapeHtml(formatTimestamp(note.timestamp));
                const previewRaw = (note.text || '').replace(/\s+/g, ' ').trim();
                const previewFallback = previewRaw || 'No details provided.';
                const preview = escapeHtml(previewFallback.length > 160 ? `${previewFallback.slice(0, 157)}…` : previewFallback);
                const markdown = marked.parse(note.text || '');
                const hasElapsed = Number.isFinite(note.elapsedAt);
                const sessionBadge = hasElapsed ? `<span class="px-2 py-0.5 bg-emerald-500/10 text-emerald-500 rounded-full text-[0.65rem] uppercase">T+${formatDuration(note.elapsedAt)}</span>` : '';
                const spotlightBadge = note.spotlight ? '<span class="px-2 py-0.5 bg-primary/10 text-primary rounded-full text-[0.65rem] uppercase">Spotlight</span>' : '';
                return `
                    <div class="dm-log-entry bg-white/60 dark:bg-gray-900/60 border border-gray-200 dark:border-gray-700 rounded p-3 space-y-2">
                        <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>${timestamp}</span>
                            <div class="flex items-center gap-2">
                                ${sessionBadge}
                                ${spotlightBadge}
                                <button onclick="deleteDMNote('${note.id}')" class="text-red-500 hover:text-red-600">Delete</button>
                            </div>
                        </div>
                        <details class="group dm-note-details space-y-2">
                            <summary class="dm-note-summary cursor-pointer text-sm text-gray-700 dark:text-gray-200 flex items-center gap-2">
                                <span class="dm-note-preview flex-1">${preview}</span>
                                <span class="text-xs text-primary flex-shrink-0 group-open:hidden">Expand</span>
                                <span class="text-xs text-primary flex-shrink-0 hidden group-open:inline">Collapse</span>
                            </summary>
                            <div class="prose prose-sm max-w-none dark:prose-invert">${markdown}</div>
                        </details>
                    </div>
                `;
            }).join('');
        }

        function renderDMTrackers() {
            const container = document.getElementById('dm-trackers');
            if (!container) return;
            const trackers = state.dm.trackers || {};
            container.innerHTML = Object.entries(dmTrackerLabels).map(([key, label]) => {
                const value = trackers[key] || 0;
                return `
                    <div class="border border-gray-200 dark:border-gray-700 rounded p-3 space-y-2">
                        <div class="text-xs uppercase text-gray-500">${label}</div>
                        <div class="text-2xl font-bold">${value}</div>
                        <div class="flex gap-2">
                            <button onclick="adjustDMTracker('${key}', -1)" class="flex-1 px-2 py-1 border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition text-sm">-</button>
                            <button onclick="adjustDMTracker('${key}', 1)" class="flex-1 px-2 py-1 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">+</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function adjustDMTracker(key, delta) {
            if (!state.dm.trackers) {
                state.dm.trackers = clone(defaultState.dm.trackers);
            }
            const current = state.dm.trackers[key] || 0;
            state.dm.trackers[key] = Math.max(0, current + delta);
            saveState();
            renderDMTrackers();
            renderDMAIHelpers();
        }

        function renderDMRandomHistory() {
            const container = document.getElementById('dm-random-history');
            if (!container) return;
            const history = state.dm.randomHistory || [];
            if (!history.length) {
                container.innerHTML = '<p class="text-xs text-gray-500">Roll the inspiration engine to populate this log.</p>';
                return;
            }
            const labels = { weather: 'Weather', complication: 'Complication', treasure: 'Treasure Hook', npc: 'NPC Quirk' };
            container.innerHTML = history.map(entry => `
                <div class="dm-log-entry bg-white/60 dark:bg-gray-900/60 border border-gray-200 dark:border-gray-700 rounded p-3 space-y-1">
                    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                        <span>${escapeHtml(labels[entry.type] || 'Prompt')}</span>
                        <span>${escapeHtml(entry.timestamp || '')}</span>
                    </div>
                    <div class="text-sm text-gray-700 dark:text-gray-200">${escapeHtml(entry.result)}</div>
                </div>
            `).join('');
        }

        function gatherDMAIData() {
            const allEncounters = (state.dm.encounters || []).slice();
            const upcomingEncounters = allEncounters.filter(encounter => !encounter.resolved).slice(0, 5);
            const fallbackEncounters = allEncounters.slice(0, 5);
            const encounters = upcomingEncounters.length ? upcomingEncounters : fallbackEncounters;
            const resolvedEncounters = allEncounters.filter(encounter => encounter.resolved).slice(0, 3);
            const notes = state.dm.sessionNotes || [];
            const spotlightNotes = notes.filter(note => note.spotlight).slice(0, 5);
            const recentNotes = notes.slice(0, 5);
            const randomHistory = (state.dm.randomHistory || []).slice(0, 5);
            const trackers = { ...(state.dm.trackers || {}) };
            const stopwatch = state.dm.stopwatch || clone(defaultState.dm.stopwatch);
            return { encounters, spotlightNotes, recentNotes, randomHistory, trackers, stopwatch, resolvedEncounters, allEncounters };
        }

        function summarizeForContext(text, limit = 180) {
            const normalized = (text || '').replace(/\s+/g, ' ').trim();
            if (!normalized) return '';
            return normalized.length > limit ? `${normalized.slice(0, limit - 1)}…` : normalized;
        }

        function buildDMAIContext(data = gatherDMAIData(), settings = getDMAISettings()) {
            const sections = [];
            const toggles = settings?.toggles || defaultDMAISettings.toggles;
            if (toggles.encounters !== false && data.encounters.length) {
                const encounterLines = data.encounters.map(encounter => {
                    const quantity = Number(encounter.quantity) > 1 ? `${encounter.quantity} × ` : '';
                    const name = encounter.name || 'Untitled encounter';
                    const details = [];
                    if (encounter.threat) details.push(`Threat: ${encounter.threat}`);
                    if (encounter.environment) details.push(encounter.environment);
                    const header = `- ${quantity}${name}${details.length ? ` (${details.join(' • ')})` : ''}`;
                    const noteSummary = summarizeForContext(encounter.notes, 160);
                    return noteSummary ? `${header}\n  Notes: ${noteSummary}` : header;
                }).join('\n');
                sections.push(`Encounters prepared:\n${encounterLines}`);
            }

            if (toggles.resolved !== false && (data.resolvedEncounters || []).length) {
                const resolvedLines = data.resolvedEncounters.map(encounter => {
                    const name = encounter.name || 'Resolved encounter';
                    const details = [];
                    if (encounter.threat) details.push(encounter.threat);
                    if (encounter.environment) details.push(encounter.environment);
                    const header = `- ${name}${details.length ? ` (${details.join(' • ')})` : ''}`;
                    const fallout = summarizeForContext(encounter.notes, 150);
                    return fallout ? `${header}\n  Fallout: ${fallout}` : header;
                }).join('\n');
                sections.push(`Recent victories:\n${resolvedLines}`);
            }

            if (toggles.spotlight !== false && data.spotlightNotes.length) {
                const spotlightLines = data.spotlightNotes.map(note => {
                    const summary = summarizeForContext(note.text, 160) || 'No details provided.';
                    const timestamp = formatTimestamp(note.timestamp);
                    const elapsedLabel = Number.isFinite(note.elapsedAt) ? ` · T+${formatDuration(note.elapsedAt)}` : '';
                    return `- ${summary}${timestamp && timestamp !== '—' ? ` (${timestamp}${elapsedLabel})` : ''}`;
                }).join('\n');
                sections.push(`Spotlight moments:\n${spotlightLines}`);
            }

            const additionalNotes = data.recentNotes.filter(note => !note.spotlight).slice(0, 3);
            if (toggles.beats !== false && additionalNotes.length) {
                const noteLines = additionalNotes.map(note => {
                    const summary = summarizeForContext(note.text, 150) || 'No details provided.';
                    const timestamp = formatTimestamp(note.timestamp);
                    return `- ${summary}${timestamp && timestamp !== '—' ? ` (${timestamp})` : ''}`;
                }).join('\n');
                sections.push(`Recent beats:\n${noteLines}`);
            }

            const trackerEntries = Object.entries(dmTrackerLabels).map(([key, label]) => `${label}: ${Number(data.trackers?.[key] || 0)}`);
            if (toggles.trackers !== false && trackerEntries.length) {
                sections.push(`Resource trackers: ${trackerEntries.join(', ')}`);
            }

            if (toggles.inspiration !== false && data.randomHistory.length) {
                const labels = { weather: 'Weather', complication: 'Complication', treasure: 'Treasure', npc: 'NPC' };
                const randomLines = data.randomHistory.map(entry => {
                    const tag = labels[entry.type] || 'Prompt';
                    const summary = summarizeForContext(entry.result, 140) || 'No details logged.';
                    return `- ${tag}: ${summary}`;
                }).join('\n');
                sections.push(`Recent inspiration draws:\n${randomLines}`);
            }

            const stopwatch = data.stopwatch || clone(defaultState.dm.stopwatch);
            const elapsed = getStopwatchElapsed();
            const status = stopwatch.running ? 'running' : elapsed > 0 ? 'paused' : 'idle';
            if (toggles.clock !== false && (elapsed > 0 || stopwatch.running)) {
                sections.push(`Session clock: ${formatDuration(elapsed)} (${status})`);
            }

            return sections.join('\n\n').trim();
        }

        function compileDMAIFullPrompt({ context, settings, promptText } = {}) {
            const activeSettings = settings || getDMAISettings();
            const includeContext = activeSettings?.includeContext !== false;
            const includeStyleGuide = activeSettings?.includeStyleGuide !== false;
            const workingPrompt = (promptText !== undefined ? promptText : (document.getElementById('dm-ai-prompt-output')?.value || '')).trim();
            const contextBlock = context !== undefined ? context : buildDMAIContext(gatherDMAIData(), activeSettings);
            const sections = [];
            const normalizedPrompt = workingPrompt.trim();
            const promptLower = normalizedPrompt.toLowerCase();

            if (normalizedPrompt) {
                sections.push(normalizedPrompt);
            }

            if (includeContext && contextBlock && contextBlock.trim() && !promptLower.includes('context:')) {
                sections.push(`Context:\n${contextBlock}`);
            }

            const styleGuide = includeStyleGuide ? buildAIStyleDirectives(activeSettings) : '';
            if (styleGuide && !promptLower.includes('style guide:')) {
                sections.push(`Style guide:\n${styleGuide}`);
            }

            return sections.join('\n\n').trim();
        }

        function getDMAILaunchUrl(settings = getDMAISettings()) {
            const provider = settings?.provider || defaultDMAISettings.provider;
            if (provider === 'custom') {
                return (settings?.customProviderUrl || '').trim();
            }
            const target = aiProviderTargets[provider] || aiProviderTargets[defaultDMAISettings.provider];
            return target?.url || '';
        }

        let dmAILaunchStatusTimer = null;

        function setDMAILaunchStatus(message = '', tone = 'muted', duration = 0) {
            const status = document.getElementById('dm-ai-launch-status');
            if (!status) return;
            status.textContent = message;
            status.classList.remove('text-green-500', 'text-red-400');
            if (tone === 'success') {
                status.classList.add('text-green-500');
                status.classList.remove('text-red-400');
            } else if (tone === 'error') {
                status.classList.add('text-red-400');
                status.classList.remove('text-green-500');
            }
            if (tone === 'muted') {
                status.classList.remove('text-green-500', 'text-red-400');
            }
            if (dmAILaunchStatusTimer) {
                clearTimeout(dmAILaunchStatusTimer);
                dmAILaunchStatusTimer = null;
            }
            if (message && duration > 0) {
                dmAILaunchStatusTimer = setTimeout(() => {
                    status.textContent = '';
                    status.classList.remove('text-green-500', 'text-red-400');
                    dmAILaunchStatusTimer = null;
                }, duration);
            }
        }

        async function handleDMAILaunch(event) {
            event.preventDefault();
            const launchButton = event.currentTarget instanceof HTMLElement ? event.currentTarget : null;
            const settings = ensureDMAISettings();
            const data = gatherDMAIData();
            const context = buildDMAIContext(data, settings);
            const promptOutput = document.getElementById('dm-ai-prompt-output');
            const promptValue = promptOutput ? promptOutput.value : '';
            const fullPrompt = compileDMAIFullPrompt({ context, settings, promptText: promptValue });
            if (!fullPrompt.trim()) {
                setDMAILaunchStatus('Add a working prompt or prep details before launching.', 'error', 2200);
                return;
            }
            const launchUrl = getDMAILaunchUrl(settings);
            if (!launchUrl) {
                setDMAILaunchStatus('Provide a custom assistant URL before launching.', 'error', 2200);
                return;
            }
            const openedWindow = window.open(launchUrl, '_blank', 'noopener');
            if (!openedWindow) {
                setDMAILaunchStatus('Pop-up blocked—allow pop-ups for this site and try again.', 'error', 3200);
                return;
            }
            if (settings.autoCopyFull !== false) {
                try {
                    const copied = await copyTextToClipboard(fullPrompt, launchButton);
                    if (copied) {
                        setDMAILaunchStatus('Full prompt copied—paste it into your assistant tab.', 'success', 3200);
                    } else {
                        setDMAILaunchStatus('Unable to copy automatically. Copy from the preview instead.', 'error', 3200);
                    }
                } catch (error) {
                    setDMAILaunchStatus('Clipboard permissions blocked—copy from the preview instead.', 'error', 3200);
                }
            } else {
                setDMAILaunchStatus('Prompt ready—copy it from the preview when you arrive.', 'muted', 2800);
            }
            renderDMAIHelpers();
        }

        function ensureDMAISettings() {
            if (!state.dm) {
                state.dm = clone(defaultState.dm);
            }
            const existing = state.dm.aiSettings || {};
            state.dm.aiSettings = {
                ...defaultDMAISettings,
                ...existing,
                toggles: {
                    ...defaultDMAISettings.toggles,
                    ...(existing.toggles || {})
                }
            };
            return state.dm.aiSettings;
        }

        function getDMAISettings() {
            return ensureDMAISettings();
        }

        function syncDMAIControls(settings) {
            document.querySelectorAll('.dm-ai-context-toggle').forEach(toggle => {
                const key = toggle.dataset.aiToggle;
                if (!key) return;
                const value = settings?.toggles?.[key];
                toggle.checked = value !== false;
            });
            const toneSelect = document.getElementById('dm-ai-tone');
            if (toneSelect) {
                const toneValue = settings?.tone || defaultDMAISettings.tone;
                if (Array.from(toneSelect.options).some(option => option.value === toneValue)) {
                    toneSelect.value = toneValue;
                }
            }
            const structureSelect = document.getElementById('dm-ai-structure');
            if (structureSelect) {
                const structureValue = settings?.structure || defaultDMAISettings.structure;
                if (Array.from(structureSelect.options).some(option => option.value === structureValue)) {
                    structureSelect.value = structureValue;
                }
            }
            const lengthSelect = document.getElementById('dm-ai-length');
            if (lengthSelect) {
                const lengthValue = settings?.length || defaultDMAISettings.length;
                if (Array.from(lengthSelect.options).some(option => option.value === lengthValue)) {
                    lengthSelect.value = lengthValue;
                }
            }
        }

        function updateAIChip(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function setButtonAvailability(button, enabled) {
            if (!button) return;
            button.disabled = !enabled;
            button.classList.toggle('opacity-50', !enabled);
            button.classList.toggle('cursor-not-allowed', !enabled);
        }

        function resetCopyButton(button) {
            if (!button) return;
            if (copyFeedbackTimers.has(button)) {
                clearTimeout(copyFeedbackTimers.get(button));
                copyFeedbackTimers.delete(button);
            }
            if (!button.dataset.originalText) {
                button.dataset.originalText = button.textContent;
            } else {
                button.textContent = button.dataset.originalText;
            }
        }

        function renderDMAIHelpers() {
            const data = gatherDMAIData();
            const settings = getDMAISettings();
            const context = buildDMAIContext(data, settings);
            const hasPrepContext = context.trim().length > 0;

            syncDMAIControls(settings);

            const contextField = document.getElementById('dm-ai-context');
            if (contextField) {
                contextField.value = hasPrepContext ? context : '';
                contextField.placeholder = hasPrepContext
                    ? 'Context snapshot ready—copy or tweak before sending to an AI assistant.'
                    : 'Log encounters or spotlight notes to build AI-ready context.';
            }

            const stylePreview = document.getElementById('dm-ai-style-preview');
            if (stylePreview) {
                stylePreview.textContent = describeDMAISettings(settings);
            }

            updateAIChip('dm-ai-encounter-count', (state.dm.encounters || []).length);
            updateAIChip('dm-ai-note-count', (state.dm.sessionNotes || []).length);
            updateAIChip('dm-ai-spotlight-count', (state.dm.sessionNotes || []).filter(note => note.spotlight).length);
            updateAIChip('dm-ai-inspiration-count', (state.dm.randomHistory || []).length);

            const copyContextButton = document.getElementById('dm-ai-copy-context');
            const copyPromptButton = document.getElementById('dm-ai-copy-prompt');
            const copyFullButton = document.getElementById('dm-ai-copy-full');
            const promptOutput = document.getElementById('dm-ai-prompt-output');
            const hasPrompt = !!(promptOutput?.value || '').trim();

            resetCopyButton(copyContextButton);
            resetCopyButton(copyPromptButton);
            resetCopyButton(copyFullButton);

            setButtonAvailability(copyContextButton, hasPrepContext);
            setButtonAvailability(copyPromptButton, hasPrompt);

            if (promptOutput && !hasPrompt) {
                promptOutput.placeholder = hasPrepContext
                    ? 'Press a prompt starter or draft your own request for the AI.'
                    : 'Add prep details above or jot down what you need from the AI.';
            }

            const appendContextButton = document.getElementById('dm-ai-append-context');
            setButtonAvailability(appendContextButton, hasPrepContext);

            const includeContextToggle = document.getElementById('dm-ai-include-context');
            if (includeContextToggle && includeContextToggle.checked !== (settings?.includeContext !== false)) {
                includeContextToggle.checked = settings?.includeContext !== false;
            }

            const includeStyleToggle = document.getElementById('dm-ai-include-style');
            if (includeStyleToggle && includeStyleToggle.checked !== (settings?.includeStyleGuide !== false)) {
                includeStyleToggle.checked = settings?.includeStyleGuide !== false;
            }

            const autoCopyToggle = document.getElementById('dm-ai-auto-copy');
            if (autoCopyToggle && autoCopyToggle.checked !== (settings?.autoCopyFull !== false)) {
                autoCopyToggle.checked = settings?.autoCopyFull !== false;
            }

            const providerSelect = document.getElementById('dm-ai-provider');
            const provider = settings?.provider || defaultDMAISettings.provider;
            if (providerSelect && providerSelect.value !== provider) {
                providerSelect.value = provider;
            }

            const providerUrlWrapper = document.getElementById('dm-ai-provider-url-wrapper');
            const providerUrlInput = document.getElementById('dm-ai-provider-url');
            const requiresCustomUrl = provider === 'custom';
            if (providerUrlWrapper) {
                providerUrlWrapper.classList.toggle('hidden', !requiresCustomUrl);
            }
            if (providerUrlInput) {
                const storedUrl = settings?.customProviderUrl || '';
                if (providerUrlInput.value !== storedUrl) {
                    providerUrlInput.value = storedUrl;
                }
            }

            const trimmedCustomUrl = (settings?.customProviderUrl || '').trim();

            const providerHint = document.getElementById('dm-ai-provider-hint');
            if (providerHint) {
                const target = aiProviderTargets[provider] || aiProviderTargets[defaultDMAISettings.provider];
                providerHint.textContent = requiresCustomUrl && !trimmedCustomUrl
                    ? 'Add the chat URL you want to open when launching.'
                    : (target?.hint || '');
            }

            const promptValue = promptOutput ? promptOutput.value : '';
            const fullPrompt = compileDMAIFullPrompt({ context, settings, promptText: promptValue });
            const hasFullPrompt = fullPrompt.trim().length > 0;
            const hasLaunchTarget = !requiresCustomUrl || !!trimmedCustomUrl;

            const fullPreview = document.getElementById('dm-ai-full-preview');
            if (fullPreview) {
                fullPreview.value = fullPrompt;
                fullPreview.placeholder = hasFullPrompt
                    ? 'Final prompt ready—paste into your assistant or launch directly.'
                    : 'Build a working prompt or context to preview the final AI hand-off.';
            }

            const previewButton = document.getElementById('dm-ai-preview-full');
            setButtonAvailability(previewButton, hasFullPrompt);

            setButtonAvailability(copyFullButton, hasFullPrompt);
            if (copyFullButton) {
                if (hasFullPrompt) {
                    copyFullButton.removeAttribute('title');
                } else {
                    copyFullButton.title = 'Add context or a working prompt to assemble a final request first.';
                }
            }

            const launchButton = document.getElementById('dm-ai-launch');
            setButtonAvailability(launchButton, hasFullPrompt && hasLaunchTarget);
            if (launchButton && hasFullPrompt && !hasLaunchTarget) {
                launchButton.title = 'Add a custom assistant URL before launching.';
            } else if (launchButton) {
                launchButton.removeAttribute('title');
            }

            const hasPrepData = (
                (state.dm.encounters || []).length +
                (state.dm.sessionNotes || []).length +
                (state.dm.randomHistory || []).length +
                Object.values(state.dm.trackers || {}).reduce((sum, value) => sum + Number(value || 0), 0)
            ) > 0;
            const promptButtonsEnabled = hasPrepContext || hasPrepData;
            document.querySelectorAll('[data-ai-prompt]').forEach(button => {
                button.classList.toggle('opacity-60', !promptButtonsEnabled);
                button.setAttribute('aria-disabled', String(!promptButtonsEnabled));
            });
        }

        function buildDMAIPrompt(type) {
            const data = gatherDMAIData();
            const settings = getDMAISettings();
            const context = buildDMAIContext(data, settings);
            const builder = aiPromptTemplates[type];
            if (typeof builder === 'function') {
                return builder({ context, data, settings });
            }
            if (typeof builder === 'string') {
                return builder;
            }
            return context ? `Context:\n${context}` : '';
        }

        function handleDMAIPrompt(type) {
            if (!type) return;
            const promptOutput = document.getElementById('dm-ai-prompt-output');
            if (!promptOutput) return;
            const prompt = buildDMAIPrompt(type);
            if (!prompt) return;
            promptOutput.value = prompt;
            promptOutput.focus();
            if (typeof promptOutput.setSelectionRange === 'function') {
                promptOutput.setSelectionRange(prompt.length, prompt.length);
            }
            renderDMAIHelpers();
        }

        function showCopyFeedback(button, message = 'Copied!', duration = 1500) {
            if (!button) return;
            const original = button.dataset.originalText || button.textContent;
            button.textContent = message;
            if (copyFeedbackTimers.has(button)) {
                clearTimeout(copyFeedbackTimers.get(button));
            }
            const timeout = setTimeout(() => {
                button.textContent = button.dataset.originalText || original;
                copyFeedbackTimers.delete(button);
                renderDMAIHelpers();
            }, duration);
            copyFeedbackTimers.set(button, timeout);
        }

        function fallbackCopy(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.setAttribute('readonly', '');
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (error) {
                success = false;
            }
            document.body.removeChild(textarea);
            if (success) {
                showCopyFeedback(button);
            } else if (button) {
                showCopyFeedback(button, 'Copy failed', 2000);
            }
            return success;
        }

        function copyTextToClipboard(text, button) {
            const value = (text || '').trim();
            if (!value) {
                if (button) {
                    showCopyFeedback(button, 'Nothing to copy', 1200);
                }
                return Promise.resolve(false);
            }
            if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                return navigator.clipboard.writeText(value).then(() => {
                    showCopyFeedback(button);
                    return true;
                }).catch(() => {
                    return fallbackCopy(value, button);
                });
            }
            return Promise.resolve(fallbackCopy(value, button));
        }

        function triggerDMGenerator(type) {
            const options = inspirationTables[type];
            if (!options || !options.length) return;
            const result = options[Math.floor(Math.random() * options.length)];
            state.dm.randomHistory.unshift({
                id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                type,
                result,
                timestamp: new Date().toLocaleTimeString()
            });
            if (state.dm.randomHistory.length > 12) {
                state.dm.randomHistory.pop();
            }
            saveState();
            renderDMRandomHistory();
            renderDMAIHelpers();
        }

        function resetDMTools() {
            if (!confirm('Reset DM tools? This clears encounters, notes, trackers, and the session clock.')) return;
            state.dm = clone(defaultState.dm);
            uiState.dmEncounterSearch = '';
            uiState.dmNoteSearch = '';
            uiState.dmNoteSpotlightOnly = false;
            saveState();
            renderDMTools();
        }

        function getStopwatchElapsed() {
            const stopwatch = state?.dm?.stopwatch || clone(defaultState.dm.stopwatch);
            if (stopwatch.running && stopwatch.startedAt) {
                const diff = Date.now() - stopwatch.startedAt;
                if (!Number.isNaN(diff) && diff >= 0) {
                    return diff;
                }
            }
            return stopwatch.elapsed || 0;
        }

        function formatDuration(milliseconds) {
            const totalSeconds = Math.max(0, Math.floor((milliseconds || 0) / 1000));
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds].map(value => String(value).padStart(2, '0')).join(':');
        }

        function updateStopwatchDisplay() {
            const display = document.getElementById('dm-stopwatch-display');
            const status = document.getElementById('dm-stopwatch-status');
            if (!display || !status) return;
            const stopwatch = state.dm.stopwatch || clone(defaultState.dm.stopwatch);
            let elapsed = stopwatch.elapsed || 0;
            if (stopwatch.running && stopwatch.startedAt) {
                const diff = Date.now() - stopwatch.startedAt;
                if (!Number.isNaN(diff) && diff >= 0) {
                    elapsed = diff;
                }
            }
            display.textContent = formatDuration(elapsed);
            status.textContent = stopwatch.running ? 'Running' : elapsed > 0 ? 'Paused' : 'Idle';
        }

        function ensureStopwatchInterval() {
            if (stopwatchInterval) {
                clearInterval(stopwatchInterval);
                stopwatchInterval = null;
            }
            if (state.dm.stopwatch?.running) {
                stopwatchInterval = setInterval(updateStopwatchDisplay, 1000);
            }
        }

        function startStopwatch() {
            const stopwatch = state.dm.stopwatch;
            const now = Date.now();
            const elapsed = stopwatch.running && stopwatch.startedAt ? now - stopwatch.startedAt : stopwatch.elapsed || 0;
            stopwatch.running = true;
            stopwatch.startedAt = now - (stopwatch.elapsed || 0);
            stopwatch.elapsed = elapsed || 0;
            saveState();
            ensureStopwatchInterval();
            updateStopwatchDisplay();
            renderDMAIHelpers();
        }

        function pauseStopwatch() {
            const stopwatch = state.dm.stopwatch;
            if (!stopwatch.running) return;
            const now = Date.now();
            const startedAt = stopwatch.startedAt || now;
            stopwatch.elapsed = Math.max(0, now - startedAt);
            stopwatch.running = false;
            stopwatch.startedAt = null;
            saveState();
            ensureStopwatchInterval();
            updateStopwatchDisplay();
            renderDMAIHelpers();
        }

        function resetStopwatch() {
            state.dm.stopwatch = clone(defaultState.dm.stopwatch);
            saveState();
            ensureStopwatchInterval();
            updateStopwatchDisplay();
            renderDMAIHelpers();
        }

        // Campaign management
        function showCampaignForm(id = null) {
            const form = document.getElementById('campaign-form');
            form.reset();
            document.getElementById('campaign-id').value = id || '';
            document.getElementById('campaign-form-title').textContent = id ? 'Edit Campaign' : 'Create Campaign';
            form.dataset.mode = id ? 'edit' : 'create';
            if (id) {
                const campaign = state.campaigns.find(c => c.id === id);
                if (campaign) {
                    document.getElementById('campaign-name').value = campaign.name;
                    document.getElementById('campaign-judge').value = campaign.judge || '';
                    document.getElementById('campaign-players').value = (campaign.players || []).join(', ');
                    document.getElementById('campaign-description').value = campaign.description || '';
                    document.getElementById('campaign-notes').value = campaign.notes || '';
                }
            }
            openModal('campaign-form-modal');
        }

        function hideCampaignForm() {
            closeModal('campaign-form-modal');
        }

        document.getElementById('campaign-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const mode = event.target.dataset.mode || 'create';
            const id = mode === 'edit' ? document.getElementById('campaign-id').value : `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
            const campaignData = {
                id,
                name: document.getElementById('campaign-name').value.trim(),
                judge: document.getElementById('campaign-judge').value.trim(),
                players: document.getElementById('campaign-players').value.split(',').map(p => p.trim()).filter(Boolean),
                description: document.getElementById('campaign-description').value.trim(),
                notes: document.getElementById('campaign-notes').value.trim()
            };

            if (!campaignData.name) {
                alert('Campaign needs a name.');
                return;
            }

            if (mode === 'edit') {
                const index = state.campaigns.findIndex(c => c.id === id);
                if (index !== -1) {
                    const existing = state.campaigns[index];
                    state.campaigns[index] = { ...existing, ...campaignData, updatedAt: new Date().toISOString() };
                }
            } else {
                const timestamp = new Date().toISOString();
                state.campaigns.push({
                    ...campaignData,
                    adventures: [],
                    sessions: [],
                    createdAt: timestamp,
                    updatedAt: timestamp
                });
            }

            saveState();
            renderCampaigns();
            hideCampaignForm();
            if (activeCampaignDetail === id) {
                showCampaignDetail(id);
            }
        });

        function renderCampaignTimeline(campaigns) {
            const container = document.getElementById('campaign-timeline');
            if (!container) return;
            const entries = [];
            (campaigns || []).forEach(campaign => {
                (campaign.sessions || []).forEach(session => {
                    entries.push({
                        id: session.id,
                        campaign: campaign.name,
                        date: session.date,
                        log: session.log || ''
                    });
                });
            });
            if (!entries.length) {
                container.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">Log sessions to populate the shared timeline.</p>';
                return;
            }
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recent = entries.slice(0, 4);
            container.innerHTML = recent.map(entry => {
                const timestamp = formatTimestamp(entry.date);
                const previewRaw = (entry.log || '').replace(/\n+/g, ' ').trim();
                const preview = escapeHtml(previewRaw.length > 160 ? `${previewRaw.slice(0, 157)}…` : previewRaw);
                return `
                    <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4 space-y-2 text-sm">
                        <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>${timestamp}</span>
                            <span class="font-semibold text-primary">${escapeHtml(entry.campaign || 'Campaign')}</span>
                        </div>
                        <div>${preview || '—'}</div>
                    </div>
                `;
            }).join('');
        }

        function renderCampaignSummary(filtered, all) {
            const container = document.getElementById('campaign-summary');
            if (!container) return;
            if (!all.length) {
                container.innerHTML = `
                    <div class="bg-gray-50 dark:bg-surface border border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-4 text-sm text-gray-600 dark:text-gray-400">
                        Create your first campaign to unlock quick dashboard stats.
                    </div>
                `;
                return;
            }

            if (!filtered.length) {
                container.innerHTML = `
                    <div class="bg-gray-50 dark:bg-surface border border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-4 text-sm text-gray-600 dark:text-gray-400">
                        No campaigns match the current filters. Showing 0 of ${all.length} tracked.
                    </div>
                `;
                return;
            }

            const totalCampaigns = all.length;
            const playerSet = new Set();
            let sessionCount = 0;
            let adventureCount = 0;
            let lastUpdatedIso = null;
            filtered.forEach(campaign => {
                (campaign.players || []).forEach(player => {
                    const trimmed = (player || '').trim();
                    if (trimmed) {
                        playerSet.add(trimmed.toLowerCase());
                    }
                });
                sessionCount += campaign.sessions?.length || 0;
                adventureCount += campaign.adventures?.length || 0;
                const candidate = campaign.updatedAt || campaign.createdAt;
                if (candidate) {
                    if (!lastUpdatedIso) {
                        lastUpdatedIso = candidate;
                    } else {
                        const candidateTime = new Date(candidate).getTime();
                        const existingTime = new Date(lastUpdatedIso).getTime();
                        if (!Number.isNaN(candidateTime) && (Number.isNaN(existingTime) || candidateTime > existingTime)) {
                            lastUpdatedIso = candidate;
                        }
                    }
                }
            });

            container.innerHTML = `
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Campaign Dashboards</div>
                    <div class="text-2xl font-bold">${filtered.length}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">of ${totalCampaigns} total tracked</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Unique Players</div>
                    <div class="text-2xl font-bold">${playerSet.size}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Across filtered campaigns</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Sessions Logged</div>
                    <div class="text-2xl font-bold">${sessionCount}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Adventures cataloged: ${adventureCount}</div>
                </div>
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-4">
                    <div class="text-xs uppercase text-gray-500">Last Updated</div>
                    <div class="text-2xl font-bold">${lastUpdatedIso ? formatTimestamp(lastUpdatedIso) : '—'}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Most recent activity</div>
                </div>
            `;
        }

        function renderCampaigns() {
            const container = document.getElementById('campaign-list');
            if (!container) return;
            const allCampaigns = state.campaigns.slice();
            if (!allCampaigns.length) {
                renderCampaignSummary([], allCampaigns);
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-12">No campaigns tracked. Log your first adventure to begin.</p>';
                return;
            }

            const filtered = allCampaigns
                .filter(campaign => {
                    const search = uiState.campaignSearch;
                    const judgeFilter = uiState.campaignJudge;
                    const haystack = [
                        campaign.name || '',
                        campaign.description || '',
                        campaign.notes || '',
                        (campaign.players || []).join(' ')
                    ].join(' ').toLowerCase();
                    const matchesSearch = !search || haystack.includes(search);
                    const matchesJudge = !judgeFilter || (campaign.judge || '').toLowerCase().includes(judgeFilter);
                    return matchesSearch && matchesJudge;
                })
                .sort((a, b) => {
                    switch (uiState.campaignSort) {
                        case 'name':
                            return (a.name || '').localeCompare(b.name || '');
                        case 'sessions':
                            return (b.sessions?.length || 0) - (a.sessions?.length || 0);
                        default: {
                            const aTime = new Date(a.updatedAt || a.createdAt || 0).getTime() || 0;
                            const bTime = new Date(b.updatedAt || b.createdAt || 0).getTime() || 0;
                            return bTime - aTime;
                        }
                    }
                });

            renderCampaignSummary(filtered, allCampaigns);
            renderCampaignTimeline(filtered);

            if (!filtered.length) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-12">No campaigns match your filters. Adjust search terms to continue.</p>';
                return;
            }

            container.innerHTML = filtered.map(campaign => `
                <div class="bg-gray-50 dark:bg-surface border border-gray-200 dark:border-gray-800 rounded-lg p-5 space-y-3">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <h3 class="text-xl font-bold">${campaign.name}</h3>
                            ${campaign.judge ? `<p class=\"text-sm text-gray-600 dark:text-gray-400\">Judge: ${campaign.judge}</p>` : ''}
                            ${campaign.players?.length ? `<p class=\"text-xs text-gray-500 dark:text-gray-400\">Players: ${campaign.players.join(', ')}</p>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showCampaignForm('${campaign.id}')" class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-700">Edit</button>
                            <button onclick="deleteCampaign('${campaign.id}')" class="px-3 py-1 text-sm text-red-500 hover:text-red-600">Delete</button>
                        </div>
                    </div>
                    ${campaign.description ? `<div class=\"text-sm text-gray-700 dark:text-gray-300 line-clamp-3\">${campaign.description}</div>` : ''}
                    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                        <span>${campaign.adventures?.length || 0} adventures • ${campaign.sessions?.length || 0} session logs</span>
                        <span>Updated ${formatTimestamp(campaign.updatedAt || campaign.createdAt)}</span>
                    </div>
                    <button onclick="showCampaignDetail('${campaign.id}')" class="w-full px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Open Dashboard</button>
                </div>
            `).join('');
        }

        function deleteCampaign(id) {
            if (!confirm('Delete this campaign and all of its notes?')) return;
            state.campaigns = state.campaigns.filter(c => c.id !== id);
            saveState();
            renderCampaigns();
            if (activeCampaignDetail === id) {
                hideCampaignDetail();
            }
        }

        function showCampaignDetail(id) {
            const campaign = state.campaigns.find(c => c.id === id);
            if (!campaign) return;
            activeCampaignDetail = id;
            document.getElementById('detail-campaign-name').textContent = campaign.name;
            const description = campaign.description ? marked.parse(campaign.description) : '';
            const notes = campaign.notes ? marked.parse(campaign.notes) : '';
            const adventures = (campaign.adventures || []).map(adventure => `
                <div class="border border-gray-200 dark:border-gray-700 rounded p-3 flex items-start justify-between gap-2">
                    <div>
                        <p class="font-semibold">${adventure.name}</p>
                        ${adventure.summary ? `<p class=\"text-xs text-gray-600 dark:text-gray-400\">${adventure.summary}</p>` : ''}
                    </div>
                    <button onclick="removeAdventure('${campaign.id}', '${adventure.id}')" class="text-red-500 hover:text-red-600 text-sm">Remove</button>
                </div>
            `).join('');
            const sessions = (campaign.sessions || []).sort((a, b) => new Date(b.date) - new Date(a.date)).map(session => `
                <div class="border border-gray-200 dark:border-gray-700 rounded p-3 space-y-2">
                    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                        <span>${new Date(session.date).toLocaleString()}</span>
                        <button onclick="removeSession('${campaign.id}', '${session.id}')" class="text-red-500 hover:text-red-600 text-sm">Delete</button>
                    </div>
                    <div class="prose prose-sm max-w-none dark:prose-invert">${marked.parse(session.log)}</div>
                </div>
            `).join('');
            const detail = `
                <div class="space-y-6 text-sm">
                    ${description ? `<div class=\"prose prose-sm max-w-none dark:prose-invert\">${description}</div>` : ''}
                    ${notes ? `<div><h4 class=\"font-semibold text-base mb-2\">Judge Notes</h4><div class=\"prose prose-sm max-w-none dark:prose-invert\">${notes}</div></div>` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <h4 class="font-semibold text-base">Adventures</h4>
                            <form onsubmit="return addAdventure('${campaign.id}', event)" class="space-y-2">
                                <input type="text" name="adventure-name" placeholder="Adventure name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" required>
                                <textarea name="adventure-summary" rows="2" placeholder="Short summary" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm"></textarea>
                                <button type="submit" class="w-full px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Add Adventure</button>
                            </form>
                            <div class="space-y-2">${adventures || '<p class=\"text-xs text-gray-500 dark:text-gray-400\">No adventures logged yet.</p>'}</div>
                        </div>
                        <div class="space-y-3">
                            <h4 class="font-semibold text-base">Session Log</h4>
                            <form onsubmit="return addSession('${campaign.id}', event)" class="space-y-2">
                                <textarea name="session-log" rows="3" placeholder="What happened this session? Supports Markdown." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm" required></textarea>
                                <button type="submit" class="w-full px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">Add Session Notes</button>
                            </form>
                            <div class="space-y-2">${sessions || '<p class=\"text-xs text-gray-500 dark:text-gray-400\">No session notes yet.</p>'}</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('campaign-detail-content').innerHTML = detail;
            openModal('campaign-detail-modal');
        }

        function hideCampaignDetail() {
            activeCampaignDetail = null;
            closeModal('campaign-detail-modal');
        }

        function markCampaignUpdated(campaign) {
            if (campaign) {
                campaign.updatedAt = new Date().toISOString();
            }
        }

        function addAdventure(campaignId, event) {
            event.preventDefault();
            const campaign = state.campaigns.find(c => c.id === campaignId);
            if (!campaign) return false;
            const name = event.target['adventure-name'].value.trim();
            const summary = event.target['adventure-summary'].value.trim();
            if (!name) return false;
            campaign.adventures = campaign.adventures || [];
            campaign.adventures.push({ id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`, name, summary });
            markCampaignUpdated(campaign);
            saveState();
            renderCampaigns();
            showCampaignDetail(campaignId);
            return false;
        }

        function removeAdventure(campaignId, adventureId) {
            const campaign = state.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            campaign.adventures = (campaign.adventures || []).filter(a => a.id !== adventureId);
            markCampaignUpdated(campaign);
            saveState();
            renderCampaigns();
            showCampaignDetail(campaignId);
        }

        function addSession(campaignId, event) {
            event.preventDefault();
            const campaign = state.campaigns.find(c => c.id === campaignId);
            if (!campaign) return false;
            const log = event.target['session-log'].value.trim();
            if (!log) return false;
            campaign.sessions = campaign.sessions || [];
            campaign.sessions.push({
                id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                date: new Date().toISOString(),
                log
            });
            markCampaignUpdated(campaign);
            saveState();
            renderCampaigns();
            showCampaignDetail(campaignId);
            return false;
        }

        function removeSession(campaignId, sessionId) {
            const campaign = state.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            campaign.sessions = (campaign.sessions || []).filter(s => s.id !== sessionId);
            markCampaignUpdated(campaign);
            saveState();
            renderCampaigns();
            showCampaignDetail(campaignId);
        }

        function setupReferenceTables() {
            referenceTableEntries = Array.from(document.querySelectorAll('[data-table-entry]')).map(entry => ({
                element: entry,
                card: entry.closest('[data-table-card]'),
                text: entry.textContent.toLowerCase()
            }));
            renderReferenceTables();
        }

        function renderReferenceTables() {
            const query = (uiState.tableSearch || '').trim().toLowerCase();
            const cards = Array.from(document.querySelectorAll('[data-table-card]'));
            const emptyState = document.getElementById('table-search-empty');
            let visibleCards = 0;
            cards.forEach(card => {
                const entries = Array.from(card.querySelectorAll('[data-table-entry]'));
                let matches = 0;
                entries.forEach(entry => {
                    const match = !query || entry.textContent.toLowerCase().includes(query);
                    entry.classList.toggle('hidden', !!query && !match);
                    if (match) matches += 1;
                });
                const showCard = !query || matches > 0;
                card.classList.toggle('hidden', !showCard);
                if (showCard) {
                    visibleCards += 1;
                    if (query) {
                        card.classList.add('ring-1', 'ring-primary/30');
                    } else {
                        card.classList.remove('ring-1', 'ring-primary/30');
                    }
                } else {
                    card.classList.remove('ring-1', 'ring-primary/30');
                }
            });
            if (emptyState) {
                emptyState.classList.toggle('hidden', visibleCards > 0 || !query);
            }
        }

        function rollReferenceInspiration() {
            if (!referenceTableEntries.length) return;
            const query = (uiState.tableSearch || '').trim().toLowerCase();
            const pool = referenceTableEntries.filter(entry => {
                if (!entry.card) return false;
                if (entry.card.classList.contains('hidden') && !query) return false;
                if (!query) return true;
                return entry.text.includes(query);
            });
            const candidates = pool.length ? pool : referenceTableEntries;
            const choice = candidates[Math.floor(Math.random() * candidates.length)];
            const panel = document.getElementById('table-random-panel');
            if (!panel || !choice) return;
            const tableName = choice.card?.dataset.tableName || 'Reference';
            panel.classList.remove('hidden');
            panel.innerHTML = `<span class="font-semibold">${tableName}:</span> ${choice.element.textContent.trim()}`;
        }

        function exportState() {
            const data = JSON.stringify(state, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `dcc-tabletop-${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function resetState() {
            if (!confirm('Reset all stored data? This will remove characters, combatants, and campaigns.')) return;
            state = clone(defaultState);
            activeMapMarkerId = null;
            pendingMapCoords = null;
            mapDisplaySize = { width: 0, height: 0 };
            saveState();
            renderCharacters();
            renderCombat();
            renderCampaigns();
            renderSavedRolls();
            displayRollResults();
            renderMap();
            renderDMTools();
            renderReferenceTables();
        }

        document.getElementById('state-import-input').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                const imported = JSON.parse(text);
                state = {
                    ...clone(defaultState),
                    ...imported,
                    characters: Array.isArray(imported.characters) ? imported.characters : [],
                    campaigns: Array.isArray(imported.campaigns) ? imported.campaigns : [],
                    diceHistory: Array.isArray(imported.diceHistory) ? imported.diceHistory : [],
                    savedRolls: Array.isArray(imported.savedRolls) ? imported.savedRolls : [],
                    combat: {
                        ...clone(defaultState.combat),
                        ...(imported.combat || {}),
                        combatants: Array.isArray(imported?.combat?.combatants) ? imported.combat.combatants : []
                    },
                    map: {
                        ...clone(defaultState.map),
                        ...(imported.map || {}),
                        markers: Array.isArray(imported?.map?.markers) ? imported.map.markers : [],
                        dimensions: imported?.map?.dimensions && typeof imported.map.dimensions.width === 'number' ? imported.map.dimensions : null
                    },
                    dm: {
                        ...clone(defaultState.dm),
                        ...(imported.dm || {}),
                        encounters: Array.isArray(imported?.dm?.encounters) ? imported.dm.encounters : [],
                        sessionNotes: Array.isArray(imported?.dm?.sessionNotes) ? imported.dm.sessionNotes : [],
                        randomHistory: Array.isArray(imported?.dm?.randomHistory) ? imported.dm.randomHistory : [],
                        trackers: {
                            ...clone(defaultState.dm.trackers),
                            ...(imported?.dm?.trackers || {})
                        },
                        stopwatch: {
                            ...clone(defaultState.dm.stopwatch),
                            ...(imported?.dm?.stopwatch || {})
                        }
                    }
                };
                activeMapMarkerId = null;
                pendingMapCoords = null;
                mapDisplaySize = { width: 0, height: 0 };
                saveState();
                renderCharacters();
                renderCombat();
                renderCampaigns();
                renderSavedRolls();
                displayRollResults();
                renderMap();
                renderDMTools();
                renderReferenceTables();
            } catch (error) {
                alert('Failed to import data. Make sure the file is a valid export.');
            }
            event.target.value = '';
        });

        function init() {
            setupReferenceTables();
            const initialTab = localStorage.getItem(tabKey) || 'characters';
            switchTab(initialTab);
            renderCharacters();
            renderCombat();
            renderCampaigns();
            renderSavedRolls();
            displayRollResults();
            renderMap();
            renderDMTools();
            renderReferenceTables();
        }

        init();
    </script>
</body>
</html>
